---
title: 'ICU Liberation Sensitivity Analyses: SOI'
author: "Jennifer Thompson, MPH"
date: "8/23/2018"
output:
  html_document:
    theme: journal
    toc: true
    toc_float: true
---

```{r setup, echo = FALSE, results='hide', message=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE, fig.width = 7, fig.height = 5)

library(tidyverse)
library(rms)
library(knitr)
library(JTHelpers)

## Function with my preferred option for summaryM tables
html_sumM <- function(sMobj, ...){
  html(
    sMobj,
    what = "%", npct = "both", prmsd = TRUE,
    digits = 2, long = TRUE, rmarkdown = TRUE,
    ...
  )
}

load("AnalysisData/iculib.Rdata")

## Vector of hex colors from magnifying glass in slide templates
## (via colorcodepicker.com)
magglass_colors <- c("a" = "#E16725",
                     "b" = "#FBA724",
                     "c" = "#698C36",
                     "d" = "#07A7B4",
                     "e" = "#138CBD",
                     "f" = "#293F90",
                     "overall" = "black")

```

One acknowledged limitation of this project is the inability to adjust for
potential confounding of severity of illness in the relationship between ABCDEF Bundle performance and ICU outcomes, due to the variety of SOI measures and data
collection practices at our 60+ study sites. We explore the feasibility and
potential pitfalls of a sensitivity analysis adjusting for severity of illness
among the subset of patients with the APACHE III, our most commonly available measure of SOI.

```{r datamgmt}
## -- Exclude patients <18 years of age ----------------------------------------
young_pts <- subset(demog, age == 0)$id
age_levels <- levels(demog$age_f)
demog <- subset(demog, !(id %in% young_pts) & icu_days > 0)
demog$age_f <- factor(demog$age, labels = age_levels[-1])
demog$comfort_care_icu_days_exp <- with(demog, {
  ifelse(comfort_care_icu_days == 0, NA, comfort_care_icu_days)
}) 

compliance <- subset(compliance, id %in% demog$id)

## Combine months 1-6 (baseline); keep implementation months separate
demog$month_cat <- with(demog, {
  factor(ifelse(month_f %in% paste("Month", 1:6), 1,
                as.numeric(gsub("^Month ", "", month_f)) - 5),
         levels = 1:15,
         labels = c("Baseline", paste("Imp", 1:14)))
})
demog$month_cat_short <- with(demog, {
  factor(ifelse(month_f %in% paste("Month", 1:6), 1,
                as.numeric(gsub("^Month ", "", month_f)) - 5),
         levels = 1:15,
         labels = c("BL", paste0("I", 1:14)))
})

compliance$month_cat <- with(compliance, {
  factor(ifelse(month_f %in% paste("Month", 1:6), 1,
                as.numeric(gsub("^Month ", "", month_f)) - 5),
         levels = 1:15,
         labels = c("Baseline", paste("Imp", 1:14)))
})
compliance$month_cat_short <- with(compliance, {
  factor(ifelse(month_f %in% paste("Month", 1:6), 1,
                as.numeric(gsub("^Month ", "", month_f)) - 5),
         levels = 1:15,
         labels = c("BL", paste0("I", 1:14)))
})

## Add numeric "study day" variable to compliance data set
compliance$study_day <-
  as.numeric(str_extract(compliance$redcap_event_name, "(?<=\\_)[0-9]+(?=\\_)"))

```

## Availability of Severity of Illness Measures

Four primary severity of illness scores could be recorded for a given patient.
The number of patients with each score recorded for the period surrounding ICU
admission, out of our `r format(nrow(demog), big.mark = ",")` patients eligible
for outcomes analysis, is shown below.

```{r soi_available}
soi_scores <- c("apacheii", "apacheiii", "apacheiv", "sofa")
npts <- nrow(demog)

scores_avail <- map_dbl(
  soi_scores, ~ sum(!is.na(demog[, paste0(., "_score")]))
) %>%
  set_names(soi_scores) %>%
  map_chr(~ sprintf("%s (%s%%)", ., round((. / npts) * 100))) %>%
  bind_rows()

kable(
  scores_avail,
  col.names = c("APACHE II", "APACHE III", "APACHE IV", "SOFA"),
  align = "r",
  caption = "Availability of SOI Measures"
)

```

# Comparison of Patients with and without APACHE III

Since the APACHE III is our most commonly available SOI measure, we compare
patients with APACHE III available to those without. If there are major
differences in these populations, performing a traditional sensitivity analysis
may actually bias our results rather than improving that bias.

APACHE III is available for patients at only `r length(unique(subset(demog, !is.na(apacheiii_score))$hosp))` sites (`r round((length(unique(subset(demog, !is.na(apacheiii_score))$hosp)) / length(unique(demog$hosp))) * 100)`%) of all sites).

## Executive Summary of Differences

Patients with APACHE III available at ICU admission are all admitted to teaching
hospitals (vs community) in either mixed medical/surgical or surgical/trauma
units - in other words, patients who are admitted to community hospitals, or to
specialty units like neuro and cardiac ICUs, are essentially not represented in
this subset.

Patients with APACHE III available are more often admitted for sepsis and respiratory problems; they are much more likely to be white and non-Hispanic,
and tend to be a bit younger than patients with no APACHE III available.

On a daily basis, patients with APACHE III available are sedated more often
(using opioids and propofol) and have more days on mechanical ventilation, on
physical restraints, and with coma. This could indicate that they tend to be
more severely ill than patients at sites which did not collect APACHE III. These
patients have more days with recorded delirium and pain, though pain is more
often self-reported compared to patients with no APACHE III. Patients who have
APACHE III available are more likely to experience mechanical ventilation during
their ICU admission, though spend less time on MV than ventilated patients
without APACHE III, and also have slightly longer hospitalizations.

Sites which document APACHE III are less likely to document safety screens for
SATs, SBTs, and mobility (affecting definitions of ABCDEF Bundle compliance,
though not performance), though actual performance of mobility is documented
more often. Family participation in patient care is much less likely for these patients, although families were more likely to be educated on the ABCDEF Bundle.

```{r haves_havenots}
demog$has_apacheiii <- factor(
  as.numeric(!is.na(demog$apacheiii_score)),
  levels = 0:1,
  labels = c("No APACHE III", "Has APACHE III")
)
compliance$has_apacheiii <- factor(
  as.numeric(compliance$id %in% subset(demog, !is.na(apacheiii_score))$id),
  levels = 0:1,
  labels = c("No APACHE III", "Has APACHE III")
)

logmods_outcomes <- c("delirium_icu", "coma_icu", "sigpain_icu", "on_mv_icu_f")
logmods_covars_base <- c("age_cat_mod", "sex_f", "race_cat_mod", "hisp_cat_mod",
                         "bmi", "mob_preadmit", "home_preadmit", # "hosp_type",
                         "primary_admit", "icu_type_comb", "apacheiii_score")
logmods_covars_daily <- c("comfort_care_icu", "rcvd_benzo_icu",
                          "rcvd_opioid_icu", "rcvd_propofol_icu",
                          "rcvd_dex_icu", "rcvd_antipsyc_icu", "on_mv_icu_f",
                          "coma_icu")
logmods_exposures <- c("comp_yn_f", "perf_yn_f", "comp_prop", "perf_prop")

## Add variable labels for clarity
demog_desc <- demog
comp_desc <- compliance

label(demog_desc$hosp_f) <- "Study site"
label(demog_desc$hosp_type) <- "Hospital type"
label(demog_desc$month_cat) <- "Time period"
label(demog_desc$age_f) <- "Age category"
label(demog_desc$sex_f) <- "Sex"
label(demog_desc$race_cat) <- "Race"
label(demog_desc$hisp_cat) <- "Hispanic"
label(demog_desc$bmi) <- "BMI"
label(demog_desc$home_preadmit) <- "Residence pre-admission"
label(demog_desc$mob_preadmit) <- "Mobility pre-admission"
label(demog_desc$primary_admit) <- "Primary admission diagnosis"
label(demog_desc$icu_type_comb) <- "ICU type"
label(demog_desc$any_soi) <- "Any severity of illness score available"
label(demog_desc$apacheii_avail) <- "APACHE II available"
label(demog_desc$apacheii_score) <- "APACHE II score"
label(demog_desc$apacheiii_avail) <- "APACHE III available"
label(demog_desc$apacheiii_score) <- "APACHE III score"
label(demog_desc$apacheiv_avail) <- "APACHE IV available"
label(demog_desc$apacheiv_score) <- "APACHE IV score"
label(demog_desc$sofa_avail) <- "SOFA available"
label(demog_desc$sofa_score) <- "SOFA score"
label(demog_desc$othersoi_avail) <- "Other SOI available"
label(demog_desc$ever_invas_mv) <- "Ever on invasive MV"
label(demog_desc$hrs_invas_mv) <- "Hours on invasive MV"
label(demog_desc$ever_noninvas_mv) <- "Ever on noninvasive MV"
label(demog_desc$hrs_noninvas_mv) <- "Hours on noninvasive MV"
label(demog_desc$icu_los) <- "ICU length of stay"
label(demog_desc$icu_days) <- "Days all 24h in ICU"
label(demog_desc$ever_readmit_icu) <- "Ever readmitted to ICU"
label(demog_desc$had_painasmt_icu_days) <-
  "Days in ICU with >=1 pain assessment with validated tool"
label(demog_desc$sigpain_icu_days) <- "Days in ICU with significant pain"
label(demog_desc$on_sedation_icu_days) <-
  "Days in ICU on continuous/intermittent sedation"
label(demog_desc$had_satscreen_icu_days) <- "Days in ICU with SAT safety screen"
label(demog_desc$had_sat_icu_days) <- "Days in ICU with SAT performed"
label(demog_desc$on_mv_icu_days) <- "Days in ICU on MV"
label(demog_desc$had_sbtscreen_icu_days) <- "Days in ICU with SBT safety screen"
label(demog_desc$had_sbt_icu_days) <- "Days in ICU with SBT performed"
label(demog_desc$sat_sbt_icu_days) <- "Days in ICU with SAT prior to SBT"
label(demog_desc$rcvd_benzo_icu_days) <- "Days received benzodiazepines in ICU"
label(demog_desc$rcvd_opioid_icu_days) <- "Days received opioids in ICU"
label(demog_desc$rcvd_propofol_icu_days) <- "Days received propofol in ICU"
label(demog_desc$rcvd_dex_icu_days) <- "Days received dex in ICU"
label(demog_desc$rcvd_antipsyc_icu_days) <- "Days received antipsychotics in ICU"
label(demog_desc$had_sedasmt_icu_days) <-
  "Days in ICU with >=1 sedation assessment"
label(demog_desc$had_delasmt_icu_days) <-
  "Days in ICU with >=1 delirium assessment"
label(demog_desc$delirium_icu_days) <- "Days in ICU with delirium"
label(demog_desc$had_mobscreen_icu_days) <-
  "Days in ICU with mobility safety screen"
label(demog_desc$had_mobility_icu_days) <-
  "Days in ICU with mobility performed (> active ROM)"
label(demog_desc$family_present_icu_days) <- "Days in ICU with family present"
label(demog_desc$family_invited_icu_days) <-
  "Days in ICU family invited to participate in rounds/conference"
label(demog_desc$family_rounds_icu_days) <-
  "Days in ICU family participated in rounds"
label(demog_desc$family_care_icu_days) <-
  "Days in ICU family participated in plan of care/ABCDEF care"
label(demog_desc$family_edu_icu_days) <-
  "Days in ICU family educated on ABCDEF bundle/related topics"
label(demog_desc$hosp_los) <- "Hospital length of stay"
label(demog_desc$home_posticu) <- "Residence post-ICU"
label(demog_desc$mob_posticu) <- "Mobility post-ICU"
label(demog_desc$dc_status_f) <- "Discharge status"
label(demog_desc$dc_loc_f) <- "Discharge location"
label(demog_desc$comp_a_days) <- "ICU days Element A compliant"
label(demog_desc$comp_a_prop) <- "Proportion of ICU days Element A compliant"
label(demog_desc$perf_a_days) <- "ICU days Element A performed"
label(demog_desc$perf_a_prop) <- "Proportion of ICU days Element A performed"
label(demog_desc$comp_b_sat_days) <- "ICU days Element B - SAT compliant"
label(demog_desc$comp_b_sat_prop) <-
  "Proportion of sedation ICU days Element B - SAT compliant"
label(demog_desc$perf_b_sat_days) <- "ICU days Element B - SAT performed"
label(demog_desc$perf_b_sat_prop) <-
  "Proportion of sedation ICU days Element B - SAT performed"
label(demog_desc$comp_b_sbt_days) <- "ICU days Element B - SBT compliant"
label(demog_desc$comp_b_sbt_prop) <-
  "Proportion of MV ICU days Element B - SBT compliant"
label(demog_desc$perf_b_sbt_days) <- "ICU days Element B - SBT performed"
label(demog_desc$perf_b_sbt_prop) <-
  "Proportion of MV ICU days Element B - SBT performed"
label(demog_desc$comp_c_days) <- "ICU days Element C compliant"
label(demog_desc$comp_c_prop) <- "Proportion of ICU days Element C compliant"
label(demog_desc$perf_c_days) <- "ICU days Element C performed"
label(demog_desc$perf_c_prop) <- "Proportion of ICU days Element C performed"
label(demog_desc$comp_d_days) <- "ICU days Element D compliant"
label(demog_desc$comp_d_prop) <- "Proportion of ICU days Element D compliant"
label(demog_desc$perf_d_days) <- "ICU days Element D performed"
label(demog_desc$perf_d_prop) <- "Proportion of ICU days Element D performed"
label(demog_desc$comp_e_days) <- "ICU days Element E compliant"
label(demog_desc$comp_e_prop) <- "Proportion of ICU days Element E compliant"
label(demog_desc$perf_e_days) <- "ICU days Element E performed"
label(demog_desc$perf_e_prop) <- "Proportion of ICU days Element E performed"
label(demog_desc$comp_f_days) <- "ICU days Element F compliant"
label(demog_desc$comp_f_prop) <-
  "Proportion of family ICU days Element F compliant"
label(demog_desc$perf_f_days) <- "ICU days Element F performed"
label(demog_desc$perf_f_prop) <-
  "Proportion of family ICU days Element F performed"
label(demog_desc$comp_yn_days) <- "ICU days entire bundle compliant"
label(demog_desc$comp_yn_prop) <-
  "Proportion of ICU days entire bundle compliant"
label(demog_desc$perf_yn_days) <- "ICU days entire bundle performed"
label(demog_desc$perf_yn_prop) <-
  "Proportion of ICU days entire bundle performed"
label(demog_desc$comfort_care_icu_ever) <- "Ever on comfort care in ICU"
label(demog_desc$comfort_care_icu_days) <- "Days on comfort care in ICU"
label(demog_desc$comfort_care_icu_days_exp) <-
  "Days on comfort care in ICU among those who received it"

## Only describe days fully in ICU
comp_desc <- compliance %>% filter(icu_day)

label(comp_desc$pain_asmts_icu) <-
  "Number of pain assessments with validated tool"
label(comp_desc$had_painasmt_icu) <-
  "Had >=1 pain assessment with validated tool"
label(comp_desc$comp_a_f) <- "Element A: compliant"
label(comp_desc$perf_a_f) <- "Element A: performed"
label(comp_desc$sigpain_verbal_icu) <- "Significant pain self-reported"
label(comp_desc$sigpain_valid_icu) <- "Significant pain using validated tool"
label(comp_desc$sigpain_icu) <- "Significant pain, either method"

label(comp_desc$on_sedation_icu_f) <- "On continuous/intermittent sedation"
label(comp_desc$had_satscreen_icu) <- "SAT safety screen documented"
label(comp_desc$had_sat_icu) <- "SAT documented"
label(comp_desc$comp_b_sat_f) <- "Element B - SAT: compliant"
label(comp_desc$perf_b_sat_f) <- "Element B - SAT: performed"

label(comp_desc$on_mv_icu_f) <- "On mechanical ventilation"
label(comp_desc$had_sbtscreen_icu) <- "SBT safety screen documented"
label(comp_desc$had_sbt_icu) <- "SBT documented"
label(comp_desc$comp_b_sbt_f) <- "Element B - SBT: compliant"
label(comp_desc$perf_b_sbt_f) <- "Element B - SBT: performed"
label(comp_desc$sat_sbt_icu) <- "SAT performed before SBT"

label(comp_desc$sed_assess_valid_icu) <-
  "Number of sedation assessments with validated tool"
label(comp_desc$had_sedasmt_icu) <-
  "Had >=1 sedation assessment with validated tool"
label(comp_desc$comp_c_f) <- "Element C: compliant"
label(comp_desc$perf_c_f) <- "Element C: performed"
label(comp_desc$rcvd_benzo_icu) <- "Received benzodiazepines"
label(comp_desc$rcvd_opioid_icu) <- "Received opioids"
label(comp_desc$rcvd_propofol_icu) <- "Received propofol"
label(comp_desc$rcvd_dex_icu) <- "Received dexmedetomidine"
label(comp_desc$rcvd_antipsyc_icu) <- "Received antipsychotics (typical/atypical)"

label(comp_desc$del_assess_valid_icu) <-
  "Number of delirium assessments with validated tool"
label(comp_desc$had_delasmt_icu) <-
  "Had >=1 delirium assessment with validated tool"
label(comp_desc$comp_d_f) <- "Element D: compliant"
label(comp_desc$perf_d_f) <- "Element D: performed"
label(comp_desc$delirium_icu) <- "Delirious, per validated tool"
label(comp_desc$coma_icu) <- "Comatose"

label(comp_desc$on_restraints_icu) <- "On physical restraints"
label(comp_desc$had_mobscreen_icu) <- "Mobility safety screen documented"
label(comp_desc$had_mobility_icu) <- "Mobility > active ROM documented"
label(comp_desc$mobilityhighest_icu) <- "Highest level of mobility"
label(comp_desc$comp_e_f) <- "Element E: compliant"
label(comp_desc$perf_e_f) <- "Element E: performed"

label(comp_desc$family_present_icu_f) <- "Family present"
label(comp_desc$family_invited_icu) <-
  "Family invited to participate in rounds/conference"
label(comp_desc$family_rounds_icu) <- "Family participated in rounds"
label(comp_desc$family_care_icu) <-
  "Family participated in plan of care/ABCDEF care"
label(comp_desc$family_edu_icu) <-
  "Family educated on ABCDEF bundle/related topics"
label(comp_desc$comp_f_f) <- "Element F: compliant"
label(comp_desc$perf_f_f) <- "Element F: performed"

label(comp_desc$comfort_care_icu) <- "On comfort care"

label(comp_desc$comp_yn_f) <- "Overall ABCDEF compliance"
label(comp_desc$perf_yn_f) <- "Overall ABCDEF performance"
label(comp_desc$elements_elig) <-
  "Number of ABCDEF elements eligible to be performed/compliant"
label(comp_desc$elements_comp) <- "Number of elements compliant"
label(comp_desc$comp_prop) <- "Proportion of elements compliant"
label(comp_desc$elements_perf) <- "Number of elements performed"
label(comp_desc$perf_prop) <- "Proportion of elements performed"

## We adjust for all of these in models
baseline_char <- summaryM(
  hosp_type + age_f + sex_f + race_cat + hisp_cat + bmi +
    home_preadmit + mob_preadmit + primary_admit + icu_type_comb ~
    has_apacheiii,
  data = demog_desc,
  continuous = 5
)

## Daily characteristics we adjust for
daily_covars_outcomes_exp <- summaryM(
  as.formula(
    paste(
      paste(
        c(logmods_covars_daily, logmods_exposures, logmods_outcomes),
        collapse = " + "
      ),
      "~ has_apacheiii"
    )
  ),
  data = comp_desc,
  continuous = 5
)

inhosp_char <- summaryM(
  ever_invas_mv + hrs_invas_mv + ever_noninvas_mv + hrs_noninvas_mv + icu_los +
    ever_readmit_icu + had_painasmt_icu_days + sigpain_icu_days + comp_a_days +
    comp_a_prop + perf_a_days + perf_a_prop + on_sedation_icu_days +
    had_satscreen_icu_days + had_sat_icu_days + comp_b_sat_days +
    comp_b_sat_prop + perf_b_sat_days + perf_b_sat_prop + on_mv_icu_days +
    had_sbtscreen_icu_days + had_sbt_icu_days + sat_sbt_icu_days +
    comp_b_sbt_days + comp_b_sbt_prop + perf_b_sbt_days + perf_b_sbt_prop +
    had_sedasmt_icu_days + comp_c_days + comp_c_prop + perf_c_days +
    perf_c_prop + rcvd_benzo_icu_days + rcvd_opioid_icu_days +
    rcvd_propofol_icu_days + rcvd_dex_icu_days + rcvd_antipsyc_icu_days +
    had_delasmt_icu_days + delirium_icu_days + comp_d_days + comp_d_prop +
    perf_d_days + perf_d_prop + had_mobscreen_icu_days + had_mobility_icu_days +
    comp_e_days + comp_e_prop + perf_e_days + perf_e_prop +
    family_present_icu_days + family_invited_icu_days + family_rounds_icu_days +
    family_care_icu_days + family_edu_icu_days + comp_f_days + comp_f_prop +
    perf_f_days + perf_f_prop + comp_yn_days + comp_yn_prop + perf_yn_days +
    perf_yn_prop + comfort_care_icu_ever + comfort_care_icu_days_exp +
    hosp_los + home_posticu + mob_posticu + dc_status_f +
    dc_loc_f ~ has_apacheiii,
  data = demog_desc,
  continuous = 5
)

daily_char <- summaryM(
  pain_asmts_icu + had_painasmt_icu + comp_a_f + perf_a_f + sigpain_verbal_icu +
    sigpain_valid_icu + on_sedation_icu_f + had_satscreen_icu + had_sat_icu +
    comp_b_sat_f + perf_b_sat_f + had_sbtscreen_icu + had_sbt_icu +
    comp_b_sbt_f + perf_b_sbt_f + sat_sbt_icu + sed_assess_valid_icu +
    had_sedasmt_icu + comp_c_f + perf_c_f + del_assess_valid_icu +
    had_delasmt_icu + comp_d_f + perf_d_f + on_restraints_icu +
    had_mobscreen_icu + had_mobility_icu + mobilityhighest_icu + comp_e_f +
    perf_e_f + family_present_icu_f + family_invited_icu + family_rounds_icu +
    family_care_icu + family_edu_icu + comp_f_f + perf_f_f + elements_elig +
    elements_comp + elements_perf ~ has_apacheiii,
  data = comp_desc,
  continuous = 5
)

```

## Baseline Characteristics

Our primary models adjust for all of these baseline factors.

```{r baseline}
html_sumM(baseline_char, caption = "Baseline Characteristics")

```

## Daily Covariates, Exposures, and Outcomes

These factors are included in daily/time-varying models as covariates,
exposures, or outcomes.

```{r daily_models}
html_sumM(
  daily_covars_outcomes_exp,
  caption = "Daily Characteristics, Accounted for in Models"
)

```

## Additional Patient-Day Characteristics

These factors are **not** directly included in daily/time-varying models as
covariates, exposures, or outcomes, although some of these factors are
incorporated into definitions of Bundle compliance and performance.

```{r daily_notmodels}
html_sumM(
  daily_char,
  caption = "Daily Characteristics, *Not* Accounted for in Models"
)

```

## Hospitalization Characteristics

```{r inhosp}
html_sumM(inhosp_char, caption = "Hospitalization Characteristics")

```

# Distribution of SOI Scores

```{r distributions}
soi_long <- demog %>%
  dplyr::select(id, apacheii_score, apacheiii_score, apacheiv_score) %>%
  gather(key = soi_type, value = soi_score, -id) %>%
  filter(!is.na(soi_score))

ggplot(data = soi_long) +
  aes(x = soi_score) +
  facet_wrap(~ soi_type, ncol = 1, scales = "free_x") +
  geom_histogram()

```

# Sensitivity Analysis Adjusting for APACHE III

Despite some differences between patients with and without APACHE III scores
available, these two groups are considered clinically similar enough to make a
set of sensitivity analyses adjusting for this score valuable. We present below
models for ABCDEF performance (yes/no and "dose") which incorporate the same
methodology* and covariates as our original analyses, and additionally adjust for
APACHE III, using only the patients with that score available.

> *Two exceptions:*

> 1. In the original analyses, we used Huber-White sandwich estimation to account for differences between sites. Here, we have too few sites and too much overlap between individual hospital and our covariate of ICU type, so we only adjust for ICU type and do not cluster by site. In addition, the few cardiac/surgical patients with an APACHE III score are combined with mixed medical/surgical patients.

> 1. In the original analyses, we adjusted for hospital type (community vs teaching). Because so few patients with APACHE III available were hospitalized
at community hospitals, we are unable to adjust for this in our sensitivity
analysis.

These analyses should be interpreted with caution, as they represent a very
small subgroup of our entire cohort (`r round(mean(!is.na(demog$apacheiii_score))*100)`% for time-to-event outcomes,
with even fewer included in daily outcome models), but may be helpful (alongside
the tipping point analysis done for the original paper) in determining how
robust our original estimates are in the presence of confounding by severity of
illness.

```{r model_datamgmt}
## -- IDs of patients to include (those with APACHE III) -----------------------
apacheiii_pts <- subset(demog, !is.na(apacheiii_score))$id

## -- Create data set for all "vs XXX the following day" models ----------------
## Vector of variables for which we'll need "xxx tomorrow" versions
lead_vars <- c("icu_day", "on_mv_icu_f", "coma_icu", "on_restraints_icu",
               "sigpain_icu", "delirium_icu")

## Vector of baseline covariates
base_vars <- c("age_cat_mod", "sex_f", "race_cat_mod", "hisp_cat_mod", "bmi",
               "mob_preadmit", "primary_admit", "home_preadmit",
               "icu_type_comb", "hosp_type", "hosp_f", "apacheiii_score")

df_logmods <- compliance %>%
  filter(id %in% apacheiii_pts) %>%
  dplyr::select(id, icu_day, redcap_event_name_f,
                comfort_care_icu, on_sedation_icu_f, rcvd_benzo_icu,
                rcvd_opioid_icu, rcvd_propofol_icu, rcvd_dex_icu,
                rcvd_antipsyc_icu,
                on_mv_icu_f, coma_icu,
                on_restraints_icu, sigpain_icu, delirium_icu,
                comp_yn_f, perf_yn_f, comp_prop, perf_prop) %>%
  ## Create "tomorrow" variables
  group_by(id) %>%
  mutate_at(vars(one_of(lead_vars)), funs(tmw = lead)) %>%
  ungroup() %>%
  ## Filter - these models will only use days when patients were in the ICU
  ## both "today" and "tomorrow"
  filter(icu_day & icu_day_tmw) %>%
  ## Merge on baseline covariates
  right_join(dplyr::select(demog, id, one_of(base_vars)), ., by = "id") %>%
  ## Collapse 1) site and 2) ICU type due to small N (can't cluster otherwise)
  mutate(
    icu_type_comb = fct_collapse(
      icu_type_comb,
      "Surgical/trauma/cardiac" = c("Surgical/trauma", "Cardiac/surgical")
    ),
    hosp_f = fct_lump(hosp_f, prop = 0.20, other_level = "Other sites")
  )

# ## Check a few patients
# ckids <- sample(unique(compliance$id), size = 10)
# print_vars <- map(lead_vars, ~ c(., paste0(., "_tmw"))) %>% flatten_chr
# print(subset(df_logmods, id %in% ckids)[,c("id", "redcap_event_name_f",
#                                            print_vars)],
#       width = Inf)

npts_total <- length(unique(demog$id))
npts_apacheiii <- length(apacheiii_pts)
npts_logmods <- length(unique(df_logmods$id))
pctpts_logmods_total <- (npts_logmods / npts_total) * 100
pctpts_logmods_apacheiii <- (npts_logmods / npts_apacheiii) * 100
ndays_logmods <- nrow(df_logmods)

# ## Common sense check for % patients included in these models
# ck_icudays <- compliance %>%
#   group_by(id) %>%
#   summarise(n_icu_days = sum(icu_day, na.rm = TRUE)) %>%
#   ungroup()

```

```{r logmod_prep, results = "hide"}
## -- Create regex for replacing linear continuous variables with rcs() --------
rcs_vars <- c(
  "icu_los_edit", "rcvd_benzo_icu_prop", "rcvd_opioid_icu_prop",
  "rcvd_propofol_icu_prop", "rcvd_dex_icu_prop", "rcvd_antipsyc_icu_prop",
  "comfort_care_icu_prop", "on_mv_icu_prop", "coma_icu_prop", "bmi",
  "comp_prop", "perf_prop", "comp_elem_prop", "perf_elem_prop", "comp_yn_prop",
  "perf_yn_prop", "apacheiii_score"
)

rcs_regex <- paste0(
  "(^",
  paste(gsub("_", "\\_", rcs_vars, fixed = TRUE), collapse = "|"),
  "$)"
)

## Set datadist. We must always set datadist. Set it to the mother dataset.
dd_logmods <- datadist(df_logmods)
options(datadist = "dd_logmods")

## -- Function to fit logistic regression model --------------------------------
fit_daily_lrm <- function(
  outcome = c("on_mv_icu_f_tmw", "coma_icu_tmw",
              "delirium_icu_tmw", "on_restraints_icu_tmw",
              "ever_readmit_icu"),
  exposure = c("comp_yn_f", "comp_prop", "perf_yn_f", "perf_prop",
               "comp_yn_prop", "comp_elem_prop",
               "perf_yn_prop", "perf_elem_prop"),
  covars = c(logmods_covars_base, logmods_covars_daily),
  df = df_logmods
){
  
  ## -- Set model formula ------------------------------------------------------
  ## Add delirium/restraints as a covariate for those outcomes
  if(outcome %in% c("delirium_icu_tmw", "on_restraints_icu_tmw")){
    covars <- c(covars, gsub("_tmw", "", outcome, fixed = TRUE))
  }
  
  ## Add exposure to RHS
  covars <- c(covars, exposure)
  
  ## Make BMI, proportion of compliance/performance nonlinear terms
  covars <- str_replace(covars, rcs_regex, "rcs\\(\\1, 3\\)")
  
  ## Put RHS together
  rhs <- paste(covars, collapse = " + ")
  
  ## Assemble entire formula
  modform <- as.formula(paste(outcome, rhs, sep = " ~ "))
  
  ## -- Fit model using lrm, then adjust SEs using robcov() --------------------
  ## j/k: In original analyses, we clustered by site. Here, we have too few
  ##  sites, and the overlap with "ICU type" is too great, so we don't cluster.
  mod <- lrm(modform, data = df, x = TRUE, y = TRUE) # %>%
    # robcov(cluster = df$hosp_f)
  
  return(mod)
}

## -- Function to extract odds ratios from a given model fit -------------------
get_daily_ors <- function(modobj,
                          exposure = c("comp_yn_f", "comp_prop",
                                       "perf_yn_f", "perf_prop",
                                       "comp_yn_prop", "perf_yn_prop",
                                       "comp_elem_prop", "perf_elem_prop"),
                          df = df_logmods){
  if(exposure == "comp_yn_f"){
    reflevel <- "Noncompliant"
    complevels <- levels(df[,exposure])
  } else if(exposure == "perf_yn_f"){
    reflevel <- "Not performed"
    complevels <- levels(df[,exposure])
  } else{
    reflevel <- 0
    complevels <- as.numeric(
      quantile(
        c(df_logmods$comp_prop, df_logmods$perf_prop),
        probs = seq(0, 1, 0.2),
        na.rm = TRUE
      )
    )
  }
  
  rms_calc_comparisons(
    rmsObj = modobj,
    vname = exposure,
    df = df,
    refVal = reflevel,
    compVals = complevels
  )
}

## -- Function to extract p-value for an exposure from a given model fit -------
get_daily_p <- function(modobj,
                        exposure = c("comp_yn_f", "comp_prop",
                                     "perf_yn_f", "perf_prop",
                                     "comp_yn_prop", "perf_yn_prop",
                                     "comp_elem_prop", "perf_elem_prop")){
  anova(modobj)[exposure, "P"]
}

## -- Function to get ORs/P for a given model fit into tibble ------------------
daily_outexp_ors <- function(modobj, exposure, df = df_logmods){
  ors <- get_daily_ors(modobj = modobj, exposure = exposure, df = df)
  pval <- get_daily_p(modobj = modobj, exposure = exposure)
  ors$pval <- pval
  ors
}

## -- Function to get predicted probs for a continuous exposure into tibble ----
get_daily_probs <- function(modobj,
                            exposure = c("comp_prop", "perf_prop",
                                         "comp_yn_prop", "perf_yn_prop",
                                         "comp_elem_prop", "perf_elem_prop"),
                            df = df_logmods){
  tmp <- eval(
    parse(text = sprintf("Predict(modobj, %s = NA, fun = plogis)", exposure))
  ) %>%
    as_tibble() %>%
    dplyr::select(matches(exposure), yhat, lower, upper) %>%
    mutate(exposure = exposure)
  names(tmp) <- gsub(exposure, "prop_done", names(tmp), fixed = TRUE)
  tmp
}

## -- Wrapper function for a specified outcome: --------------------------------
## 1. Fit logistic model (returned as "modobj")
## 2. Get df of odds ratios + p-value (returned as "ors")
## 3. If continuous, get df of predicted probabilities (returned as "probs")
fit_results_lrm <- function(outcome = c("on_mv_icu_f_tmw",
                                        "coma_icu_tmw",
                                        "delirium_icu_tmw",
                                        "on_restraints_icu_tmw",
                                        "ever_readmit_icu"),
                            exposure = c("comp_yn_f", "comp_prop",
                                         "perf_yn_f", "perf_prop",
                                         "comp_yn_prop", "comp_elem_prop",
                                         "perf_yn_prop", "perf_elem_prop"),
                            covars = c(logmods_covars_base,
                                       logmods_covars_daily),
                            df = df_logmods){
  
  mod <- fit_daily_lrm(
    outcome = outcome, exposure = exposure, covars = covars, df = df
  )
  
  ors <- daily_outexp_ors(mod, exposure, df)
  
  if(!(exposure %in% c("comp_yn_f", "perf_yn_f"))){
    probs <- get_daily_probs(mod, exposure, df)
  } else{
    probs <- NULL
  }
  
  return(list("mod" = mod, "ors" = ors, "probs" = probs))
}

## -- Wrapper to do all exposures for a given outcome --------------------------
outcome_results_lrm <- function(outcome,
                                exposures = logmods_exposures,
                                covars = c(logmods_covars_base,
                                           logmods_covars_daily),
                                df = df_logmods){
  
  ## Get list with results of fit_results_lrm() for each exposure
  modlist <- map(exposures,
                 ~ fit_results_lrm(outcome = outcome,
                                   exposure = .,
                                   covars = covars, df = df))
  
  ## Pull out list of model fits only
  mods <- map(modlist, "mod")
  
  ## Put like results together (ORs, predicted probs)
  or_df <- map_df(modlist, "ors")
  probs_df <- map_df(modlist, "probs")
  
  return(list("ors" = or_df, "probs" = probs_df, "mods" = mods))
}

## -- Functions for in-ICU outcome results -------------------------------------
## -- Function to describe exclusion due to missingness ------------------------
in_icu_exclusion <- function(outcome_df){
  ## It is assumed that outcome_df has a logical variable called `include` that
  ## tells us whether the record will be included in the final model. This is
  ## not ideal practice. If this weren't an hourly project I'd do it better.
  ## SORRY UNIVERSE
  
  ## String describing number of patients, patient-days excluded
  miss_days_n <- nrow(df_logmods) - sum(outcome_df[ , "include"])
  miss_days_pct <- round((miss_days_n / nrow(df_logmods) * 100))
  miss_pts_n <- length(unique(df_logmods$id)) -
    length(unique(subset(outcome_df, include)$id))
  miss_pts_pct <- round((miss_pts_n / length(unique(df_logmods$id)) * 100))
  
  sprintf("Out of %s eligible patient-days, %s patient-days (%s%%) were excluded due to missing data, detailed below. Out of %s patients with an eligible ICU day, %s (%s%%) were completely excluded from this model because of missing data on all their ICU days.",
        format(nrow(df_logmods), big.mark = ","),
        format(miss_days_n, big.mark = ","),
        format(miss_days_pct, big.mark = ","),
        format(length(unique(df_logmods$id)), big.mark = ","),
        format(miss_pts_n, big.mark = ","),
        format(miss_pts_pct, big.mark = ","))
}

## -- Function to get info about patients, days, outcome -----------------------
inicu_outcome_info <- function(outcome, df){
  ## Number of unique patients and days
  ## Number of days with and without outcome
  npts <- length(unique(df[,"id"]))
  ndays <- nrow(df)
  ndays_outcome <- sum(df[,outcome] == levels(df[,outcome])[2], na.rm = TRUE)
  ndays_nooutcome <- sum(df[,outcome] == levels(df[,outcome])[1], na.rm = TRUE)
  
  outcome_info <- sprintf(
    "%s patients included, with a total of %s records\n%s records had outcome the following day; %s did not",
    format(npts, big.mark = ","),
    format(ndays, big.mark = ","),
    format(ndays_outcome, big.mark = ","),
    format(ndays_nooutcome, big.mark = ",")
  )
  
  return(outcome_info)
}

## -- Function to plot odds ratios for compliance & performance ----------------
inicu_or_results <- function(outcome_results, ## result of outcome_results_lrm()
                             outcome_info,    ## result of inicu_outcome_info()
                             outcome_name){   ## name of outcome (eg "MV")

  ## Issue with coma: No patients with the bundle fully performed were comatose
  ##   the following day, blowing our odds ratios right up to crazytown. Remove
  ##   these results from the $ors element of outcome_results.
  if(tolower(outcome_name) == "coma"){
    outcome_results$ors <- outcome_results$ors %>%
      filter(!(comp.c %in% c("Not performed", "Performed")))
  }
                                 
  ors <- outcome_results$ors %>%
    ## We don't want to plot reference levels
    filter(!is.ref) %>%
    mutate(
      ## Prep for separating into indicators for comp vs perf, y/n vs dose
      variable = gsub("\\_f$", "", variable),
      ## We'll order the Y axis labels by this variable later:
      yval = ifelse(comp.c %in% c("Performed", "Compliant"), 0,
                    floor((comp + 0.01) * 100)),
      ## Create text for Y axis labels: comparison + P-value
      ylabel = ifelse(comp.c %in% c("Performed", "Compliant"),
                      "Yes vs No",
                      sprintf("%s%% vs %s%%",
                              trimws(rndformat(comp * 100, 0)),
                              trimws(rndformat(ref * 100, 0)))),
      ## Order so that 100% is on top
      ylabel = fct_reorder(ylabel, yval),
      ## Create OR/CI text to place inside figure
      or_text = sprintf(
        "%s (%s, %s)", rndformat(effect), rndformat(lcl), rndformat(ucl)
      )
    ) %>%
    ## Get indicators for comp vs perf, y/n vs dose
    separate(variable, into = c("cp", "yn_prop"), sep = "_") %>%
    ## Move y/n to top; add p-values to Compliance/Performance labels
    mutate(
      yn_prop = factor(ifelse(yn_prop == "yn", 1, 2),
                       levels = 1:2, labels = c("Overall", "Dose")),
      cp = factor(
        ifelse(cp == "comp", 1, 2),
        levels = 1:2,
        labels = c(
          sprintf(
            "Compliance\n\nP, overall: %s; P, dose: %s",
            formatp(
              subset(outcome_results$ors, variable == "comp_yn_f")$pval[1]
            ),
            formatp(
              subset(outcome_results$ors, variable == "comp_prop")$pval[1]
            )
          ),
          sprintf(
            "Performance\n\nP, overall: %s; P, dose: %s",
            formatp(
              subset(outcome_results$ors, variable == "perf_yn_f")$pval[1]
            ),
            formatp(
              subset(outcome_results$ors, variable == "perf_prop")$pval[1]
            )
          )
        )
      )
    )
  
  orplot <- ggplot(data = ors, aes(x = effect, y = ylabel)) +
    facet_grid(yn_prop ~ cp, scales = "free_y", space = "free_y") +
    geom_vline(xintercept = 1, colour = "grey70",
               linetype = "solid", size = 1) +
    geom_segment(aes(x = lcl, xend = ucl, yend = ylabel, colour = cp)) +
    geom_point(aes(colour = cp)) +
    geom_text(aes(label = or_text),
              x = -0.80, size = 3, hjust = 0, colour = "grey15") +
    scale_x_continuous(name = "Adjusted Odds Ratio (95% Confidence Interval)",
                       ## X limits: -0.5 to ceiling (up to 0.2) of highest UCL
                       limits = c(-0.75, ceiling(max(ors$ucl) / 0.2) * 0.2),
                       breaks = seq(0, 10, 0.2)) +
    scale_y_discrete(name = "") +
    scale_colour_manual(values = as.character(magglass_colors[c("f", "c")])) +
    labs(caption = sprintf("\nOdds ratios below 1 are favorable, indicating a lower likelihood of %s the following day.\n\n%s", outcome_name, outcome_info)) +
    theme_minimal() +
    theme(legend.position = "none",
          strip.text = element_text(face = "bold"),
          strip.background = element_rect(colour = "grey80", fill = "grey90"),
          axis.title.x = element_text(vjust = 0),
          axis.text.y = element_text(face = "bold"),
          panel.background = element_rect(colour = "grey80", fill = NA),
          panel.grid.major.y = element_blank(),
          panel.grid.minor = element_blank(),
          plot.subtitle = element_text(size = 8, face = "italic"),
          plot.caption = element_text(size = 8, face = "italic"))
  
  return(orplot)
}

## -- Function to plot predicted probs for comp/perf doses ---------------------
inicu_prob_results <- function(outcome_results,
                                 ## result of outcome_results_lrm()
                               outcome_info,
                                 ## result of inicu_outcome_info()
                               outcome_name,
                                 ## name of outcome (eg "MV")
                               ## Add raw data? If so, supply variable name, df
                               add_raw = TRUE,
                               outcome, df){
  
  ## Y axis limits are 0-100% if raw data not included, -0.1 - 1.1 if it is
  if(add_raw){
    ylims <- c(-0.1, 1.1)
  } else{
    ylims <- 0:1
  }
                                 
  ## Add faceting variable to predicted probabilities
  probs <- outcome_results$probs %>%
    mutate(cp = factor(ifelse(exposure == "comp_prop", 1, 2),
                       levels = 1:2, labels = c("Compliance", "Performance")))

  probsplot <- ggplot(data = probs, aes(x = prop_done, y = yhat)) +
    facet_wrap( ~ cp, nrow = 1) +
    geom_ribbon(aes(ymin = lower, ymax = upper, fill = cp), alpha = 0.3) +
    geom_line(aes(colour = cp)) +
    scale_x_continuous(name = "Percent of Eligible ABCDEF Bundle Elements Done",
                       limits = 0:1,
                       breaks = seq(0, 1, 0.2),
                       labels = paste0(seq(0, 1, 0.2) * 100, "%")) +
    scale_y_continuous(
      name = sprintf("Adjusted Probability of %s the Following Day",
                     outcome_name),
      limits = ylims,
      breaks = seq(0, 1, 0.2),
      labels = paste0(seq(0, 1, 0.2) * 100, "%")
    ) +
    scale_fill_manual(values = as.character(magglass_colors[c("f", "c")])) +
    scale_colour_manual(values = as.character(magglass_colors[c("f", "c")])) +
    theme_minimal() +
    theme(legend.position = "none",
          strip.text = element_text(face = "bold"),
          strip.background = element_rect(colour = "grey80", fill = "grey90"),
          panel.background = element_rect(colour = "grey80", fill = NA),
          plot.subtitle = element_text(size = 8, face = "italic"),
          plot.caption = element_text(size = 8, face = "italic"))
  
  ## Create dataset for and add raw points if requested
  if(add_raw){
    tmp <- df %>%
      dplyr::select(comp_prop, perf_prop, matches(outcome)) %>%
      gather(key = exposure, value = prop_done, comp_prop, perf_prop)
    
    ## yhat = -0.05 if patient had ref level, 1.05 = if patient had outcome
    ## This used to be in mutate(); guessing this is where tidyeval would help
    tmp$yhat <- as.numeric(tmp[, outcome] == levels(tmp[, outcome])[2])
    tmp$yhat <- ifelse(tmp$yhat == 0, -0.05, 1.05)
    ## Faceting variable to match predicted probabilities
    tmp$cp <- factor(ifelse(tmp$exposure == "comp_prop", 1, 2),
                     levels = 1:2, labels = c("Compliance", "Performance"))
    
    probsplot <- probsplot +
      geom_point(aes(x = prop_done, y = yhat, colour = cp),
                 position = position_jitter(height = 0.05, width = 0.05),
                 alpha = 0.01,
                 data = tmp) +
    labs(caption = sprintf("\nLower probabilities are favorable, indicating a lower likelihood of %s the following day.\n\nPoints above are unadjusted, raw data, where patientswith %s the following day\nare at 100%% and patients without the outcome are at 0%%.\n\n%s", outcome_name, outcome_name, outcome_info))
  } else{
    probsplot <- probsplot +
      labs(caption = sprintf("\nLower probabilities are favorable, indicating a lower likelihood of %s the following day.\n\n%s", outcome_name, outcome_info))
  }

  return(probsplot)
}

```

## Mechanical Ventilation

```{r mvmods, results = "hide"}
## -- Create dataset with only complete records --------------------------------
mv_vars <- c("on_mv_icu_f_tmw", logmods_covars_base, logmods_covars_daily)
df_logmod_mv <- df_logmods
df_logmod_mv$include <- rowSums(is.na(df_logmod_mv[,mv_vars])) == 0

## Get info statement for exclusions due to missingness
miss_info_mv <- in_icu_exclusion(df_logmod_mv)

## Remove records with incomplete data
df_logmod_mv <- subset(df_logmod_mv, include)

## -- Fit models and get results -----------------------------------------------
mv_results <-
  outcome_results_lrm(outcome = "on_mv_icu_f_tmw", df = df_logmod_mv)

## String describing outcome, patients, days
mv_info <- inicu_outcome_info(outcome = "on_mv_icu_f_tmw", df = df_logmod_mv)

## Plot of odds ratios/CIs
mv_orplot <- inicu_or_results(
  outcome_results = mv_results, outcome_info = mv_info, outcome_name = "MV"
)
## Plot of predicted probabilities
mv_probplot <- inicu_prob_results(
  outcome_results = mv_results,
  outcome_name = "MV",
  outcome_info = mv_info,
  add_raw = TRUE,
  outcome = "on_mv_icu_f_tmw",
  df = df_logmod_mv
)

```

After adjusting for available confounders, both better compliance and better performance of the ABCDEF Bundle on a given day are associated with a lower likelihood of being on mechanical ventilation the following day among the patients we were able to include in our model.

```{r print_mvors}
mv_orplot

```

```{r print_mvprobs}
mv_probplot

```

## Coma

```{r comamods, results = "hide"}
## -- Create dataset with only complete records --------------------------------
coma_vars <- c("coma_icu_tmw", logmods_covars_base, logmods_covars_daily)
df_logmod_coma <- df_logmods
df_logmod_coma$include <- rowSums(is.na(df_logmod_coma[,coma_vars])) == 0

## Get info statement for exclusions due to missingness
miss_info_coma <- in_icu_exclusion(df_logmod_coma)

## Remove records with incomplete data
df_logmod_coma <- subset(df_logmod_coma, include)

## -- Fit models and get results -----------------------------------------------
coma_results <-
  outcome_results_lrm(outcome = "coma_icu_tmw", df = df_logmod_coma)

## String describing outcome, patients, days
coma_info <- inicu_outcome_info(outcome = "coma_icu_tmw", df = df_logmod_coma)

## Plot of odds ratios/CIs
coma_orplot <- inicu_or_results(
  outcome_results = coma_results, outcome_info = coma_info, outcome_name = "Coma"
)
## Plot of predicted probabilities
coma_probplot <- inicu_prob_results(
  outcome_results = coma_results,
  outcome_name = "Coma",
  outcome_info = coma_info,
  add_raw = TRUE,
  outcome = "coma_icu_tmw",
  df = df_logmod_coma
)

```

After adjusting for available confounders including APACHE III, better ABCDEF Bundle performance is directionally, but not statistically, associated with
lower odds of coma the following day among the patients we were able to include
in our model. This lack of effect could be due to adjustment for SOI, or
restriction of our population, or both.

**NOTE**: Among the subset of patients with an APACHE III available, no patients
who had the Bundle fully performed were comatose and in the ICU the following
day, making this model mathematically untenable. It is therefore not included
in the results below.

```{r print_comaors}
coma_orplot

```

```{r print_comaprobs}
coma_probplot

```

## Delirium

```{r delmods, results = "hide"}
## -- Create dataset with only complete records --------------------------------
del_vars <- c("delirium_icu_tmw", logmods_covars_base, logmods_covars_daily)
df_logmod_del <- df_logmods
df_logmod_del$include <- rowSums(is.na(df_logmod_del[,del_vars])) == 0

## Get info statement for exclusions due to missingness
miss_info_del <- in_icu_exclusion(df_logmod_del)

## Remove records with incomplete data
df_logmod_del <- subset(df_logmod_del, include)

## -- Fit models and get results -----------------------------------------------
del_results <-
  outcome_results_lrm(outcome = "delirium_icu_tmw", df = df_logmod_del)

## String describing outcome, patients, days
del_info <- inicu_outcome_info(outcome = "delirium_icu_tmw", df = df_logmod_del)

## Plot of odds ratios/CIs
del_orplot <- inicu_or_results(
  outcome_results = del_results,
  outcome_info = del_info,
  outcome_name = "delirium"
)
## Plot of predicted probabilities
del_probplot <- inicu_prob_results(
  outcome_results = del_results,
  outcome_name = "delirium",
  outcome_info = del_info,
  add_raw = TRUE,
  outcome = "delirium_icu_tmw",
  df = df_logmod_del
)

```

After adjusting for available confounders including delirium and APACHE III,
full performance of the ABCDEF Bundle on a given day is associated with a lower
likelihood of being delirious the following day among the patients we were able
to include in our model. After restricting our population and adjusting for
APACHE III, we no longer see a strong dose-response relationship between Bundle
performance and odds of delirium the following day; this could be due to
adjustment for SOI, and/or to low delirium prevalence and sample size in this
sensitivity analysis.

```{r print_delors}
del_orplot

```

```{r print_delprobs}
del_probplot

```

## Physical Restraints

```{r resmods, results = "hide"}
## -- Create dataset with only complete records --------------------------------
res_vars <-
  c("on_restraints_icu_tmw", logmods_covars_base, logmods_covars_daily)
df_logmod_res <- df_logmods
df_logmod_res$include <- rowSums(is.na(df_logmod_res[,res_vars])) == 0

## Get info statement for exclusions due to missingness
miss_info_res <- in_icu_exclusion(df_logmod_res)

## Remove records with incomplete data
df_logmod_res <- subset(df_logmod_res, include)

## -- Fit models and get results -----------------------------------------------
res_results <-
  outcome_results_lrm(outcome = "on_restraints_icu_tmw", df = df_logmod_res)

## String describing outcome, patients, days
res_info <-
  inicu_outcome_info(outcome = "on_restraints_icu_tmw", df = df_logmod_res)

## Plot of odds ratios/CIs
res_orplot <- inicu_or_results(
  outcome_results = res_results,
  outcome_info = res_info,
  outcome_name = "restraints"
)
## Plot of predicted probabilities
res_probplot <- inicu_prob_results(
  outcome_results = res_results,
  outcome_name = "restraints",
  outcome_info = res_info,
  add_raw = TRUE,
  outcome = "on_restraints_icu_tmw",
  df = df_logmod_res
)

```

After adjusting for available confounders including APACHE III, full and more
performance of the ABCDEF Bundle on a given day are both associated with lower
odds of restraint use the following day among the patients we were able
to include in our model.

```{r print_resors}
res_orplot

```

```{r print_resprobs}
res_probplot

```

