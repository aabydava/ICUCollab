---
title: "ICU Liberation: ABCDEF Bundle vs ICU Outcomes"
author: "Jennifer Thompson, MPH for Society of Critical Care Medicine"
output:
  html_notebook:
    code_folding: hide
    theme: journal
    toc: true
    toc_float: true
    toc_depth: 4
---

```{r setup, results = "hide"}
suppressPackageStartupMessages(library(tidyverse, quietly = TRUE))
suppressPackageStartupMessages(library(forcats, quietly = TRUE))
suppressPackageStartupMessages(library(stringr, quietly = TRUE))
suppressPackageStartupMessages(library(rms, quietly = TRUE))
suppressPackageStartupMessages(library(captioner, quietly = TRUE))
suppressPackageStartupMessages(library(plotly, quietly = TRUE))
suppressPackageStartupMessages(library(naniar, quietly = TRUE))
suppressPackageStartupMessages(library(JTHelpers, quietly = TRUE))
suppressPackageStartupMessages(library(pander, quietly = TRUE))

load("AnalysisData/iculib.Rdata")

## Combine months 1-6 (baseline); keep implementation months separate
demog$month_cat <- with(demog, {
  factor(ifelse(month_f %in% paste("Month", 1:6), 1,
                as.numeric(gsub("^Month ", "", month_f)) - 5),
         levels = 1:15,
         labels = c("Baseline", paste("Imp", 1:14)))
})
demog$month_cat_short <- with(demog, {
  factor(ifelse(month_f %in% paste("Month", 1:6), 1,
                as.numeric(gsub("^Month ", "", month_f)) - 5),
         levels = 1:15,
         labels = c("BL", paste0("I", 1:14)))
})

compliance$month_cat <- with(compliance, {
  factor(ifelse(month_f %in% paste("Month", 1:6), 1,
                as.numeric(gsub("^Month ", "", month_f)) - 5),
         levels = 1:15,
         labels = c("Baseline", paste("Imp", 1:14)))
})
compliance$month_cat_short <- with(compliance, {
  factor(ifelse(month_f %in% paste("Month", 1:6), 1,
                as.numeric(gsub("^Month ", "", month_f)) - 5),
         levels = 1:15,
         labels = c("BL", paste0("I", 1:14)))
})

## Vector of hex colors from magnifying glass in slide templates
## (via colorcodepicker.com)
magglass_colors <- c("a" = "#E16725",
                     "b" = "#FBA724",
                     "c" = "#698C36",
                     "d" = "#07A7B4",
                     "e" = "#138CBD",
                     "f" = "#293F90",
                     "overall" = "black")

```

```{r tablesfigs, results = "hide"}
table_nums <- captioner(prefix = "Table")
table_nums(
  name = "descbase", caption = "Baseline and Demographic Characteristics"
)
table_nums(
  name = "descinhosp", caption = "In-Hospital and Discharge Characteristics"
)
table_nums(name = "descicudays", caption = "ICU Day Characteristics")
table_nums(
  name = "descabcdef", caption = "Bundle Compliance and Performance, Overall"
)
table_nums(
  name = "missing_mv",
  caption = "% of Records Excluded from MV Model due to Missingness by Variable"
)

figure_nums <- captioner(prefix = "Figure")
figure_nums(name = "run_comp", caption = "ABCDEF Compliance Over Time")
figure_nums(name = "run_perf", caption = "ABCDEF Performance Over Time")
figure_nums(name = "run_meds", caption = "Medication Use Over Time")
figure_nums(
  name = "ors_mv",
  caption = "Adjusted Odds Ratios, ABCDEF Bundle vs Mechanical Ventilation"
)
figure_nums(
  name = "probs_mv",
  caption = "Adjusted Probabilities of Mechanical Ventilation vs Dose of ABCDEF Bundle"
)

```

# Overview & Purpose

This report aims to:

1. Describe the cohort of patients in the [SCCM ICU Liberation ABCDEF Bundle Improvement Collaborative](http://www.iculiberation.org/About/collaborative/Pages/default.aspx)
1. Describe the implementation of the [ABCDEF Bundle](http://www.iculiberation.org/Bundles/Pages/default.aspx) over the course of the Collaborative
1. Describe the association between compliance and performance of the ABCDEF Bundle and important ICU outcomes *(outcomes will be detailed in a later section)*

The Collaborative enrolled patients at `r length(unique(demog$hosp_f))` ICUs
across the United States, collecting data during a six-month **baseline** period
and a 14-month **implementation** period. During the six months of baseline data
collection, no changes in usual care were prescribed; during the 14 months of
implementation, sites were encouraged to use the ABCDEF Bundle. Our hypotheses
are that implementation rates improved over the course of data collection, and
that increased compliance with and performance of the ABCDEF Bundle is
associated with better in-hospital outcomes.

Our analysis plan was specified *a priori* and can be found [here](https://docs.google.com/document/d/1GebrA6Lt-rEh70Aw9r4mrhRlggWUfgUl_LaQePOCWZA/edit?usp=sharing), including a history of all changes.

# Definitions of Compliance and Performance {#definitions}

There are six main elements of the ABCDEF Bundle, with element B comprised of
two main components. Definitions of "compliance" (completely following the ABCDEF Bundle protocol as specified, with documentation of each step) and "performance" (performing the main component of the Bundle element, possibly without complete documentation) are detailed below, referring to any single day. For each element,
compliance and performance are only measured if the patient was in the ICU the
full 24 hours; additional eligibility for specific elements are detailed below.

| Bundle element    | Days eligible | Compliant if: | Performed if: |
|-------------------|---------------|---------------|---------------|
| **A: Assess, prevent and manage pain**  | | >=6 documented pain assessments using a validated instrument | *same* |
| **B: Both SAT and SBT** |   |   |   |
| &nbsp;&nbsp;&nbsp;SAT | Received continuous/ intermittent sedation | **If safety screen documented:**<br>If screen failed, SAT not performed; if screen passed, SAT was performed<br>**If safety screen not documented:**<br>SAT marked not done due to  failed screen/contraindication | SAT performed and documented |
| &nbsp;&nbsp;&nbsp;SBT | On mechanical ventilation | **If safety screen documented:**<br>If screen failed, SBT not performed; if screen passed, SBT was performed<br>**If safety screen not documented:**<br>SBT marked not done due to  failed screen/contraindication | SBT performed and documented |
| **C: Choice of analgesia and sedation** | | >=6 documented sedation assessments using a validated instrument | *same* |
| **D: Delirium - assess, prevent and manage** | | >=2 documented delirium assessments using a validated instrument | *same* |
| **E: Exercise and early mobility** | | **If safety screen documented:**<br>If screen failed, mobility not performed; if screen passed, mobility higher than active range of motion was performed<br>**If safety screen not documented:**<br>Mobility marked not done due to failed screen/contraindication | Mobility higher than active range of motion performed and documented |
| **F: Family engagement and empowerment** | Family present | Family member was educated on ABCDEF bundle and/or participated in at least one of: rounds; conference; plan of care; ABCDEF care | *same* |
| **Overall (complete)** | | All elements eligible to be compliant are compliant | All elements eligible to be performed are performed |
| **Overall (dose)** | | Elements compliant / elements eligible to be compliant | Elements performed / elements eligible to be performed |

# Variable Calculation {#variables}

- **Age:** For descriptive purposes, all age data is left as entered; however,
due to low numbers in our most extreme categories, we combined patients <18 with 18-29-year-olds and patients >90 with 80-89-year-olds in the age variable included in our models.
- **Race:** For descriptive purposes, all race data is left as entered; however,
for modeling, we combined categories with <1% representation. Patients with races of American Indian/Alaskan Native and Native Hawaiian/Pacific Islander are combined, and the very few patients with multiple races marked are combined with patients with "Other" race marked.
- **BMI:** BMI was calculated as `weight / (height / 100)^2`, where weight was entered in kg and height was entered in cm. We assumed that any height below 80 was accidentally entered in inches rather than cm, and converted those heights to cm (original height * 2.54). After calculating BMI, some values were implausible; we assumed that any BMI < 7 (based on anorexia data) or > 204 (based on highest recorded BMI) was due to data entry error, and these values (along with anyone for whom weight and/or height were missing or equal to 0) were forced to be missing.
- **ICU type:** Site self-descriptions were combined as follows:
    - Mixed medical/surgical: *ICU, medical & surgical ICU, critical care unit, adult ICU, adult critical care unit, trauma & life support center*
    - Medical: *medical ICU, medical critical care unit*
    - Surgical/trauma: *surgical ICU, trauma ICU*
    - Neuro: *neuro ICU*
    - Cardiac/surgical: *adult surgical heart unit, cardiac surgical ICU, cardiothoracic ICU, cardiovascular ICU*
    - Cardiac: *cardio-neuro ICU, cardio ICU*
- **Primary admission diagnoses:** Patients could be admitted with multiple admission diagnoses; therefore, we prioritized diagnoses to capture the most important information relevant to this particular project. Diagnoses were categorized and prioritized as following (ie, a patient admitted with both sepsis and pneumonia would be in the sepsis category):
    1. Sepsis/septic shock or ARDS: *sepsis/septic shock; ARDS without infection*
    1. Respiratory: *airway protection/obstruction; COPD/asthma; pneumonia; pulmonary embolism/DVT*
    1. Neurologic: *neurological disease; traumatic brain injury; change in mental status; traumatic brain injury (isolated)*
    1. Cardiac: *congestive heart failure; acute MI/cardiogenic shock; arrhythmia*
    1. Gastrointestinal: *GI bleed; cirrhosis/hepatic failure; pancreatitis*
    1. Genitourinary: *renal failure; metabolic/endocrine/electrolyte disturbances*
    1. Surgery: *vascular; abdominal; transplant; urologic; orthopedic; ENT; OB/GYN*
    1. Trauma: *multi-trauma; hemorrhagic shock*
    1. Drug overdose/withdrawal
    1. Other: *other infectious diseases; malignancy; "other"*

Full details on how many calculated variables are determined from raw data, including definitions of compliance and performance, are in the [analysis plan](https://docs.google.com/document/d/1GebrA6Lt-rEh70Aw9r4mrhRlggWUfgUl_LaQePOCWZA/edit?usp=sharing).

# Descriptive Statistics, Entire Cohort

This section describes all patients enrolled during Months 1-20 of data
collection, including demographics and characteristics at ICU admission,
throughout the hospital stay, and on each patient-day.

**Note: not all these patients can be included in analyses.** All analyses require that patients spend at least one day fully in
the ICU to be included; this reduces the total *potential* N to
`r format(sum(demog$icu_days > 0, na.rm = TRUE), big.mark = ",")` patients.
Specific numbers of patients included in each analysis will be shown as each
model is discussed.

For full definitions of compliance and performance, see [Definitions](#definitions).

```{r descbase}
## Add labels to variables we want to describe - labels don't play well with
## tidyverse so copy a separate data.frame
demog_desc <- demog

demog_desc$hosp_f <- as.factor(demog_desc$hosp_f)

label(demog_desc$hosp_f) <- "Study site"
label(demog_desc$hosp_type) <- "Hospital type"
label(demog_desc$month_cat) <- "Time period"
label(demog_desc$age_f) <- "Age category"
label(demog_desc$sex_f) <- "Sex"
label(demog_desc$race_cat) <- "Race"
label(demog_desc$hisp_cat) <- "Hispanic"
label(demog_desc$bmi) <- "BMI"
label(demog_desc$home_preadmit) <- "Residence pre-admission"
label(demog_desc$mob_preadmit) <- "Mobility pre-admission"
label(demog_desc$primary_admit) <- "Primary admission diagnosis"
label(demog_desc$icu_type_comb) <- "ICU type"
label(demog_desc$any_soi) <- "Any severity of illness score available"
label(demog_desc$apacheii_avail) <- "APACHE II available"
label(demog_desc$apacheii_score) <- "APACHE II score"
label(demog_desc$apacheiii_avail) <- "APACHE III available"
label(demog_desc$apacheiii_score) <- "APACHE III score"
label(demog_desc$apacheiv_avail) <- "APACHE IV available"
label(demog_desc$apacheiv_score) <- "APACHE IV score"
label(demog_desc$sofa_avail) <- "SOFA available"
label(demog_desc$sofa_score) <- "SOFA score"
label(demog_desc$othersoi_avail) <- "Other SOI available"
label(demog_desc$ever_invas_mv) <- "Ever on invasive MV"
label(demog_desc$hrs_invas_mv) <- "Hours on invasive MV"
label(demog_desc$ever_noninvas_mv) <- "Ever on noninvasive MV"
label(demog_desc$hrs_noninvas_mv) <- "Hours on noninvasive MV"
label(demog_desc$icu_los) <- "ICU length of stay"
label(demog_desc$icu_days) <- "Days all 24h in ICU"
label(demog_desc$ever_readmit_icu) <- "Ever readmitted to ICU"
label(demog_desc$had_painasmt_icu_days) <-
  "Days in ICU with >=1 pain assessment with validated tool"
label(demog_desc$sigpain_icu_days) <- "Days in ICU with significant pain"
label(demog_desc$on_sedation_icu_days) <-
  "Days in ICU on continuous/intermittent sedation"
label(demog_desc$had_satscreen_icu_days) <- "Days in ICU with SAT safety screen"
label(demog_desc$had_sat_icu_days) <- "Days in ICU with SAT performed"
label(demog_desc$on_mv_icu_days) <- "Days in ICU on MV"
label(demog_desc$had_sbtscreen_icu_days) <- "Days in ICU with SBT safety screen"
label(demog_desc$had_sbt_icu_days) <- "Days in ICU with SBT performed"
label(demog_desc$sat_sbt_icu_days) <- "Days in ICU with SAT prior to SBT"
label(demog_desc$rcvd_benzo_icu_days) <- "Days received benzodiazepines in ICU"
label(demog_desc$rcvd_opioid_icu_days) <- "Days received opioids in ICU"
label(demog_desc$rcvd_propofol_icu_days) <- "Days received propofol in ICU"
label(demog_desc$rcvd_dex_icu_days) <- "Days received dex in ICU"
label(demog_desc$had_sedasmt_icu_days) <-
  "Days in ICU with >=1 sedation assessment"
label(demog_desc$had_delasmt_icu_days) <-
  "Days in ICU with >=1 delirium assessment"
label(demog_desc$delirium_icu_days) <- "Days in ICU with delirium"
label(demog_desc$had_mobscreen_icu_days) <-
  "Days in ICU with mobility safety screen"
label(demog_desc$had_mobility_icu_days) <-
  "Days in ICU with mobility performed (> active ROM)"
label(demog_desc$family_present_icu_days) <- "Days in ICU with family present"
label(demog_desc$family_invited_icu_days) <-
  "Days in ICU family invited to participate in rounds/conference"
label(demog_desc$family_rounds_icu_days) <-
  "Days in ICU family participated in rounds"
label(demog_desc$family_care_icu_days) <-
  "Days in ICU family participated in plan of care/ABCDEF care"
label(demog_desc$family_edu_icu_days) <-
  "Days in ICU family educated on ABCDEF bundle/related topics"
label(demog_desc$hosp_los) <- "Hospital length of stay"
label(demog_desc$home_posticu) <- "Residence post-ICU"
label(demog_desc$mob_posticu) <- "Mobility post-ICU"
label(demog_desc$dc_status_f) <- "Discharge status"
label(demog_desc$dc_loc_f) <- "Discharge location"
label(demog_desc$comp_a_days) <- "ICU days Element A compliant"
label(demog_desc$comp_a_prop) <- "Proportion of ICU days Element A compliant"
label(demog_desc$perf_a_days) <- "ICU days Element A performed"
label(demog_desc$perf_a_prop) <- "Proportion of ICU days Element A performed"
label(demog_desc$comp_b_sat_days) <- "ICU days Element B - SAT compliant"
label(demog_desc$comp_b_sat_prop) <-
  "Proportion of sedation ICU days Element B - SAT compliant"
label(demog_desc$perf_b_sat_days) <- "ICU days Element B - SAT performed"
label(demog_desc$perf_b_sat_prop) <-
  "Proportion of sedation ICU days Element B - SAT performed"
label(demog_desc$comp_b_sbt_days) <- "ICU days Element B - SBT compliant"
label(demog_desc$comp_b_sbt_prop) <-
  "Proportion of MV ICU days Element B - SBT compliant"
label(demog_desc$perf_b_sbt_days) <- "ICU days Element B - SBT performed"
label(demog_desc$perf_b_sbt_prop) <-
  "Proportion of MV ICU days Element B - SBT performed"
label(demog_desc$comp_c_days) <- "ICU days Element C compliant"
label(demog_desc$comp_c_prop) <- "Proportion of ICU days Element C compliant"
label(demog_desc$perf_c_days) <- "ICU days Element C performed"
label(demog_desc$perf_c_prop) <- "Proportion of ICU days Element C performed"
label(demog_desc$comp_d_days) <- "ICU days Element D compliant"
label(demog_desc$comp_d_prop) <- "Proportion of ICU days Element D compliant"
label(demog_desc$perf_d_days) <- "ICU days Element D performed"
label(demog_desc$perf_d_prop) <- "Proportion of ICU days Element D performed"
label(demog_desc$comp_e_days) <- "ICU days Element E compliant"
label(demog_desc$comp_e_prop) <- "Proportion of ICU days Element E compliant"
label(demog_desc$perf_e_days) <- "ICU days Element E performed"
label(demog_desc$perf_e_prop) <- "Proportion of ICU days Element E performed"
label(demog_desc$comp_f_days) <- "ICU days Element F compliant"
label(demog_desc$comp_f_prop) <-
  "Proportion of family ICU days Element F compliant"
label(demog_desc$perf_f_days) <- "ICU days Element F performed"
label(demog_desc$perf_f_prop) <-
  "Proportion of family ICU days Element F performed"
label(demog_desc$comp_yn_days) <- "ICU days entire bundle compliant"
label(demog_desc$comp_yn_prop) <-
  "Proportion of ICU days entire bundle compliant"
label(demog_desc$perf_yn_days) <- "ICU days entire bundle performed"
label(demog_desc$perf_yn_prop) <-
  "Proportion of ICU days entire bundle performed"

## Only describe days fully in ICU
comp_desc <- compliance %>% filter(icu_day)

label(comp_desc$pain_asmts_icu) <-
  "Number of pain assessments with validated tool"
label(comp_desc$had_painasmt_icu) <-
  "Had >=1 pain assessment with validated tool"
label(comp_desc$comp_a_f) <- "Element A: compliant"
label(comp_desc$perf_a_f) <- "Element A: performed"
label(comp_desc$sigpain_verbal_icu) <- "Significant pain self-reported"
label(comp_desc$sigpain_valid_icu) <- "Significant pain using validated tool"
label(comp_desc$sigpain_icu) <- "Significant pain, either method"

label(comp_desc$on_sedation_icu_f) <- "On continuous/intermittent sedation"
label(comp_desc$had_satscreen_icu) <- "SAT safety screen documented"
label(comp_desc$had_sat_icu) <- "SAT documented"
label(comp_desc$comp_b_sat_f) <- "Element B - SAT: compliant"
label(comp_desc$perf_b_sat_f) <- "Element B - SAT: performed"

label(comp_desc$on_mv_icu_f) <- "On mechanical ventilation"
label(comp_desc$had_sbtscreen_icu) <- "SBT safety screen documented"
label(comp_desc$had_sbt_icu) <- "SBT documented"
label(comp_desc$comp_b_sbt_f) <- "Element B - SBT: compliant"
label(comp_desc$perf_b_sbt_f) <- "Element B - SBT: performed"
label(comp_desc$sat_sbt_icu) <- "SAT performed before SBT"

label(comp_desc$sed_assess_valid_icu) <-
  "Number of sedation assessments with validated tool"
label(comp_desc$had_sedasmt_icu) <-
  "Had >=1 sedation assessment with validated tool"
label(comp_desc$comp_c_f) <- "Element C: compliant"
label(comp_desc$perf_c_f) <- "Element C: performed"
label(comp_desc$rcvd_benzo_icu) <- "Received benzodiazepines"
label(comp_desc$rcvd_opioid_icu) <- "Received opioids"
label(comp_desc$rcvd_propofol_icu) <- "Received propofol"
label(comp_desc$rcvd_dex_icu) <- "Received dexmedetomidine"

label(comp_desc$del_assess_valid_icu) <-
  "Number of delirium assessments with validated tool"
label(comp_desc$had_delasmt_icu) <-
  "Had >=1 delirium assessment with validated tool"
label(comp_desc$comp_d_f) <- "Element D: compliant"
label(comp_desc$perf_d_f) <- "Element D: performed"
label(comp_desc$delirium_icu) <- "Delirious, per validated tool"
label(comp_desc$coma_icu) <- "Comatose"

label(comp_desc$on_restraints_icu) <- "On physical restraints"
label(comp_desc$had_mobscreen_icu) <- "Mobility safety screen documented"
label(comp_desc$had_mobility_icu) <- "Mobility > active ROM documented"
label(comp_desc$mobilityhighest_icu) <- "Highest level of mobility"
label(comp_desc$comp_e_f) <- "Element E: compliant"
label(comp_desc$perf_e_f) <- "Element E: performed"

label(comp_desc$family_present_icu_f) <- "Family present"
label(comp_desc$family_invited_icu) <-
  "Family invited to participate in rounds/conference"
label(comp_desc$family_rounds_icu) <- "Family participated in rounds"
label(comp_desc$family_care_icu) <-
  "Family participated in plan of care/ABCDEF care"
label(comp_desc$family_edu_icu) <-
  "Family educated on ABCDEF bundle/related topics"
label(comp_desc$comp_f_f) <- "Element F: compliant"
label(comp_desc$perf_f_f) <- "Element F: performed"

label(comp_desc$comfort_care_icu) <- "On comfort care"

label(comp_desc$comp_yn_f) <- "Overall ABCDEF compliance"
label(comp_desc$perf_yn_f) <- "Overall ABCDEF performance"
label(comp_desc$elements_elig) <-
  "Number of ABCDEF elements eligible to be performed/compliant"
label(comp_desc$elements_comp) <- "Number of elements compliant"
label(comp_desc$comp_prop) <- "Proportion of elements compliant"
label(comp_desc$elements_perf) <- "Number of elements performed"
label(comp_desc$perf_prop) <- "Proportion of elements performed"

## Example for percentiles for each table
bmi_quants <- quantile(demog$bmi, na.rm = TRUE)
hrsmv_quants <- quantile(demog$hrs_invas_mv, na.rm = TRUE)
painasmt_quants <- quantile(comp_desc$pain_asmts_icu, na.rm = TRUE)

```

## `r table_nums("descbase")`

Continuous variables are described by the 25th, 50th and 75th percentiles, in
that order (50th percentile = median). For example, 25% of patients had a BMI of
`r round(bmi_quants["25%"])` or less; 50% of patients had a BMI of
`r round(bmi_quants["50%"])` or less; and 75% of patients had a BMI of
`r round(bmi_quants["75%"])` or less.

```{r print_descbase}
html(summaryM(hosp_type + month_cat + age_f + sex_f + race_cat +
                hisp_cat + bmi + home_preadmit + mob_preadmit + primary_admit +
                icu_type_comb + any_soi + apacheii_score + apacheiii_score +
                apacheiv_score + sofa_score ~ 1,
              data = demog_desc,
              continuous = 5),
     what = "%",
     npct = "both",
     digits = 2,
     long = TRUE,
     caption = "Demographic and Baseline Characteristics")

```

## `r table_nums("descinhosp")`

Continuous variables are described by the 25th, 50th and 75th percentiles, in
that order (50th percentile = median). For example, 25% of patients had
`r round(hrsmv_quants["25%"])` or fewer hours on mechanical ventilation; 50% of
patients had `r round(hrsmv_quants["50%"])` or fewer hours on MV; and 75% of
patients had `r round(hrsmv_quants["75%"])` or fewer hours on MV.

For full definitions of compliance and performance, see [Definitions](#definitions).

```{r print_descinhosp}
html(summaryM(ever_invas_mv + hrs_invas_mv + ever_noninvas_mv +
                hrs_noninvas_mv + icu_los + ever_readmit_icu +
                had_painasmt_icu_days + sigpain_icu_days + comp_a_days +
                comp_a_prop + perf_a_days + perf_a_prop +
                on_sedation_icu_days + had_satscreen_icu_days +
                had_sat_icu_days + comp_b_sat_days + comp_b_sat_prop +
                perf_b_sat_days + perf_b_sat_prop +
                on_mv_icu_days + had_sbtscreen_icu_days + had_sbt_icu_days +
                sat_sbt_icu_days + comp_b_sbt_days + comp_b_sbt_prop +
                perf_b_sbt_days + perf_b_sbt_prop +
                had_sedasmt_icu_days + comp_c_days + comp_c_prop + perf_c_days +
                perf_c_prop + rcvd_benzo_icu_days + rcvd_opioid_icu_days +
                rcvd_propofol_icu_days + rcvd_dex_icu_days +
                had_delasmt_icu_days + delirium_icu_days + comp_d_days +
                comp_d_prop + perf_d_days + perf_d_prop +
                had_mobscreen_icu_days + had_mobility_icu_days + comp_e_days +
                comp_e_prop + perf_e_days + perf_e_prop +
                family_present_icu_days + family_invited_icu_days +
                family_rounds_icu_days + family_care_icu_days +
                family_edu_icu_days + comp_f_days + comp_f_prop + perf_f_days +
                perf_f_prop + hosp_los + home_posticu + mob_posticu +
                dc_status_f + dc_loc_f ~ 1,
              data = demog_desc,
              continuous = 5),
     what = "%",
     npct = "both",
     digits = 2,
     long = TRUE,
     caption = "In-Hospital and Discharge Characteristics",
     insert.bottom =
       'Note: "Days in ICU" refers to days the patient was in the ICU all 24h')

```

## `r table_nums("descicudays")`

`r table_nums("descicudays", display = "cite")` presents descriptive statistics
by **day** for all days which were completely in the ICU.

Continuous variables are described by the 25th, 50th and 75th percentiles, in
that order (50th percentile = median). For example, 25% of patient-days had
`r round(painasmt_quants["25%"])` or fewer pain assessments with validated
tools; 50% of patient-days had `r round(painasmt_quants["50%"])` or fewer assessments; and 75% of patient-days had `r round(painasmt_quants["75%"])` or
fewer assessments.

For full definitions of compliance and performance, see [Definitions](#definitions).

```{r print_descicudays}
html(summaryM(pain_asmts_icu + had_painasmt_icu + comp_a_f + perf_a_f +
                sigpain_verbal_icu + sigpain_valid_icu + sigpain_icu +
                on_sedation_icu_f + had_satscreen_icu + had_sat_icu +
                comp_b_sat_f + perf_b_sat_f + on_mv_icu_f + had_sbtscreen_icu +
                had_sbt_icu + comp_b_sbt_f + perf_b_sbt_f + sat_sbt_icu +
                sed_assess_valid_icu + had_sedasmt_icu + comp_c_f + perf_c_f +
                rcvd_benzo_icu + rcvd_opioid_icu + rcvd_propofol_icu +
                rcvd_dex_icu + del_assess_valid_icu + had_delasmt_icu +
                comp_d_f + perf_d_f + delirium_icu + coma_icu +
                on_restraints_icu + had_mobscreen_icu + had_mobility_icu +
                mobilityhighest_icu + comp_e_f + perf_e_f +
                family_present_icu_f + family_invited_icu + family_rounds_icu +
                family_care_icu + family_edu_icu + comp_f_f + perf_f_f +
                comfort_care_icu + comp_yn_f + perf_yn_f + elements_elig +
                elements_comp + comp_prop + elements_perf + perf_prop ~ 1,
              data = comp_desc,
              continuous = 5),
     what = "%",
     npct = "both",
     digits = 2,
     long = TRUE,
     caption = "Characteristics of ICU Days")

```

# ABCDEF Implementation & Drug Use Over Time

The following runcharts present rates of ABCDEF Bundle compliance and
performance, both overall and by individual element, over the course of data
collection, as well as rates of sedative and analgesic use. Months 1-6 are
grouped together as our Baseline period; Months 7-20 are shown individually.
Numerators and denominators for each point can be seen in tooltips (hover over
the point of interest). For full definitions of compliance and performance, see
[Definitions](#definitions).

```{r runchart_prep}
## -- Elements common to both runcharts ----------------------------------------
element_suffixes <- c("a", "b_sat", "b_sbt", "c", "d", "e", "f", "yn")
element_tracenames <- c("A", "B: SAT", "B: SBT", "C", "D", "E", "F", "Overall")
element_cols <- c("a", "b", "b", "c", "d", "e", "f", "overall")

## Create list of plot titles, X/Y coordinates
runchart_titles <- c("A: Assess, prevent, manage pain",
                     "B: SAT",
                     "B: SBT",
                     "C: Choice of analgesia & sedation",
                     "D: Delirium",
                     "E: Exercise/early mobility",
                     "F: Family",
                     "Entire ABCDEF Bundle")

runchart_xes <- c(0.01, 0.27, 0.52, rep(0.77, 4), 0.02)
runchart_ys <- c(rep(0.24, 3), 1.05, 0.775, 0.54, 0.24, 1.05)
runchart_titlesize <- c(rep(8, 7), 12)

## Create list of annotations - will substitute for plot titles
## (plotly will only allow one title per plot, not one per subplot)
make_annotate_item <- function(title, title_size, xval, yval){
  list(x = xval, xanchor = "left", xref = "paper",
       y = yval, yanchor = "top", yref = "paper",
       text = paste0("<b>", title, "</b>"),
       font = list(size = title_size, family = "sans-serif"),
       showarrow = FALSE)
}

title_list <- pmap(.l = list("title" = runchart_titles,
                             "title_size" = runchart_titlesize,
                             "xval" = runchart_xes,
                             "yval" = runchart_ys),
                   .f = make_annotate_item)

## -- Function to create a plotly object for each element/overall --------------
create_plotly_runchart <- function(df, tracename, tracecol){
  if(tracename == "Overall"){
    ts <- 18
    fs <- 10
    tvals <- c("BL", paste0("I", 1:14))
    ms <- 6
  } else{
    ts <- 14
    fs <- 6
    tvals <- c("BL", paste0("I", seq(1, 13, 2)))
    ms <- 4
  }

  plot_ly(
    data = df,
    x = ~ month_cat_short,
    y = ~ pct_yes,
    name = tracename,
    line = list(color = magglass_colors[tracecol]),
    marker = list(color = magglass_colors[tracecol], size = ms),
    text = ~ tt_text,
    type = "scatter",
    mode = "lines+markers"
  ) %>%
    layout(titlefont = list(size = ts),
           xaxis = list(title = "",
                        tickfont = list(size = fs),
                        tickmode = "array",
                        tickvals = tvals),
           yaxis = list(title = "% Eligible Days",
                        range = c(0, 100),
                        tickmode = "array",
                        tickvals = seq(0, 100, 25),
                        ticksuffix = "%",
                        tickfont = list(size = fs)),
           font = list(family = "sans-serif"),
           showlegend = FALSE)
}

## Wrapper function to avoid tidyeval
filter_and_plot <- function(el, name, col, df){
  filter(df, element == el) %>%
    create_plotly_runchart(tracename = name, tracecol = col)
}

## -- Compliance runcharts -----------------------------------------------------
## Create dataset for overall compliance (y/n)
comp_yn_data <- compliance %>%
  dplyr::select(month_cat_short,
                ## Denominators
                icu_day, on_sedation_icu, on_mv_icu,
                family_present_icu, elements_elig,
                ## Numerators
                paste0("comp_", element_suffixes), elements_comp) %>%
  group_by(month_cat_short) %>%
  summarise_all(funs(days = sum), na.rm = TRUE) %>%
  ungroup() %>%
  gather(key = element, value = comp_days, comp_a_days:elements_comp_days) %>%
  mutate(elig_days =
           case_when(element == "comp_b_sat_days" ~ on_sedation_icu_days,
                     element == "comp_b_sbt_days" ~ on_mv_icu_days,
                     element == "comp_f_days" ~ family_present_icu_days,
                     element == "elements_comp_days" ~
                       as.integer(elements_elig_days),
                     TRUE ~ icu_day_days),
         pct_yes = round((comp_days / elig_days) * 100),
         dose_yn = ifelse(element == "elements_comp_days", " dose", ""),
         elig_text =
           case_when(element == "comp_b_sat_days" ~ "ICU days on sedation",
                     element == "comp_b_sbt_days" ~ "ICU days on MV",
                     element == "comp_f_days" ~ "ICU days family present",
                     element == "elements_comp_days" ~ "Elements eligible",
                     TRUE ~ "ICU days"),
         eldays_text = ifelse(element == "elements_comp_days",
                              "Elements", "Days"),
         tt_text = sprintf("Compliance%s: %s%%<br>%s compliant: %s<br>%s: %s",
                           dose_yn, round(pct_yes), eldays_text, comp_days,
                           elig_text, elig_days))

## Create list of all plots
comp_elements <- unique(comp_yn_data$element)
comp_elements <- comp_elements[grep("^comp", comp_elements)]

comp_plots <- purrr::pmap(
  list("el" = comp_elements, "name" = element_tracenames, "col" = element_cols),
  filter_and_plot,
  df = comp_yn_data
)
names(comp_plots) <- comp_elements

## Add a trace for "dose" to overall plot
comp_plots$comp_yn_days <- comp_plots$comp_yn_days %>%
  add_trace(
    data = filter(comp_yn_data, element == "elements_comp_days"),
    x = ~ month_cat_short,
    y = ~ pct_yes,
    name = "Dose of compliance",
    line = list(color = "black", dash = "dot"),
    marker = list(color = "black", size = 6),
    text = ~ tt_text,
    type = "scatter",
    mode = "lines+markers"
  )

## Make one big plot using subplots
## Overall --- C
## Overall --- D
## Overall --- E
## A BSAT BSBT F

comp_horiz <- subplot(comp_plots$comp_a_days, comp_plots$comp_b_sat_days,
                      comp_plots$comp_b_sbt_days, comp_plots$comp_f_days,
                      nrows = 1, shareY = TRUE, margin = 0.01)
comp_vert <- subplot(comp_plots$comp_c_days, comp_plots$comp_d_days,
                     comp_plots$comp_e_days,
                     nrows = 3, shareX = TRUE, margin = 0.04) %>%
  layout(xaxis = list(showticklabels = FALSE))
comp_toprow <- subplot(comp_plots$comp_yn_days, comp_vert,
                       nrows = 1, widths = c(0.75, 0.25))

plotly_comp <- subplot(comp_toprow, comp_horiz,
                       nrows = 2, heights = c(0.75, 0.25), margin = 0.05)

## -- Performance runcharts ----------------------------------------------------
## Create dataset for overall performance (y/n)
perf_yn_data <- compliance %>%
  dplyr::select(month_cat_short,
                ## Denominators
                icu_day, on_sedation_icu, on_mv_icu,
                family_present_icu, elements_elig,
                ## Numerators
                paste0("perf_", element_suffixes), elements_perf) %>%
  group_by(month_cat_short) %>%
  summarise_all(funs(days = sum), na.rm = TRUE) %>%
  ungroup() %>%
  gather(key = element, value = perf_days, perf_a_days:elements_perf_days) %>%
  mutate(elig_days =
           case_when(element == "perf_b_sat_days" ~ on_sedation_icu_days,
                     element == "perf_b_sbt_days" ~ on_mv_icu_days,
                     element == "perf_f_days" ~ family_present_icu_days,
                     element == "elements_perf_days" ~
                       as.integer(elements_elig_days),
                     TRUE ~ icu_day_days),
         pct_yes = round((perf_days / elig_days) * 100),
         dose_yn = ifelse(element == "elements_perf_days", " dose", ""),
         elig_text =
           case_when(element == "perf_b_sat_days" ~ "ICU days on sedation",
                     element == "perf_b_sbt_days" ~ "ICU days on MV",
                     element == "perf_f_days" ~ "ICU days family present",
                     element == "elements_perf_days" ~ "Elements eligible",
                     TRUE ~ "ICU days"),
         eldays_text = ifelse(element == "elements_perf_days",
                              "Elements", "Days"),
         tt_text = sprintf("Performance%s: %s%%<br>%s performed: %s<br>%s: %s",
                           dose_yn, round(pct_yes), eldays_text, perf_days,
                           elig_text, elig_days))

## Create list of all plots
perf_elements <- unique(perf_yn_data$element)
perf_elements <- perf_elements[grep("^perf", perf_elements)]

perf_plots <- purrr::pmap(
  list("el" = perf_elements, "name" = element_tracenames, "col" = element_cols),
  filter_and_plot,
  df = perf_yn_data
)
names(perf_plots) <- perf_elements

## Add a trace for "dose" to overall plot
perf_plots$perf_yn_days <- perf_plots$perf_yn_days %>%
  add_trace(
    data = filter(perf_yn_data, element == "elements_perf_days"),
    x = ~ month_cat_short,
    y = ~ pct_yes,
    name = "Dose of performance",
    line = list(color = "black", dash = "dot"),
    marker = list(color = "black", size = 6),
    text = ~ tt_text,
    type = "scatter",
    mode = "lines+markers"
  )

## Make one big plot using subplots
perf_horiz <- subplot(perf_plots$perf_a_days, perf_plots$perf_b_sat_days,
                      perf_plots$perf_b_sbt_days, perf_plots$perf_f_days,
                      nrows = 1, shareY = TRUE, margin = 0.01)
perf_vert <- subplot(perf_plots$perf_c_days, perf_plots$perf_d_days,
                     perf_plots$perf_e_days,
                     nrows = 3, shareX = TRUE, margin = 0.04) %>%
  layout(xaxis = list(showticklabels = FALSE))
perf_toprow <- subplot(perf_plots$perf_yn_days, perf_vert,
                       nrows = 1, widths = c(0.75, 0.25))

plotly_perf <- subplot(perf_toprow, perf_horiz,
                       nrows = 2, heights = c(0.75, 0.25), margin = 0.05)

```

## `r figure_nums("run_comp")`

For overall compliance, the dotted line indicates **dose** of compliance; the
solid line indicates total (yes/no) compliance.

```{r print_comprun, fig.width = 7, fig.height = 5}
plotly_comp %>%
  layout(annotations = title_list)

```

## `r figure_nums("run_perf")`

For overall performance, the dotted line indicates **dose** of performance; the
solid line indicates total (yes/no) performance.

```{r print_perfrun, fig.width = 7, fig.height = 5}
plotly_perf %>%
  layout(annotations = title_list)

```

## `r figure_nums("run_meds")`

`r figure_nums("run_meds", display = "cite")` shows the percentage of ICU days
with each medication used over time.

```{r runchart_meds, fig.width = 7, fig.height = 5}
## Vector of medication names
med_names <- c("Benzodiazepines", "Opioids", "Propofol", "Dexmedetomidine")

prop_yes <- function(x){
  mean(x == "Yes", na.rm = TRUE) * 100
}
days_yes <- function(x){
  sum(x == "Yes", na.rm = TRUE)
}

## Note: Tried to also do % of days on continuous/intermittent sedation,
## but proportions were >1, I assume because patients received these medications
## PRN as well as continuously.

rundata_meds <- compliance %>%
  filter(icu_day) %>%
  dplyr::select(month_cat_short, matches("^rcvd\\_[a-z]+\\_icu$")) %>%
  group_by(month_cat_short) %>%
  summarise_all(funs(days = days_yes)) %>%
  ungroup() %>%
  gather(key = med, value = days_med, matches("^rcvd")) %>%
  left_join(
    distinct(dplyr::select(comp_yn_data, month_cat_short, icu_day_days)),
    by = "month_cat_short") %>%
  mutate(
    med = gsub("^rcvd\\_", "", gsub("\\_icu\\_days$", "", med)),
    med_f = case_when(med == "benzo" ~ "Benzodiazepines",
                      med == "dex" ~ "Dexmedetomidine",
                      med == "opioid" ~ "Opioids",
                      med == "propofol" ~ "Propofol",
                      TRUE ~ "Other"),
    prop_med = round((days_med / icu_day_days) * 100),
    tt_text = sprintf("Received on %s / %s ICU days", days_med, icu_day_days)
  )

## -- Function to create a plotly object for each medication -------------------
create_plotly_medchart <- function(df = rundata_meds, tracename, tracecol){
  df <- df %>% filter(med_f == tracename)
  
  ts <- 14
  fs <- 10
  tvals <- c("BL", paste0("I", seq(1, 13, 2)))
  ms <- 4

  plot_ly(
    data = df,
    x = ~ month_cat_short,
    y = ~ prop_med,
    name = tracename,
    line = list(color = magglass_colors[tracecol]),
    marker = list(color = magglass_colors[tracecol], size = ms),
    text = ~ tt_text,
    type = "scatter",
    mode = "lines+markers"
  ) %>%
    layout(titlefont = list(size = ts),
           xaxis = list(title = "",
                        tickfont = list(size = fs),
                        tickmode = "array",
                        tickvals = tvals),
           yaxis = list(title = "% ICU Days",
                        range = c(0, 100),
                        tickmode = "array",
                        tickvals = seq(0, 100, 25),
                        ticksuffix = "%",
                        tickfont = list(size = fs)),
           font = list(family = "sans-serif"),
           showlegend = FALSE)
}

runchart_med_args <- list(
  "tracename" = med_names, "tracecol" = c("b", "c", "d", "f")
)

runcharts_meds <- pmap(.l = runchart_med_args, .f = create_plotly_medchart)
names(runcharts_meds) <- med_names

runchart_meds <- subplot(
  runcharts_meds,
  nrows = 2,
  shareX = TRUE, shareY = TRUE,
  titleX = FALSE,
  margin = c(0.01, 0.01, 0.05, 0.05)
)

## Create list of plot titles, X/Y coordinates
runchart_meds_xes <- c(0.01, 0.51, 0.01, 0.51)
runchart_meds_ys <- c(1.05, 1.05, 0.51, 0.51)

med_title_list <- pmap(.l = list("title" = med_names,
                             "xval" = runchart_meds_xes,
                             "yval" = runchart_meds_ys),
                   .f = make_annotate_item,
                   title_size = 14)

runchart_meds %>% layout(annotations = med_title_list)

```

# In-ICU Outcomes

The following sections look at the relationships between daily ABCDEF bundle compliance/performance and the following outcomes while the patient is still in
the ICU:

- Occurrence of delirium
- Occurrence of coma
- Mechanical ventilation
- Significant pain
- Physical restraints

For example, these models will help us answer the question "*Among patients
still alive and in the ICU*, is total ABCDEF bundle compliance on a given ICU day associated with lower likelihood of being on mechanical ventilation the
following day?"

## Analysis Method and Covariates

The relationship between ABCDEF bundle compliance and performance on a given ICU day and each of the above outcomes the *following* ICU day will be assessed
using logistic regression models; variance will be adjusted using Huber-White
sandwich estimation clustered by patient, to account for within-subject
correlation among days from the same patient. Continuous variables will be
allowed to have a nonlinear association with our outcomes using restricted cubic
splines. For each outcome, we will have four different models using the
following ABCDEF-related exposures:

- Total bundle compliance, yes/no
- Dose of compliance (# elements compliant / # elements eligible)
- Total bundle performance, yes/no
- Dose of performance (# elements performed / # elements eligible)

For more details on compliance and performance, please see
[Definitions](#definitions).

Each model will adjust for the following potential confounders (please see
[Variable Calculation](#variables) for more details):

- Demographics
    - Age category
    - Sex
    - Race
    - Ethnicity (Hispanic vs non-Hispanic)
    - BMI
    - Residency prior to admission (home vs facility)
    - Mobility prior to admission (no restrictions vs any)
- Admission characteristics
    - Admission diagnosis category
    - Hospital type (community vs teaching)
    - ICU type
- Daily ICU characteristics on day of ABCDEF bundle measurement
    - On benzos
    - On opioids
    - On propofol
    - On dex
    - On typical and/or atypical antipsychotics
    - On comfort care
    - On MV
    - Coma
    - Delirium, for delirium outcome only (there is too much missing data to justify this covariate for other outcomes)

## Patient Inclusion & Missing Data

```{r model_datamgmt}
## -- Create data set for all "vs XXX the following day" models ----------------
## Vector of variables for which we'll need "xxx tomorrow" versions
lead_vars <- c("icu_day", "on_mv_icu_f", "coma_icu", "on_restraints_icu",
               "sigpain_icu", "delirium_icu")

## Vector of baseline covariates
base_vars <- c("age_cat_mod", "sex_f", "race_cat_mod", "hisp_cat_mod", "bmi",
               "mob_preadmit", "primary_admit", "home_preadmit",
               "icu_type_comb", "hosp_type")

df_logmods <- compliance %>%
  dplyr::select(id, icu_day, redcap_event_name_f,
                comfort_care_icu, on_sedation_icu_f, rcvd_benzo_icu,
                rcvd_opioid_icu, rcvd_propofol_icu, rcvd_dex_icu,
                rcvd_antipsyc_icu,
                on_mv_icu_f, coma_icu,
                on_restraints_icu, sigpain_icu, delirium_icu,
                comp_yn_f, perf_yn_f, comp_prop, perf_prop) %>%
  ## Create "tomorrow" variables
  group_by(id) %>%
  mutate_at(vars(one_of(lead_vars)), funs(tmw = lead)) %>%
  ungroup() %>%
  ## Filter - these models will only use days when patients were in the ICU
  ## both "today" and "tomorrow"
  filter(icu_day & icu_day_tmw) %>%
  ## Merge on baseline covariates
  right_join(dplyr::select(demog, id, one_of(base_vars)), ., by = "id")

# ## Check a few patients
# ckids <- sample(unique(compliance$id), size = 10)
# print_vars <- map(lead_vars, ~ c(., paste0(., "_tmw"))) %>% flatten_chr
# print(subset(df_logmods, id %in% ckids)[,c("id", "redcap_event_name_f",
#                                            print_vars)],
#       width = Inf)

npts_total <- length(unique(demog$id))
npts_logmods <- length(unique(df_logmods$id))
pctpts_logmods <- (npts_logmods / npts_total) * 100
ndays_logmods <- nrow(df_logmods)

# ## Common sense check for % patients included in these models
# ck_icudays <- compliance %>%
#   group_by(id) %>%
#   summarise(n_icu_days = sum(icu_day, na.rm = TRUE)) %>%
#   ungroup()

```

We started with `r format(npts_total, big.mark = ",")` patients enrolled in the Collaborative; among these, only `r format(npts_logmods, big.mark = ",")` (`r round(pctpts_logmods)`%) had two *consecutive* days fully in the ICU and are
thus eligible to be included in these models. Thus, it is important to note that
these results may only be generalizable to this subset of patients, who may be
different in meaningful ways from patients who had no or only one day in their
Collaborative ICU admission.

Among those `r format(npts_logmods, big.mark = ",")` patients with at least
two consecutive ICU days, we have `r format(ndays_logmods, big.mark = ",")`
patient-days eligible for inclusion. Some of these days will be excluded due to
missing outcome and/or covariate data; the number of patients included in each
model will be specified with model results.

### Description of Missingness

Among patient-days eligible for inclusion in these models, most *covariates/confounders* had fairly low rates of missingness, with the exception
of mobility level prior to Collaborative admission (`r round(mean(is.na(df_logmods$mob_preadmit)) * 100)`% of patient-days missing). However, several of our *outcomes* which require assessments to evaluate had high rates of missingness, as shown below. A reference line at 5% missingness is
included below; below this level, we typically don't worry much about missingness.

```{r logmods_missing, fig.height = 6, fig.width = 5}
gg_miss_var(df_logmods %>% dplyr::select(-id), show_pct = TRUE) +
  geom_hline(yintercept = 5, color = "grey50", linetype = "dotted") +
  labs(title = "Proportion of Patient-Days with Missing Values, In-ICU Outcomes and Covariates",
       x = "")

```

### Strategy for Handling Missingness

Often, we would use multiple imputation to handle missingness of a concerning amount; however, this method's effectiveness depends on the *available* data to reliably predict missing values. For the following reasons, we are choosing to limit our analyses to complete cases and not perform multiple imputation:

- Due to differences between units and limits on data collection in deidentified
studies, we are missing some key information (eg, severity of illness) which
would help predict missing values.
- In longitudinal data analysis, multiple imputation for both baseline (ie, should be the same value for every patient) and time-varying (can change daily) variables is complex and time-consuming.
- Our rates of missingness are generally low, with a few important exceptions as
noted.

### Potential Bias from Missingness

In our case, the biggest drawback of complete case analysis is that our results
could be biased due to differences in the patient-days we would *like* to
include and patients we are *able* to include. This is a limitation of our study
and will need to be kept in mind as we interpret our results. It will be more of
an issue for some outcomes than others: For example, mechanical ventilation
status is readily available in most EMR systems and therefore has low rates of
missingness, so this bias isn't too much of a concern. But because delirium
requires a proactive assessment that is not yet usual care in all units, it has
much higher rates of missingness and is therefore more subject to bias.

After looking at missingness in detail, the most problematic aspect of missingness in our study is that so much missingness relates to both our exposures (compliance/performance) and our outcomes, specifically delirium, coma, and pain. (For example, if the patient didn't have a pain assessment, they were both not compliant on the ABCDEF bundle *and* are missing a pain outcome.) So by definition, the patients we include in models for those outcomes are likely to have better compliance and performance on the ABCDEF bundle than patients who are excluded for missing data.

Other less concerning ways that patients with incomplete data differ from those with complete data include:

- Slightly more likely to be of "other" or multiple races or not have race documented in the EMR; to be Hispanic; and to speak a language other than English
- Slightly more likely to be in a facility prior to admission
- Slightly more likely to be in cardiac/surgical ICU and less likely to be in medical
- More likely to be have neuro, trauma diagnoses and less likely to have Other
- Less likely to have mobility performed
- More likely to be on both MV and sedation
- Slightly more likely to be on restraints, benzodiazepines and propofol
- Slightly less likely to be on opioids and dexmedetomidine

To save space, more details are currently hidden from view; however, if these are needed they can be easily provided.

```{r logmods_compare_missing_prep, results = "hide"}
## -- Create data frame to compare days with complete vs incomplete data -------
## We want to compare not only model covariates/outcomes, but also other
## potentially important factors not included in models (eg, restraints, highest
## level of mobility...)
## THEREFORE: Merge important baseline + compliance variables and add indicator
## for whether day had any missingness for these models.

## 1. Create indicators for missingness among model covariates/outcomes
logmods_outcomes <- c("delirium_icu_tmw", "coma_icu_tmw",
                      "sigpain_icu_tmw", "on_mv_icu_f_tmw")
logmods_covars_base <- c("age_cat_mod", "sex_f", "race_cat_mod", "hisp_cat_mod",
                         "bmi", "mob_preadmit", "home_preadmit", "hosp_type",
                         "primary_admit", "icu_type_comb")
logmods_covars_daily <- c("comfort_care_icu", "rcvd_benzo_icu",
                          "rcvd_opioid_icu", "rcvd_propofol_icu",
                          "rcvd_dex_icu", "rcvd_antipsyc_icu", "on_mv_icu_f",
                          "coma_icu")
logmods_exposures <- c("comp_yn_f", "perf_yn_f", "comp_prop", "perf_prop")
logmods_covars <-
  c(logmods_covars_base, logmods_covars_daily, logmods_exposures)

df_logmods_missing <- df_logmods
df_logmods_missing$comp_outcomes <-
  rowSums(is.na(df_logmods_missing[ , logmods_outcomes])) == 0
df_logmods_missing$comp_covars <-
  rowSums(is.na(df_logmods_missing[ , logmods_covars])) == 0

df_logmods_missing$comp_data <-
  with(df_logmods_missing, comp_outcomes & comp_covars)
df_logmods_missing$comp_data_f <- with(df_logmods_missing, {
  factor(as.numeric(comp_data),
         levels = 0:1,
         labels = c("Incomplete data", "Complete data"))
})

## 2. Merge on other baseline and daily variables; recode long factor levels
df_logmods_missing <- df_logmods_missing %>%
  left_join(dplyr::select(demog, id, english_f, ad_directive_f), by = "id") %>%
  left_join(dplyr::select(
    compliance,
    id, redcap_event_name_f, mobilityperformed_f, family_present_icu_f,
    had_painasmt_icu, had_sedasmt_icu, had_delasmt_icu, elements_elig
  ),
  by = c("id", "redcap_event_name_f")) %>%
  ## Recode long factor levels
  mutate(
    comp_yn_f = fct_recode(comp_yn_f, Comp = "Compliant", Non = "Noncompliant"),
    perf_yn_f = fct_recode(perf_yn_f,
                           Perf = "Performed", Not = "Not performed"),
    english_f = fct_recode(
      english_f,
      Eng = "English Speaking", Other = "Non-English Speaking"
    ),
    race_cat_mod = fct_recode(
      race_cat_mod,
      "Black AA" = "Black/African-American",
      "AI, AK, HI" = "Amer Indian/AK Native or HI/Pacific Isl",
      Other = "Other race, multiple races, or not specified"
    ),
    hisp_cat_mod = fct_recode(
      hisp_cat_mod, Hisp = "Hispanic", Non = "Non-Hispanic"
    ),
    icu_type_comb = fct_recode(
      icu_type_comb,
      Mixed = "Mixed medical/surgical",
      Med = "Medical",
      "Surg/Trauma" = "Surgical/trauma",
      "Cardiac/Surg" = "Cardiac/surgical"
    ),
    primary_admit = fct_recode(
      primary_admit,
      Sepsis = "Sepsis/septic shock or ARDS",
      Resp = "Respiratory",
      Neuro = "Neurologic",
      GU = "Genitourinary",
      "OD/WD" = "Overdose/withdrawal"
    ),
    family_present_icu_f = fct_recode(
      family_present_icu_f, No = "Not documented present", Yes = "Present"
    ),
    home_preadmit = fct_recode(
      home_preadmit, No = "Facility pre-admission", Yes = "Home pre-admission"
    ),
    mob_preadmit = fct_recode(
      mob_preadmit,
      Unrestr = "No restrictions pre-admission",
      Restr = "Mobility restricted pre-admission"
    ),
    had_delasmt_icu = fct_recode(
      had_delasmt_icu, Yes = ">=1 assessment", No = "No assessment"
    ),
    had_painasmt_icu = fct_recode(
      had_painasmt_icu, Yes = ">=1 assessment", No = "No assessment"
    ),
    had_sedasmt_icu = fct_recode(
      had_sedasmt_icu, Yes = ">=1 assessment", No = "No assessment"
    ),
    mobilityperformed_f = fct_recode(
      mobilityperformed_f,
      Contra = "No, patient failed the safety screen/contraindicated",
      No = "Not performed /not documented"
    ),
    on_mv_icu_f = fct_recode(
      on_mv_icu_f, No = "Not on MV", Yes = "Received MV"
    ),
    on_mv_icu_f_tmw = fct_recode(
      on_mv_icu_f_tmw, No = "Not on MV", Yes = "Received MV"
    ),
    on_sedation_icu_f = fct_recode(
      on_sedation_icu_f,
      Yes = "Continuous/intermittent sedation",
      "No/PRN" = "No or PRN sedation only"
    ),
    sigpain_icu = fct_recode(
      sigpain_icu,
      No = "No significant pain",
      Yes = "Significant pain (self-report or BPS)"
    ),
    sigpain_icu_tmw = fct_recode(
      sigpain_icu_tmw,
      No = "No significant pain",
      Yes = "Significant pain (self-report or BPS)"
    )
  )

## For categorical variables, we'll do faceted dotcharts
df_logmods_missing_plotcat <- df_logmods_missing %>%
  dplyr::select(-one_of("id", "redcap_event_name_f", "bmi", "icu_day",
                        "icu_day_tmw", "comp_prop", "perf_prop",
                        "comp_outcomes", "comp_covars",
                        "comp_data", "elements_elig")) %>%
  gather(key = varname, value = varvalue, -comp_data_f) %>%
  group_by(comp_data_f, varname, varvalue) %>%
  summarise(varvalue_n = n()) %>%
  mutate(varvalue_prop = ifelse(
    comp_data_f == "Complete data",
    varvalue_n / sum(df_logmods_missing$comp_data),
    varvalue_n / sum(!df_logmods_missing$comp_data))) %>%
  ungroup()

logmods_miss_cat <-
  ggplot(data = df_logmods_missing_plotcat,
         aes(x = varvalue, y = varvalue_prop, fill = comp_data_f)) +
  facet_wrap(~ varname, scales = "free_x") +
  geom_bar(stat = "identity", position = "dodge", width = 0.25) +
  scale_fill_manual(values = as.character(magglass_colors[c("c", "f")])) +
  scale_y_continuous(name = "Proportion of Patient-Days",
                     breaks = seq(0, 1, 0.25),
                     labels = paste0(seq(0, 1, 0.25) * 100, "%")) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.direction = "horizontal",
        legend.title = element_blank(),
        axis.text.x = element_text(size = 6, angle = 45, hjust = 1, vjust = 1))

## For continuous-ish variables, we'll do dodged histograms
df_logmods_missing_plotcont <- df_logmods_missing %>%
  dplyr::select(comp_data_f, comp_prop, perf_prop, elements_elig) %>%
  gather(key = varname, value = varvalue, -comp_data_f) %>%
  mutate(varname = fct_relevel(
    varname, "elements_elig", "comp_prop", "perf_prop"
  )
  )

logmods_miss_cont <-
  ggplot(data = df_logmods_missing_plotcont,
         aes(x = varvalue, fill = comp_data_f)) +
  facet_wrap(~ varname, scales = "free") +
  geom_histogram(position = "dodge") +
  scale_fill_manual(values = as.character(magglass_colors[c("c", "f")])) +
  scale_x_continuous(name = "") +
  scale_y_continuous(name = "Frequency") +
  theme_minimal() +
  theme(legend.position = "top",
        legend.direction = "horizontal",
        legend.title = element_blank(),
        axis.text.x = element_text(size = 8, angle = 45, hjust = 1, vjust = 1))
  
```

```{r logmods_missing_cat, fig.height = 8, fig.width = 5}
# logmods_miss_cat

```

```{r logmods_missing_cont, fig.height = 3, fig.width = 5}
# logmods_miss_cont

```

```{r logmod_prep, results = "hide"}
## Set datadist. We must always set datadist. Set it to the mother dataset.
dd_logmods <- datadist(df_logmods)
options(datadist = "dd_logmods")

## -- Function to fit logistic regression model --------------------------------
fit_daily_lrm <- function(
  outcome = c("on_mv_icu_f_tmw", "coma_icu_tmw",
              "delirium_icu_tmw", "on_restraints_icu_tmw"),
  exposure = c("comp_yn_f", "comp_prop", "perf_yn_f", "perf_prop"),
  covars = c(logmods_covars_base, logmods_covars_daily), df = df_logmods){
  
  ## -- Set model formula ------------------------------------------------------
  ## Add delirium/restraints as a covariate for those outcomes
  if(outcome %in% c("delirium_icu_tmw", "on_restraints_icu_tmw")){
    covars <- c(covars, gsub("_tmw", "", outcome, fixed = TRUE))
  }
  
  ## Add exposure to RHS
  covars <- c(covars, exposure)
  
  ## Make BMI, proportion of compliance/performance nonlinear terms
  covars <- str_replace(
    covars, "(^bmi|comp\\_prop|perf\\_prop$)", "rcs\\(\\1, 5\\)"
  )
  
  ## Put RHS together
  rhs <- paste(covars, collapse = " + ")
  
  ## Assemble entire formula
  modform <- as.formula(paste(outcome, rhs, sep = " ~ "))
  
  ## -- Fit model using lrm, then adjust SEs using robcov() --------------------
  mod <- lrm(modform, data = df, x = TRUE, y = TRUE) %>%
    robcov(cluster = df$id)
  
  return(mod)
}

# ## Test function on a couple of exposures
# 
# df_logmod_mv <- df_logmods %>%
#   dplyr::select(id, on_mv_icu_f_tmw, one_of(logmods_covars))
# df_logmod_mv$include <-
#   rowSums(is.na(df_logmod_mv[, 1:ncol(df_logmod_mv)])) == 0
# 
# mv_compyn_fxn <- fit_daily_lrm(
#   outcome = "on_mv_icu_f_tmw",
#   exposure = "comp_yn_f",
#   df = subset(df_logmod_mv, include)
# )
# mv_compyn_man <- lrm(
#   on_mv_icu_f_tmw ~
#     ## Baseline/ICU admission
#     age_cat_mod + sex_f + race_cat_mod + hisp_cat_mod + mob_preadmit +
#     home_preadmit + primary_admit + icu_type_comb + hosp_type + rcs(bmi, 5) +
#     ## Daily
#     rcvd_benzo_icu + rcvd_opioid_icu + rcvd_propofol_icu + rcvd_dex_icu +
#     rcvd_antipsyc_icu + on_mv_icu_f + coma_icu + comfort_care_icu +
#     ## Exposure
#     comp_yn_f,
#   data = subset(df_logmod_mv, include),
#   x = TRUE, y = TRUE
# ) %>%
#   robcov(cluster = subset(df_logmod_mv, include)$id)
# 
# anova(mv_compyn_fxn)
# anova(mv_compyn_man)
# 
# mv_compdose_fxn <- fit_daily_lrm(
#   outcome = "on_mv_icu_f_tmw",
#   exposure = "comp_prop",
#   df = subset(df_logmod_mv, include)
# )
# mv_compdose_man <- lrm(
#   on_mv_icu_f_tmw ~
#     ## Baseline/ICU admission
#     age_cat_mod + sex_f + race_cat_mod + hisp_cat_mod + mob_preadmit +
#     home_preadmit + primary_admit + icu_type_comb + hosp_type + rcs(bmi, 5) +
#     ## Daily
#     rcvd_benzo_icu + rcvd_opioid_icu + rcvd_propofol_icu + rcvd_dex_icu +
#     rcvd_antipsyc_icu + on_mv_icu_f + coma_icu + comfort_care_icu +
#     ## Exposure
#     rcs(comp_prop, 5),
#   data = subset(df_logmod_mv, include),
#   x = TRUE, y = TRUE
# ) %>%
#   robcov(cluster = subset(df_logmod_mv, include)$id)
# 
# anova(mv_compdose_fxn)
# anova(mv_compdose_man)

## -- Function to extract odds ratios from a given model fit -------------------
get_daily_ors <- function(modobj,
                          exposure = c("comp_yn_f", "comp_prop",
                                       "perf_yn_f", "perf_prop"),
                          df = df_logmods){
  if(exposure == "comp_yn_f"){
    reflevel <- "Noncompliant"
    complevels <- levels(df[,exposure])
  } else if(exposure == "perf_yn_f"){
    reflevel <- "Not performed"
    complevels <- levels(df[,exposure])
  } else{
    reflevel <- 0
    complevels <- as.numeric(
      quantile(
        c(df_logmods$comp_prop, df_logmods$perf_prop),
        probs = seq(0, 1, 0.2),
        na.rm = TRUE
      )
    )
  }
  
  rms_calc_comparisons(
    rmsObj = modobj,
    vname = exposure,
    df = df,
    refVal = reflevel,
    compVals = complevels
  )
}

## -- Function to extract p-value for an exposure from a given model fit -------
get_daily_p <- function(modobj,
                        exposure = c("comp_yn_f", "comp_prop",
                                     "perf_yn_f", "perf_prop")){
  anova(modobj)[exposure, "P"]
}

## -- Function to get ORs/P for a given model fit into tibble ------------------
daily_outexp_ors <- function(modobj, exposure, df = df_logmods){
  ors <- get_daily_ors(modobj = modobj, exposure = exposure, df = df)
  pval <- get_daily_p(modobj = modobj, exposure = exposure)
  ors$pval <- pval
  ors
}

## -- Function to get predicted probs for a continuous exposure into tibble ----
get_daily_probs <- function(modobj,
                            exposure = c("comp_prop", "perf_prop"),
                            df = df_logmods){
  tmp <- eval(
    parse(text = sprintf("Predict(modobj, %s = NA, fun = plogis)", exposure))
  ) %>%
    as_tibble() %>%
    dplyr::select(matches(exposure), yhat, lower, upper) %>%
    mutate(exposure = exposure)
  names(tmp) <- gsub(exposure, "prop_done", names(tmp), fixed = TRUE)
  tmp
}

## -- Wrapper function for a specified outcome: --------------------------------
## 1. Fit logistic model (returned as "modobj")
## 2. Get df of odds ratios + p-value (returned as "ors")
## 3. If continuous, get df of predicted probabilities (returned as "probs")
fit_results_lrm <- function(outcome = c("on_mv_icu_f_tmw",
                                        "coma_icu_tmw",
                                        "delirium_icu_tmw",
                                        "on_restraints_icu_tmw"),
                            exposure = c("comp_yn_f", "comp_prop",
                                         "perf_yn_f", "perf_prop"),
                            covars = c(logmods_covars_base,
                                       logmods_covars_daily),
                            df = df_logmods){
  
  mod <- fit_daily_lrm(
    outcome = outcome, exposure = exposure, covars = covars, df = df
  )
  
  ors <- daily_outexp_ors(mod, exposure, df)
  
  if(exposure %in% c("comp_prop", "perf_prop")){
    probs <- get_daily_probs(mod, exposure, df)
  } else{
    probs <- NULL
  }
  
  return(list("mod" = mod, "ors" = ors, "probs" = probs))
}

## -- Wrapper to do all exposures for a given outcome --------------------------
outcome_results_lrm <- function(outcome,
                                covars = c(logmods_covars_base,
                                           logmods_covars_daily),
                                df = df_logmods){
  
  ## Get list with results of fit_results_lrm() for each exposure
  modlist <- map(c("comp_yn_f", "comp_prop", "perf_yn_f", "perf_prop"),
                 ~ fit_results_lrm(outcome = outcome,
                                   exposure = .,
                                   covars = covars, df = df))
  
  ## Put like results together (ORs, predicted probs)
  or_df <- map_df(modlist, "ors")
  probs_df <- map_df(modlist, "probs")
  
  return(list("ors" = or_df, "probs" = probs_df))
}

```

## ABCDEF Bundle vs Mechanical Ventilation

We used a logistic regression model with Huber-White sandwich estimation, clustered by patient, to assess the relationships of our measures of compliance and performance of the ABCDEF Bundle on a given day with the likelihood of being on mechanical ventilation the following day.

```{r mvmods, results = "hide"}
## -- Create dataset with only complete records --------------------------------
mv_vars <- c("on_mv_icu_f_tmw", logmods_covars_base, logmods_covars_daily)
df_logmod_mv <- df_logmods
df_logmod_mv$include <- rowSums(is.na(df_logmod_mv[,mv_vars])) == 0

## Summarize missing data before we dump records
miss_var_mv <- miss_var_summary(subset(df_logmod_mv, !include)) %>%
  filter(percent > 0 & variable %in% mv_vars)

## Remove records with incomplete data
df_logmod_mv <- subset(df_logmod_mv, include)

mv_results <-
  outcome_results_lrm(outcome = "on_mv_icu_f_tmw", df = df_logmod_mv)

## -- (Will be a) Function to plot odds ratios for compliance & performance ----
## Info for subtitle: Total number of patients, patient-days included; split
## between outcome + non-outcome
mv_pts <- length(unique(df_logmod_mv$id))
mv_days <- nrow(df_logmod_mv)
mv_days_outcome <- sum(df_logmod_mv$on_mv_icu_f_tmw == "Received MV")
mv_days_nooutcome <- sum(!(df_logmod_mv$on_mv_icu_f_tmw == "Received MV"))

mv_subtitle <- sprintf(
  "%s patients included, with a total of %s records\n%s records had MV the following day; %s did not",
  format(mv_pts, big.mark = ","),
  format(mv_days, big.mark = ","),
  format(mv_days_outcome, big.mark = ","),
  format(mv_days_nooutcome, big.mark = ",")
)

ors <- mv_results$ors %>%
  ## We don't want to plot reference levels
  filter(!is.ref) %>%
  mutate(
    ## Prep for separating into indicators for comp vs perf, y/n vs dose
    variable = gsub("\\_f$", "", variable),
    ## We'll order the Y axis labels by this variable later:
    yval = ifelse(comp.c %in% c("Performed", "Compliant"), 0,
                  floor((comp + 0.01) * 100)),
    ## Create text for Y axis labels: comparison + P-value
    ylabel = ifelse(comp.c %in% c("Performed", "Compliant"),
                    "Yes vs No",
                    sprintf("%s%% vs %s%%",
                            trimws(rndformat(comp * 100, 0)),
                            trimws(rndformat(ref * 100, 0)))),
    ## Order so that 100% is on top
    ylabel = fct_reorder(ylabel, yval),
    ## Create OR/CI text to place inside figure
    or_text = sprintf(
      "%s (%s, %s)", rndformat(effect), rndformat(lcl), rndformat(ucl)
    )
  ) %>%
  ## Get indicators for comp vs perf, y/n vs dose
  separate(variable, into = c("cp", "yn_prop"), sep = "_") %>%
  ## Move y/n to top; add p-values to Compliance/Performance labels
  mutate(
    yn_prop = factor(ifelse(yn_prop == "yn", 1, 2),
                     levels = 1:2, labels = c("Overall", "Dose")),
    cp = factor(
      ifelse(cp == "comp", 1, 2),
      levels = 1:2,
      labels = c(
        sprintf(
          "Compliance\n\nP, overall: %s; P, dose: %s",
          formatp(subset(mv_results$ors, variable == "comp_yn_f")$pval[1]),
          formatp(subset(mv_results$ors, variable == "comp_prop")$pval[1])
        ),
        sprintf(
          "Performance\n\nP, overall: %s; P, dose: %s",
          formatp(subset(mv_results$ors, variable == "perf_yn_f")$pval[1]),
          formatp(subset(mv_results$ors, variable == "perf_prop")$pval[1])
        )
      )
    )
  )

mvplot_ors <- ggplot(data = ors, aes(x = effect, y = ylabel)) +
  facet_grid(yn_prop ~ cp, scales = "free_y", space = "free_y") +
  geom_segment(aes(x = lcl, xend = ucl, yend = ylabel, colour = cp)) +
  geom_point(aes(colour = cp)) +
  geom_text(aes(label = or_text),
            x = -0.55, size = 3, hjust = 0, colour = "grey15") +
  geom_vline(xintercept = 1, colour = "grey70", linetype = "solid", size = 1) +
  scale_x_continuous(name = "Adjusted Odds Ratio (95% Confidence Interval)",
                     limits = c(-0.5, 1.0),
                     breaks = seq(0, 1, 0.2)) +
  scale_y_discrete(name = "") +
  scale_colour_manual(values = as.character(magglass_colors[c("f", "c")])) +
  labs(# title = "ABCDEF Bundle vs Mechanical Ventilation",
       # subtitle = mv_subtitle,
       caption = paste0("\nOdds ratios below 1 are favorable, indicating a lower likelihood of the outcome the following day.\n\n", mv_subtitle)) +
  theme_minimal() +
  theme(legend.position = "none",
        strip.text = element_text(face = "bold"),
        strip.background = element_rect(colour = "grey80", fill = "grey90"),
        axis.title.x = element_text(vjust = 0),
        panel.background = element_rect(colour = "grey80", fill = NA),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank(),
        plot.subtitle = element_text(size = 8, face = "italic"),
        plot.caption = element_text(size = 8, face = "italic"))

## -- (Will be a) Function to plot predicted probs for comp/perf doses ---------
probs <- mv_results$probs %>%
  mutate(cp = factor(ifelse(exposure == "comp_prop", 1, 2),
                     levels = 1:2, labels = c("Compliance", "Performance")))

tmp <- df_logmod_mv %>%
  dplyr::select(comp_prop, perf_prop, on_mv_icu_f_tmw) %>%
  gather(key = exposure, value = prop_done, comp_prop, perf_prop) %>%
  mutate(yhat = as.numeric(on_mv_icu_f_tmw == "Received MV"),
         cp = factor(ifelse(exposure == "comp_prop", 1, 2),
                     levels = 1:2, labels = c("Compliance", "Performance")))

mvplot_probs <- ggplot(data = probs, aes(x = prop_done, y = yhat)) +
  facet_wrap( ~ cp, nrow = 1) +
  geom_point(aes(x = prop_done, y = yhat, colour = cp),
             position = position_jitter(height = 0.05, width = 0.05),
             alpha = 0.01,
             data = tmp) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = cp), alpha = 0.3) +
  geom_line(aes(colour = cp)) +
  scale_x_continuous(name = "Percent of Eligible Bundle Elements Done",
                     limits = 0:1,
                     breaks = seq(0, 1, 0.2),
                     labels = paste0(seq(0, 1, 0.2) * 100, "%")) +
  scale_y_continuous(name = "Adjusted Probability of MV the Following Day",
                     limits = 0:1,
                     breaks = seq(0, 1, 0.2),
                     labels = paste0(seq(0, 1, 0.2) * 100, "%")) +
  scale_fill_manual(values = as.character(magglass_colors[c("f", "c")])) +
  scale_colour_manual(values = as.character(magglass_colors[c("f", "c")])) +
  labs(# title = "ABCDEF Bundle Dose vs Mechanical Ventilation",
       subtitle = mv_subtitle,
       caption = paste0("\nLower probabilities are favorable, indicating a lower likelihood of the outcome the following day.\n\nPoints above are unadjusted, raw data, where patients on MV the following day are at 100% and patients not on MV are at 0%.\n\n", mv_subtitle)) +
  theme_minimal() +
  theme(legend.position = "none",
        strip.text = element_text(face = "bold"),
        strip.background = element_rect(colour = "grey80", fill = "grey90"),
        panel.background = element_rect(colour = "grey80", fill = NA),
        plot.subtitle = element_text(size = 8, face = "italic"),
        plot.caption = element_text(size = 8, face = "italic"))

```

### Summary of Results

After adjusting for available confounders, both better compliance and better performance of the ABCDEF Bundle on a given day are associated with a lower likelihood of being on mechanical ventilation the following day among the patients we were able to include in our model.

### Details of Missingness and Results

`r table_nums("missing_mv", display = "cite")` describes the proportion of the
`r format(nrow(df_logmods) - nrow(df_logmod_mv), big.mark = ",")` patient-days
excluded from the MV model due to incomplete data which were missing each
covariate/outcome.

#### `r table_nums("missing_mv")`
```{r missing_mv, results = "asis"}
pander(as.data.frame(miss_var_mv), digits = 2, style = "rmarkdown")

```

Below, we present in `r figure_nums("ors_mv", display = "cite")` odds ratios for all measures of compliance and performance (complete compliance/performance,
and "dose" = [number of elements done / number of elements eligible]) on a given
day vs mechanical ventilation the following day. In `r figure_nums("probs_mv", display = "cite")`, we show the adjusted probability of mechanical ventilation the following day for each "dose" of compliance and performance. (Adjusted probabilities for *overall* compliance/performance would only be a single point + confidence interval and thus are not plotted.)

#### `r figure_nums("ors_mv")`
```{r print_mvors, fig.width = 3.5, fig.height = 3}
mvplot_ors

```

#### `r figure_nums("probs_mv")`
```{r print_mvprobs, fig.width = 3.5, fig.height = 3}
mvplot_probs

```
