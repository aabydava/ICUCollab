---
title: "ICU Liberation: ABCDEF Bundle vs ICU Outcomes"
author: "Jennifer Thompson, MPH for Society of Critical Care Medicine"
output:
  html_notebook:
    code_folding: hide
    theme: journal
    toc: true
    toc_float: true
    toc_depth: 4
---

```{r setup, results = "hide"}
suppressPackageStartupMessages(library(tidyverse, quietly = TRUE))
suppressPackageStartupMessages(library(forcats, quietly = TRUE))
suppressPackageStartupMessages(library(stringr, quietly = TRUE))
suppressPackageStartupMessages(library(rms, quietly = TRUE))
suppressPackageStartupMessages(library(captioner, quietly = TRUE))
suppressPackageStartupMessages(library(plotly, quietly = TRUE))
suppressPackageStartupMessages(library(naniar, quietly = TRUE))
suppressPackageStartupMessages(library(JTHelpers, quietly = TRUE))
suppressPackageStartupMessages(library(pander, quietly = TRUE))
suppressPackageStartupMessages(library(knitr, quietly = TRUE))
suppressPackageStartupMessages(library(kableExtra, quietly = TRUE))
suppressPackageStartupMessages(library(tipr, quietly = TRUE))
  ## for tipping point analyses
  ## https://cran.r-project.org/web/packages/tipr/README.html

## dpi for PNG figures
png_dpi <- 400

load("AnalysisData/iculib.Rdata")

## -- Exclude patients <18 years of age ----------------------------------------
young_pts <- subset(demog, age == 0)$id
age_levels <- levels(demog$age_f)
demog <- subset(demog, !(id %in% young_pts))
demog$age_f <- factor(demog$age, labels = age_levels[-1])
compliance <- subset(compliance, !(id %in% young_pts))

## Combine months 1-6 (baseline); keep implementation months separate
demog$month_cat <- with(demog, {
  factor(ifelse(month_f %in% paste("Month", 1:6), 1,
                as.numeric(gsub("^Month ", "", month_f)) - 5),
         levels = 1:15,
         labels = c("Baseline", paste("Imp", 1:14)))
})
demog$month_cat_short <- with(demog, {
  factor(ifelse(month_f %in% paste("Month", 1:6), 1,
                as.numeric(gsub("^Month ", "", month_f)) - 5),
         levels = 1:15,
         labels = c("BL", paste0("I", 1:14)))
})

compliance$month_cat <- with(compliance, {
  factor(ifelse(month_f %in% paste("Month", 1:6), 1,
                as.numeric(gsub("^Month ", "", month_f)) - 5),
         levels = 1:15,
         labels = c("Baseline", paste("Imp", 1:14)))
})
compliance$month_cat_short <- with(compliance, {
  factor(ifelse(month_f %in% paste("Month", 1:6), 1,
                as.numeric(gsub("^Month ", "", month_f)) - 5),
         levels = 1:15,
         labels = c("BL", paste0("I", 1:14)))
})

## Add numeric "study day" variable to compliance data set
compliance$study_day <-
  as.numeric(str_extract(compliance$redcap_event_name, "(?<=\\_)[0-9]+(?=\\_)"))

## Get last Collaborative ICU day entered for each patient
last_days <- compliance %>%
  filter(icu_day) %>%
  group_by(id) %>%
  summarise(last_icu_day = max(study_day, na.rm = TRUE))

demog <- left_join(demog, last_days, by = "id")

## Vector of hex colors from magnifying glass in slide templates
## (via colorcodepicker.com)
magglass_colors <- c("a" = "#E16725",
                     "b" = "#FBA724",
                     "c" = "#698C36",
                     "d" = "#07A7B4",
                     "e" = "#138CBD",
                     "f" = "#293F90",
                     "overall" = "black")

```

```{r tablesfigs, results = "hide"}
table_nums <- captioner(prefix = "Table")
table_nums(
  name = "descbase", caption = "Baseline and Demographic Characteristics"
)
table_nums(
  name = "descinhosp", caption = "In-Hospital and Discharge Characteristics"
)
table_nums(name = "descicudays", caption = "ICU Day Characteristics")
table_nums(
  name = "descabcdef", caption = "Bundle Compliance and Performance, Overall"
)
table_nums(
  name = "missing_mv",
  caption = "% of Records Excluded from MV Model due to Missingness by Variable"
)
table_nums(
  name = "missing_coma",
  caption = "% of Records Excluded from Coma Model due to Missingness by Variable"
)
table_nums(
  name = "missing_del",
  caption = "% of Records Excluded from Delirium Model due to Missingness by Variable"
)
table_nums(
  name = "missing_res",
  caption = "% of Records Excluded from Restraints Model due to Missingness by Variable"
)
table_nums(
  name = "missing_pain",
  caption = "% of Records Excluded from Pain Model due to Missingness by Variable"
)
table_nums(
  name = "missing_icureadm",
  caption = "% of Patients Excluded from ICU Readmission Model due to Missingness by Variable"
)
table_nums(
  name = "missing_dcloc",
  caption = "% of Patients Excluded from Discharge Location Model due to Missingness by Variable"
)

figure_nums <- captioner(prefix = "Figure")
figure_nums(name = "run_comp", caption = "ABCDEF Compliance Over Time")
figure_nums(name = "run_perf", caption = "ABCDEF Performance Over Time")
figure_nums(name = "run_meds", caption = "Medication Use Over Time")
figure_nums(
  name = "ors_mv",
  caption = "Adjusted Odds Ratios, ABCDEF Bundle vs Mechanical Ventilation"
)
figure_nums(
  name = "probs_mv",
  caption = "Adjusted Probabilities of Mechanical Ventilation vs Dose of ABCDEF Bundle"
)
figure_nums(
  name = "ors_coma",
  caption = "Adjusted Odds Ratios, ABCDEF Bundle vs Coma"
)
figure_nums(
  name = "probs_coma",
  caption = "Adjusted Probabilities of Coma vs Dose of ABCDEF Bundle"
)
figure_nums(
  name = "ors_del",
  caption = "Adjusted Odds Ratios, ABCDEF Bundle vs Delirium"
)
figure_nums(
  name = "probs_del",
  caption = "Adjusted Probabilities of Delirium vs Dose of ABCDEF Bundle"
)
figure_nums(
  name = "ors_res",
  caption = "Adjusted Odds Ratios, ABCDEF Bundle vs Physical Restraints"
)
figure_nums(
  name = "probs_res",
  caption = "Adjusted Probabilities of Physical Restraints vs Dose of ABCDEF Bundle"
)
figure_nums(
  name = "ors_pain",
  caption = "Adjusted Odds Ratios, ABCDEF Bundle vs Significant Pain"
)
figure_nums(
  name = "probs_pain",
  caption = "Adjusted Probabilities of Significant Pain vs Dose of ABCDEF Bundle"
)
figure_nums(
  name = "hrs_iculos",
  caption = "Adjusted Hazard Ratios, ABCDEF Bundle vs ICU Discharge"
)
figure_nums(
  name = "ors_icureadm",
  caption = "Adjusted Odds Ratios, ABCDEF Bundle vs ICU Readmission"
)
figure_nums(
  name = "probs_icureadm",
  caption = "Adjusted Probabilities of ICU Readmission vs ABCDEF Bundle"
)
figure_nums(
  name = "hrs_hosplos",
  caption = "Adjusted Hazard Ratios, ABCDEF Bundle vs Hospital Discharge"
)
figure_nums(
  name = "hrs_death",
  caption = "Adjusted Hazard Ratios, ABCDEF Bundle vs Mortality"
)
figure_nums(
  name = "ors_dcloc",
  caption = "Adjusted Odds Ratios, ABCDEF Bundle vs Discharge to Facility"
)
figure_nums(
  name = "probs_dcloc",
  caption = "Adjusted Probabilities of Discharge to Facility vs ABCDEF Bundle"
)

```

# Overview & Purpose

This report aims to:

1. Describe the cohort of patients in the [SCCM ICU Liberation ABCDEF Bundle Improvement Collaborative](http://www.iculiberation.org/About/collaborative/Pages/default.aspx)
1. Describe the implementation of the [ABCDEF Bundle](http://www.iculiberation.org/Bundles/Pages/default.aspx) over the course of the Collaborative
1. Describe the association between compliance and performance of the ABCDEF Bundle and important ICU outcomes *(outcomes will be detailed in a later section)*

The Collaborative enrolled patients at `r length(unique(demog$hosp_f))` ICUs
across the United States, collecting data during a six-month **baseline** period
and a 14-month **implementation** period. During the six months of baseline data
collection, no changes in usual care were prescribed; during the 14 months of
implementation, sites were encouraged to use the ABCDEF Bundle. Our hypotheses
are that implementation rates improved over the course of data collection, and
that increased compliance with and performance of the ABCDEF Bundle is
associated with better in-hospital outcomes.

Our analysis plan was specified *a priori* and can be found [here](https://docs.google.com/document/d/1GebrA6Lt-rEh70Aw9r4mrhRlggWUfgUl_LaQePOCWZA/edit?usp=sharing), including a history of all changes.

# Definitions of Compliance and Performance {#definitions}

There are six main elements of the ABCDEF Bundle, with element B comprised of
two main components. Definitions of "compliance" (completely following the ABCDEF Bundle protocol as specified, with documentation of each step) and "performance" (performing the main component of the Bundle element, possibly without complete documentation) are detailed below, referring to any single day. For each element, compliance and performance are only measured if the patient was in the ICU the full 24 hours; additional eligibility for specific elements are detailed below.

| Bundle element    | Days eligible | Compliant if: | Performed if: |
|-------------------|---------------|---------------|---------------|
| **A: Assess, prevent and manage pain**  | | >=6 documented pain assessments using a validated instrument | *same* |
| **B: Both SAT and SBT** |   |   |   |
| &nbsp;&nbsp;&nbsp;SAT | Received continuous/ intermittent sedation | **If safety screen documented:**<br>If screen failed, SAT not performed; if screen passed, SAT was performed<br>**If safety screen not documented:**<br>SAT marked not done due to  failed screen/contraindication | SAT performed and documented |
| &nbsp;&nbsp;&nbsp;SBT | On mechanical ventilation | **If safety screen documented:**<br>If screen failed, SBT not performed; if screen passed, SBT was performed<br>**If safety screen not documented:**<br>SBT marked not done due to  failed screen/contraindication | SBT performed and documented |
| **C: Choice of analgesia and sedation** | | >=6 documented sedation assessments using a validated instrument | *same* |
| **D: Delirium - assess, prevent and manage** | | >=2 documented delirium assessments using a validated instrument | *same* |
| **E: Exercise and early mobility** | | **If safety screen documented:**<br>If screen failed, mobility not performed; if screen passed, mobility higher than active range of motion was performed<br>**If safety screen not documented:**<br>Mobility marked not done due to failed screen/contraindication | Mobility higher than active range of motion performed and documented |
| **F: Family engagement and empowerment** | Family present | Family member was educated on ABCDEF bundle and/or participated in at least one of: rounds; conference; plan of care; ABCDEF care | *same* |
| **Overall (complete)** | | All elements eligible to be compliant are compliant | All elements eligible to be performed are performed |
| **Overall (dose)** | | Elements compliant / elements eligible to be compliant | Elements performed / elements eligible to be performed |

# Variable Calculation {#variables}

- **Age:** For descriptive purposes, all age data is left as entered; however,
due to low numbers in our most extreme categories, we combined the two youngest categories and the two oldest categories in our models.
- **Race:** For descriptive purposes, all race data is left as entered; however,
for modeling, we combined categories with <1% representation. Patients with races of American Indian/Alaskan Native and Native Hawaiian/Pacific Islander are combined, and patients with multiple races marked are combined with patients with "Other" race marked.
- **BMI:** BMI was calculated as `weight / (height / 100)^2`, where weight was entered in kg and height was entered in cm. We assumed that any height below 80 was accidentally entered in inches rather than cm, and converted those heights to cm (original height * 2.54). After calculating BMI, some values were implausible; we assumed that any BMI < 7 (based on anorexia data) or > 204 (based on highest recorded BMI) was due to data entry error, and these values (along with anyone for whom weight and/or height were missing or equal to 0) were forced to be missing.
- **ICU type:** Site self-descriptions were combined as follows:
    - Mixed medical/surgical: *ICU, medical & surgical ICU, critical care unit, adult ICU, adult critical care unit, trauma & life support center*
    - Medical: *medical ICU, medical critical care unit*
    - Surgical/trauma: *surgical ICU, trauma ICU*
    - Neuro: *neuro ICU*
    - Cardiac/surgical: *adult surgical heart unit, cardiac surgical ICU, cardiothoracic ICU, cardiovascular ICU*
    - Cardiac: *cardio-neuro ICU, cardio ICU*
- **Primary admission diagnoses:** Patients could be admitted with multiple admission diagnoses; therefore, we prioritized diagnoses to capture the most important information relevant to this particular project. Diagnoses were categorized and prioritized as following (ie, a patient admitted with both sepsis and pneumonia would be in the sepsis category):
    1. Sepsis/septic shock or ARDS: *sepsis/septic shock; ARDS without infection*
    1. Respiratory: *airway protection/obstruction; COPD/asthma; pneumonia; pulmonary embolism/DVT*
    1. Neurologic: *neurological disease; traumatic brain injury; change in mental status; traumatic brain injury (isolated)*
    1. Cardiac: *congestive heart failure; acute MI/cardiogenic shock; arrhythmia*
    1. Gastrointestinal: *GI bleed; cirrhosis/hepatic failure; pancreatitis*
    1. Genitourinary: *renal failure; metabolic/endocrine/electrolyte disturbances*
    1. Surgery: *vascular; abdominal; transplant; urologic; orthopedic; ENT; OB/GYN*
    1. Trauma: *multi-trauma; hemorrhagic shock*
    1. Drug overdose/withdrawal
    1. Other: *other infectious diseases; malignancy; "other"*

Full details on how many calculated variables are determined from raw data, including definitions of compliance and performance, are in the [analysis plan](https://docs.google.com/document/d/1GebrA6Lt-rEh70Aw9r4mrhRlggWUfgUl_LaQePOCWZA/edit?usp=sharing).

# Descriptive Statistics, Entire Cohort

There were `r format(nrow(demog), big.mark = ",")` patients enrolled in the ICU Collaborative over the 20 months of data collection. Our definitions of ABCDEF bundle compliance and performance require the patient to be in the ICU a full 24 hours; therefore, we have to exclude `r format(sum(demog$icu_days <= 0, na.rm = TRUE), big.mark = ",")` patients from analyses who never had a full day in the ICU and thus were ineligible to have the exposures of interest.

This section describes demographics and characteristics at ICU admission, throughout the hospital stay, and on each patient-day among those patients with at least one full ICU day. Specific numbers of patients included in each individual analysis will differ according to the outcome, and will be shown as each model is discussed.

For full definitions of compliance and performance, see [Definitions](#definitions).

```{r descbase}
## Add labels to variables we want to describe - labels don't play well with
## tidyverse so copy a separate data.frame
demog_desc <- demog %>%
  filter(icu_days > 0) %>%
  mutate(
    comfort_care_icu_days_exp = ifelse(comfort_care_icu_days == 0, NA,
                                       comfort_care_icu_days)
  )

demog_desc$hosp_f <- as.factor(demog_desc$hosp_f)

label(demog_desc$hosp_f) <- "Study site"
label(demog_desc$hosp_type) <- "Hospital type"
label(demog_desc$month_cat) <- "Time period"
label(demog_desc$age_f) <- "Age category"
label(demog_desc$sex_f) <- "Sex"
label(demog_desc$race_cat) <- "Race"
label(demog_desc$hisp_cat) <- "Hispanic"
label(demog_desc$bmi) <- "BMI"
label(demog_desc$home_preadmit) <- "Residence pre-admission"
label(demog_desc$mob_preadmit) <- "Mobility pre-admission"
label(demog_desc$primary_admit) <- "Primary admission diagnosis"
label(demog_desc$icu_type_comb) <- "ICU type"
label(demog_desc$any_soi) <- "Any severity of illness score available"
label(demog_desc$apacheii_avail) <- "APACHE II available"
label(demog_desc$apacheii_score) <- "APACHE II score"
label(demog_desc$apacheiii_avail) <- "APACHE III available"
label(demog_desc$apacheiii_score) <- "APACHE III score"
label(demog_desc$apacheiv_avail) <- "APACHE IV available"
label(demog_desc$apacheiv_score) <- "APACHE IV score"
label(demog_desc$sofa_avail) <- "SOFA available"
label(demog_desc$sofa_score) <- "SOFA score"
label(demog_desc$othersoi_avail) <- "Other SOI available"
label(demog_desc$ever_invas_mv) <- "Ever on invasive MV"
label(demog_desc$hrs_invas_mv) <- "Hours on invasive MV"
label(demog_desc$ever_noninvas_mv) <- "Ever on noninvasive MV"
label(demog_desc$hrs_noninvas_mv) <- "Hours on noninvasive MV"
label(demog_desc$icu_los) <- "ICU length of stay"
label(demog_desc$icu_days) <- "Days all 24h in ICU"
label(demog_desc$ever_readmit_icu) <- "Ever readmitted to ICU"
label(demog_desc$had_painasmt_icu_days) <-
  "Days in ICU with >=1 pain assessment with validated tool"
label(demog_desc$sigpain_icu_days) <- "Days in ICU with significant pain"
label(demog_desc$on_sedation_icu_days) <-
  "Days in ICU on continuous/intermittent sedation"
label(demog_desc$had_satscreen_icu_days) <- "Days in ICU with SAT safety screen"
label(demog_desc$had_sat_icu_days) <- "Days in ICU with SAT performed"
label(demog_desc$on_mv_icu_days) <- "Days in ICU on MV"
label(demog_desc$had_sbtscreen_icu_days) <- "Days in ICU with SBT safety screen"
label(demog_desc$had_sbt_icu_days) <- "Days in ICU with SBT performed"
label(demog_desc$sat_sbt_icu_days) <- "Days in ICU with SAT prior to SBT"
label(demog_desc$rcvd_benzo_icu_days) <- "Days received benzodiazepines in ICU"
label(demog_desc$rcvd_opioid_icu_days) <- "Days received opioids in ICU"
label(demog_desc$rcvd_propofol_icu_days) <- "Days received propofol in ICU"
label(demog_desc$rcvd_dex_icu_days) <- "Days received dex in ICU"
label(demog_desc$rcvd_antipsyc_icu_days) <- "Days received antipsychotics in ICU"
label(demog_desc$had_sedasmt_icu_days) <-
  "Days in ICU with >=1 sedation assessment"
label(demog_desc$had_delasmt_icu_days) <-
  "Days in ICU with >=1 delirium assessment"
label(demog_desc$delirium_icu_days) <- "Days in ICU with delirium"
label(demog_desc$had_mobscreen_icu_days) <-
  "Days in ICU with mobility safety screen"
label(demog_desc$had_mobility_icu_days) <-
  "Days in ICU with mobility performed (> active ROM)"
label(demog_desc$family_present_icu_days) <- "Days in ICU with family present"
label(demog_desc$family_invited_icu_days) <-
  "Days in ICU family invited to participate in rounds/conference"
label(demog_desc$family_rounds_icu_days) <-
  "Days in ICU family participated in rounds"
label(demog_desc$family_care_icu_days) <-
  "Days in ICU family participated in plan of care/ABCDEF care"
label(demog_desc$family_edu_icu_days) <-
  "Days in ICU family educated on ABCDEF bundle/related topics"
label(demog_desc$hosp_los) <- "Hospital length of stay"
label(demog_desc$home_posticu) <- "Residence post-ICU"
label(demog_desc$mob_posticu) <- "Mobility post-ICU"
label(demog_desc$dc_status_f) <- "Discharge status"
label(demog_desc$dc_loc_f) <- "Discharge location"
label(demog_desc$comp_a_days) <- "ICU days Element A compliant"
label(demog_desc$comp_a_prop) <- "Proportion of ICU days Element A compliant"
label(demog_desc$perf_a_days) <- "ICU days Element A performed"
label(demog_desc$perf_a_prop) <- "Proportion of ICU days Element A performed"
label(demog_desc$comp_b_sat_days) <- "ICU days Element B - SAT compliant"
label(demog_desc$comp_b_sat_prop) <-
  "Proportion of sedation ICU days Element B - SAT compliant"
label(demog_desc$perf_b_sat_days) <- "ICU days Element B - SAT performed"
label(demog_desc$perf_b_sat_prop) <-
  "Proportion of sedation ICU days Element B - SAT performed"
label(demog_desc$comp_b_sbt_days) <- "ICU days Element B - SBT compliant"
label(demog_desc$comp_b_sbt_prop) <-
  "Proportion of MV ICU days Element B - SBT compliant"
label(demog_desc$perf_b_sbt_days) <- "ICU days Element B - SBT performed"
label(demog_desc$perf_b_sbt_prop) <-
  "Proportion of MV ICU days Element B - SBT performed"
label(demog_desc$comp_c_days) <- "ICU days Element C compliant"
label(demog_desc$comp_c_prop) <- "Proportion of ICU days Element C compliant"
label(demog_desc$perf_c_days) <- "ICU days Element C performed"
label(demog_desc$perf_c_prop) <- "Proportion of ICU days Element C performed"
label(demog_desc$comp_d_days) <- "ICU days Element D compliant"
label(demog_desc$comp_d_prop) <- "Proportion of ICU days Element D compliant"
label(demog_desc$perf_d_days) <- "ICU days Element D performed"
label(demog_desc$perf_d_prop) <- "Proportion of ICU days Element D performed"
label(demog_desc$comp_e_days) <- "ICU days Element E compliant"
label(demog_desc$comp_e_prop) <- "Proportion of ICU days Element E compliant"
label(demog_desc$perf_e_days) <- "ICU days Element E performed"
label(demog_desc$perf_e_prop) <- "Proportion of ICU days Element E performed"
label(demog_desc$comp_f_days) <- "ICU days Element F compliant"
label(demog_desc$comp_f_prop) <-
  "Proportion of family ICU days Element F compliant"
label(demog_desc$perf_f_days) <- "ICU days Element F performed"
label(demog_desc$perf_f_prop) <-
  "Proportion of family ICU days Element F performed"
label(demog_desc$comp_yn_days) <- "ICU days entire bundle compliant"
label(demog_desc$comp_yn_prop) <-
  "Proportion of ICU days entire bundle compliant"
label(demog_desc$perf_yn_days) <- "ICU days entire bundle performed"
label(demog_desc$perf_yn_prop) <-
  "Proportion of ICU days entire bundle performed"
label(demog_desc$comfort_care_icu_ever) <- "Ever on comfort care in ICU"
label(demog_desc$comfort_care_icu_days) <- "Days on comfort care in ICU"
label(demog_desc$comfort_care_icu_days_exp) <-
  "Days on comfort care in ICU among those who received it"

## Only describe days fully in ICU
comp_desc <- compliance %>% filter(icu_day)

label(comp_desc$pain_asmts_icu) <-
  "Number of pain assessments with validated tool"
label(comp_desc$had_painasmt_icu) <-
  "Had >=1 pain assessment with validated tool"
label(comp_desc$comp_a_f) <- "Element A: compliant"
label(comp_desc$perf_a_f) <- "Element A: performed"
label(comp_desc$sigpain_verbal_icu) <- "Significant pain self-reported"
label(comp_desc$sigpain_valid_icu) <- "Significant pain using validated tool"
label(comp_desc$sigpain_icu) <- "Significant pain, either method"

label(comp_desc$on_sedation_icu_f) <- "On continuous/intermittent sedation"
label(comp_desc$had_satscreen_icu) <- "SAT safety screen documented"
label(comp_desc$had_sat_icu) <- "SAT documented"
label(comp_desc$comp_b_sat_f) <- "Element B - SAT: compliant"
label(comp_desc$perf_b_sat_f) <- "Element B - SAT: performed"

label(comp_desc$on_mv_icu_f) <- "On mechanical ventilation"
label(comp_desc$had_sbtscreen_icu) <- "SBT safety screen documented"
label(comp_desc$had_sbt_icu) <- "SBT documented"
label(comp_desc$comp_b_sbt_f) <- "Element B - SBT: compliant"
label(comp_desc$perf_b_sbt_f) <- "Element B - SBT: performed"
label(comp_desc$sat_sbt_icu) <- "SAT performed before SBT"

label(comp_desc$sed_assess_valid_icu) <-
  "Number of sedation assessments with validated tool"
label(comp_desc$had_sedasmt_icu) <-
  "Had >=1 sedation assessment with validated tool"
label(comp_desc$comp_c_f) <- "Element C: compliant"
label(comp_desc$perf_c_f) <- "Element C: performed"
label(comp_desc$rcvd_benzo_icu) <- "Received benzodiazepines"
label(comp_desc$rcvd_opioid_icu) <- "Received opioids"
label(comp_desc$rcvd_propofol_icu) <- "Received propofol"
label(comp_desc$rcvd_dex_icu) <- "Received dexmedetomidine"
label(comp_desc$rcvd_antipsyc_icu) <- "Received antipsychotics (typical/atypical)"

label(comp_desc$del_assess_valid_icu) <-
  "Number of delirium assessments with validated tool"
label(comp_desc$had_delasmt_icu) <-
  "Had >=1 delirium assessment with validated tool"
label(comp_desc$comp_d_f) <- "Element D: compliant"
label(comp_desc$perf_d_f) <- "Element D: performed"
label(comp_desc$delirium_icu) <- "Delirious, per validated tool"
label(comp_desc$coma_icu) <- "Comatose"

label(comp_desc$on_restraints_icu) <- "On physical restraints"
label(comp_desc$had_mobscreen_icu) <- "Mobility safety screen documented"
label(comp_desc$had_mobility_icu) <- "Mobility > active ROM documented"
label(comp_desc$mobilityhighest_icu) <- "Highest level of mobility"
label(comp_desc$comp_e_f) <- "Element E: compliant"
label(comp_desc$perf_e_f) <- "Element E: performed"

label(comp_desc$family_present_icu_f) <- "Family present"
label(comp_desc$family_invited_icu) <-
  "Family invited to participate in rounds/conference"
label(comp_desc$family_rounds_icu) <- "Family participated in rounds"
label(comp_desc$family_care_icu) <-
  "Family participated in plan of care/ABCDEF care"
label(comp_desc$family_edu_icu) <-
  "Family educated on ABCDEF bundle/related topics"
label(comp_desc$comp_f_f) <- "Element F: compliant"
label(comp_desc$perf_f_f) <- "Element F: performed"

label(comp_desc$comfort_care_icu) <- "On comfort care"

label(comp_desc$comp_yn_f) <- "Overall ABCDEF compliance"
label(comp_desc$perf_yn_f) <- "Overall ABCDEF performance"
label(comp_desc$elements_elig) <-
  "Number of ABCDEF elements eligible to be performed/compliant"
label(comp_desc$elements_comp) <- "Number of elements compliant"
label(comp_desc$comp_prop) <- "Proportion of elements compliant"
label(comp_desc$elements_perf) <- "Number of elements performed"
label(comp_desc$perf_prop) <- "Proportion of elements performed"

## Example for percentiles for each table
bmi_quants <- quantile(demog$bmi, na.rm = TRUE)
hrsmv_quants <- quantile(demog$hrs_invas_mv, na.rm = TRUE)
painasmt_quants <- quantile(comp_desc$pain_asmts_icu, na.rm = TRUE)

```

## `r table_nums("descbase")`

Continuous variables are described by the 25th, 50th and 75th percentiles, in
that order (50th percentile = median). For example, 25% of patients had a BMI of
`r round(bmi_quants["25%"])` or less; 50% of patients had a BMI of
`r round(bmi_quants["50%"])` or less; and 75% of patients had a BMI of
`r round(bmi_quants["75%"])` or less.

```{r print_descbase}
html(summaryM(hosp_type + month_cat + age_f + sex_f + race_cat +
                hisp_cat + bmi + home_preadmit + mob_preadmit + primary_admit +
                icu_type_comb + any_soi + apacheii_score + apacheiii_score +
                apacheiv_score + sofa_score ~ 1,
              data = demog_desc,
              continuous = 5),
     what = "%",
     npct = "both",
     digits = 2,
     long = TRUE,
     caption = "Demographic and Baseline Characteristics")

```

## `r table_nums("descinhosp")`

Continuous variables are described by the 25th, 50th and 75th percentiles, in
that order (50th percentile = median). For example, 25% of patients had
`r round(hrsmv_quants["25%"])` or fewer hours on mechanical ventilation; 50% of
patients had `r round(hrsmv_quants["50%"])` or fewer hours on MV; and 75% of
patients had `r round(hrsmv_quants["75%"])` or fewer hours on MV.

For full definitions of compliance and performance, see [Definitions](#definitions).

```{r print_descinhosp}
html(summaryM(ever_invas_mv + hrs_invas_mv + ever_noninvas_mv +
                hrs_noninvas_mv + icu_los + ever_readmit_icu +
                had_painasmt_icu_days + sigpain_icu_days + comp_a_days +
                comp_a_prop + perf_a_days + perf_a_prop +
                on_sedation_icu_days + had_satscreen_icu_days +
                had_sat_icu_days + comp_b_sat_days + comp_b_sat_prop +
                perf_b_sat_days + perf_b_sat_prop +
                on_mv_icu_days + had_sbtscreen_icu_days + had_sbt_icu_days +
                sat_sbt_icu_days + comp_b_sbt_days + comp_b_sbt_prop +
                perf_b_sbt_days + perf_b_sbt_prop +
                had_sedasmt_icu_days + comp_c_days + comp_c_prop + perf_c_days +
                perf_c_prop + rcvd_benzo_icu_days + rcvd_opioid_icu_days +
                rcvd_propofol_icu_days + rcvd_dex_icu_days +
                rcvd_antipsyc_icu_days +
                had_delasmt_icu_days + delirium_icu_days + comp_d_days +
                comp_d_prop + perf_d_days + perf_d_prop +
                had_mobscreen_icu_days + had_mobility_icu_days + comp_e_days +
                comp_e_prop + perf_e_days + perf_e_prop +
                family_present_icu_days + family_invited_icu_days +
                family_rounds_icu_days + family_care_icu_days +
                family_edu_icu_days + comp_f_days + comp_f_prop + perf_f_days +
                perf_f_prop + comp_yn_days + comp_yn_prop + perf_yn_days +
                perf_yn_prop + comfort_care_icu_ever +
                comfort_care_icu_days_exp + hosp_los + home_posticu +
                mob_posticu + dc_status_f + dc_loc_f ~ 1,
              data = demog_desc,
              continuous = 5),
     what = "%",
     npct = "both",
     digits = 2,
     long = TRUE,
     caption = "In-Hospital and Discharge Characteristics",
     insert.bottom =
       'Note: "Days in ICU" refers to days the patient was in the ICU all 24h')

```

## `r table_nums("descicudays")`

`r table_nums("descicudays", display = "cite")` presents descriptive statistics
by **day** for all days which were completely in the ICU.

Continuous variables are described by the 25th, 50th and 75th percentiles, in
that order (50th percentile = median). For example, 25% of patient-days had
`r round(painasmt_quants["25%"])` or fewer pain assessments with validated
tools; 50% of patient-days had `r round(painasmt_quants["50%"])` or fewer assessments; and 75% of patient-days had `r round(painasmt_quants["75%"])` or
fewer assessments.

For full definitions of compliance and performance, see [Definitions](#definitions).

```{r print_descicudays}
html(summaryM(pain_asmts_icu + had_painasmt_icu + comp_a_f + perf_a_f +
                sigpain_verbal_icu + sigpain_valid_icu + sigpain_icu +
                on_sedation_icu_f + had_satscreen_icu + had_sat_icu +
                comp_b_sat_f + perf_b_sat_f + on_mv_icu_f + had_sbtscreen_icu +
                had_sbt_icu + comp_b_sbt_f + perf_b_sbt_f + sat_sbt_icu +
                sed_assess_valid_icu + had_sedasmt_icu + comp_c_f + perf_c_f +
                rcvd_benzo_icu + rcvd_opioid_icu + rcvd_propofol_icu +
                rcvd_dex_icu + rcvd_antipsyc_icu +
                del_assess_valid_icu + had_delasmt_icu +
                comp_d_f + perf_d_f + delirium_icu + coma_icu +
                on_restraints_icu + had_mobscreen_icu + had_mobility_icu +
                mobilityhighest_icu + comp_e_f + perf_e_f +
                family_present_icu_f + family_invited_icu + family_rounds_icu +
                family_care_icu + family_edu_icu + comp_f_f + perf_f_f +
                comfort_care_icu + comp_yn_f + perf_yn_f + elements_elig +
                elements_comp + comp_prop + elements_perf + perf_prop ~ 1,
              data = comp_desc,
              continuous = 5),
     what = "%",
     npct = "both",
     digits = 2,
     long = TRUE,
     caption = "Characteristics of ICU Days")

```

# ABCDEF Implementation & Drug Use Over Time

The following runcharts present rates of ABCDEF Bundle compliance and
performance, both overall and by individual element, over the course of data
collection, as well as rates of sedative and analgesic use. Months 1-6 are
grouped together as our Baseline period; Months 7-20 are shown individually.
Numerators and denominators for each point can be seen in tooltips (hover over
the point of interest). For full definitions of compliance and performance, see
[Definitions](#definitions).

```{r runchart_prep}
## -- Elements common to both runcharts ----------------------------------------
element_suffixes <- c("a", "b_sat", "b_sbt", "c", "d", "e", "f", "yn")
element_tracenames <- c("A", "B: SAT", "B: SBT", "C", "D", "E", "F", "Overall")
element_cols <- c("a", "b", "b", "c", "d", "e", "f", "overall")

## Create list of plot titles, X/Y coordinates
runchart_titles <- c("A: Assess, prevent, manage pain",
                     "B: SAT",
                     "B: SBT",
                     "C: Choice of analgesia & sedation",
                     "D: Delirium",
                     "E: Exercise/early mobility",
                     "F: Family",
                     "Entire ABCDEF Bundle")

runchart_xes <- c(0.01, 0.27, 0.52, rep(0.77, 4), 0.02)
runchart_ys <- c(rep(0.24, 3), 1.05, 0.775, 0.54, 0.24, 1.05)
runchart_titlesize <- c(rep(8, 7), 12)

## Create list of annotations - will substitute for plot titles
## (plotly will only allow one title per plot, not one per subplot)
make_annotate_item <- function(title, title_size, xval, yval){
  list(x = xval, xanchor = "left", xref = "paper",
       y = yval, yanchor = "top", yref = "paper",
       text = paste0("<b>", title, "</b>"),
       font = list(size = title_size, family = "sans-serif"),
       showarrow = FALSE)
}

title_list <- pmap(.l = list("title" = runchart_titles,
                             "title_size" = runchart_titlesize,
                             "xval" = runchart_xes,
                             "yval" = runchart_ys),
                   .f = make_annotate_item)

## -- Function to create a plotly object for each element/overall --------------
create_plotly_runchart <- function(df, tracename, tracecol){
  if(tracename == "Overall"){
    ts <- 18
    fs <- 10
    tvals <- c("BL", paste0("I", 1:14))
    ms <- 6
  } else{
    ts <- 14
    fs <- 6
    tvals <- c("BL", paste0("I", seq(1, 13, 2)))
    ms <- 4
  }

  plot_ly(
    data = df,
    x = ~ month_cat_short,
    y = ~ pct_yes,
    name = tracename,
    line = list(color = magglass_colors[tracecol]),
    marker = list(color = magglass_colors[tracecol], size = ms),
    text = ~ tt_text,
    type = "scatter",
    mode = "lines+markers"
  ) %>%
    layout(titlefont = list(size = ts),
           xaxis = list(title = "",
                        tickfont = list(size = fs),
                        tickmode = "array",
                        tickvals = tvals),
           yaxis = list(title = "% Eligible Days",
                        range = c(0, 100),
                        tickmode = "array",
                        tickvals = seq(0, 100, 25),
                        ticksuffix = "%",
                        tickfont = list(size = fs)),
           font = list(family = "sans-serif"),
           showlegend = FALSE)
}

## Wrapper function to avoid tidyeval
filter_and_plot <- function(el, name, col, df){
  filter(df, element == el) %>%
    create_plotly_runchart(tracename = name, tracecol = col)
}

## -- Compliance runcharts -----------------------------------------------------
## Create dataset for overall compliance (y/n)
comp_yn_data <- compliance %>%
  dplyr::select(month_cat_short,
                ## Denominators
                icu_day, on_sedation_icu, on_mv_icu,
                family_present_icu, elements_elig,
                ## Numerators
                paste0("comp_", element_suffixes), elements_comp) %>%
  group_by(month_cat_short) %>%
  summarise_all(funs(days = sum), na.rm = TRUE) %>%
  ungroup() %>%
  gather(key = element, value = comp_days, comp_a_days:elements_comp_days) %>%
  mutate(elig_days =
           case_when(element == "comp_b_sat_days" ~ on_sedation_icu_days,
                     element == "comp_b_sbt_days" ~ on_mv_icu_days,
                     element == "comp_f_days" ~ family_present_icu_days,
                     element == "elements_comp_days" ~
                       as.integer(elements_elig_days),
                     TRUE ~ icu_day_days),
         pct_yes = round((comp_days / elig_days) * 100),
         dose_yn = ifelse(element == "elements_comp_days", " dose", ""),
         elig_text =
           case_when(element == "comp_b_sat_days" ~ "ICU days on sedation",
                     element == "comp_b_sbt_days" ~ "ICU days on MV",
                     element == "comp_f_days" ~ "ICU days family present",
                     element == "elements_comp_days" ~ "Elements eligible",
                     TRUE ~ "ICU days"),
         eldays_text = ifelse(element == "elements_comp_days",
                              "Elements", "Days"),
         tt_text = sprintf("Compliance%s: %s%%<br>%s compliant: %s<br>%s: %s",
                           dose_yn, round(pct_yes), eldays_text, comp_days,
                           elig_text, elig_days))

## Create list of all plots
comp_elements <- unique(comp_yn_data$element)
comp_elements <- comp_elements[grep("^comp", comp_elements)]

comp_plots <- purrr::pmap(
  list("el" = comp_elements, "name" = element_tracenames, "col" = element_cols),
  filter_and_plot,
  df = comp_yn_data
)
names(comp_plots) <- comp_elements

## Add a trace for "dose" to overall plot
comp_plots$comp_yn_days <- comp_plots$comp_yn_days %>%
  add_trace(
    data = filter(comp_yn_data, element == "elements_comp_days"),
    x = ~ month_cat_short,
    y = ~ pct_yes,
    name = "Dose of compliance",
    line = list(color = "black", dash = "dot"),
    marker = list(color = "black", size = 6),
    text = ~ tt_text,
    type = "scatter",
    mode = "lines+markers"
  )

## Make one big plot using subplots
## Overall --- C
## Overall --- D
## Overall --- E
## A BSAT BSBT F

comp_horiz <- subplot(comp_plots$comp_a_days, comp_plots$comp_b_sat_days,
                      comp_plots$comp_b_sbt_days, comp_plots$comp_f_days,
                      nrows = 1, shareY = TRUE, margin = 0.01)
comp_vert <- subplot(comp_plots$comp_c_days, comp_plots$comp_d_days,
                     comp_plots$comp_e_days,
                     nrows = 3, shareX = TRUE, margin = 0.04) %>%
  layout(xaxis = list(showticklabels = FALSE))
comp_toprow <- subplot(comp_plots$comp_yn_days, comp_vert,
                       nrows = 1, widths = c(0.75, 0.25))

plotly_comp <- subplot(comp_toprow, comp_horiz,
                       nrows = 2, heights = c(0.75, 0.25), margin = 0.05)

## -- Performance runcharts ----------------------------------------------------
## Create dataset for overall performance (y/n)
perf_yn_data <- compliance %>%
  dplyr::select(month_cat_short,
                ## Denominators
                icu_day, on_sedation_icu, on_mv_icu,
                family_present_icu, elements_elig,
                ## Numerators
                paste0("perf_", element_suffixes), elements_perf) %>%
  group_by(month_cat_short) %>%
  summarise_all(funs(days = sum), na.rm = TRUE) %>%
  ungroup() %>%
  gather(key = element, value = perf_days, perf_a_days:elements_perf_days) %>%
  mutate(elig_days =
           case_when(element == "perf_b_sat_days" ~ on_sedation_icu_days,
                     element == "perf_b_sbt_days" ~ on_mv_icu_days,
                     element == "perf_f_days" ~ family_present_icu_days,
                     element == "elements_perf_days" ~
                       as.integer(elements_elig_days),
                     TRUE ~ icu_day_days),
         pct_yes = round((perf_days / elig_days) * 100),
         dose_yn = ifelse(element == "elements_perf_days", " dose", ""),
         elig_text =
           case_when(element == "perf_b_sat_days" ~ "ICU days on sedation",
                     element == "perf_b_sbt_days" ~ "ICU days on MV",
                     element == "perf_f_days" ~ "ICU days family present",
                     element == "elements_perf_days" ~ "Elements eligible",
                     TRUE ~ "ICU days"),
         eldays_text = ifelse(element == "elements_perf_days",
                              "Elements", "Days"),
         tt_text = sprintf("Performance%s: %s%%<br>%s performed: %s<br>%s: %s",
                           dose_yn, round(pct_yes), eldays_text, perf_days,
                           elig_text, elig_days))

## Create list of all plots
perf_elements <- unique(perf_yn_data$element)
perf_elements <- perf_elements[grep("^perf", perf_elements)]

perf_plots <- purrr::pmap(
  list("el" = perf_elements, "name" = element_tracenames, "col" = element_cols),
  filter_and_plot,
  df = perf_yn_data
)
names(perf_plots) <- perf_elements

## Add a trace for "dose" to overall plot
perf_plots$perf_yn_days <- perf_plots$perf_yn_days %>%
  add_trace(
    data = filter(perf_yn_data, element == "elements_perf_days"),
    x = ~ month_cat_short,
    y = ~ pct_yes,
    name = "Dose of performance",
    line = list(color = "black", dash = "dot"),
    marker = list(color = "black", size = 6),
    text = ~ tt_text,
    type = "scatter",
    mode = "lines+markers"
  )

## Make one big plot using subplots
perf_horiz <- subplot(perf_plots$perf_a_days, perf_plots$perf_b_sat_days,
                      perf_plots$perf_b_sbt_days, perf_plots$perf_f_days,
                      nrows = 1, shareY = TRUE, margin = 0.01)
perf_vert <- subplot(perf_plots$perf_c_days, perf_plots$perf_d_days,
                     perf_plots$perf_e_days,
                     nrows = 3, shareX = TRUE, margin = 0.04) %>%
  layout(xaxis = list(showticklabels = FALSE))
perf_toprow <- subplot(perf_plots$perf_yn_days, perf_vert,
                       nrows = 1, widths = c(0.75, 0.25))

plotly_perf <- subplot(perf_toprow, perf_horiz,
                       nrows = 2, heights = c(0.75, 0.25), margin = 0.05)

```

## `r figure_nums("run_comp")`

For overall compliance, the dotted line indicates **dose** of compliance; the
solid line indicates total (yes/no) compliance.

```{r print_comprun, fig.width = 7, fig.height = 5}
plotly_comp %>%
  layout(annotations = title_list)

```

## `r figure_nums("run_perf")`

For overall performance, the dotted line indicates **dose** of performance; the
solid line indicates total (yes/no) performance.

```{r print_perfrun, fig.width = 7, fig.height = 5}
plotly_perf %>%
  layout(annotations = title_list)

```

## `r figure_nums("run_meds")`

`r figure_nums("run_meds", display = "cite")` shows the percentage of ICU days
with each medication used over time.

```{r runchart_meds, fig.width = 7, fig.height = 5}
## Vector of medication names
med_names <- c("Benzodiazepines", "Opioids", "Propofol", "Dexmedetomidine")

prop_yes <- function(x){
  mean(x == "Yes", na.rm = TRUE) * 100
}
days_yes <- function(x){
  sum(x == "Yes", na.rm = TRUE)
}

## Note: Tried to also do % of days on continuous/intermittent sedation,
## but proportions were >1, I assume because patients received these medications
## PRN as well as continuously.

rundata_meds <- compliance %>%
  filter(icu_day) %>%
  dplyr::select(month_cat_short, matches("^rcvd\\_[a-z]+\\_icu$")) %>%
  group_by(month_cat_short) %>%
  summarise_all(funs(days = days_yes)) %>%
  ungroup() %>%
  gather(key = med, value = days_med, matches("^rcvd")) %>%
  left_join(
    distinct(dplyr::select(comp_yn_data, month_cat_short, icu_day_days)),
    by = "month_cat_short") %>%
  mutate(
    med = gsub("^rcvd\\_", "", gsub("\\_icu\\_days$", "", med)),
    med_f = case_when(med == "benzo" ~ "Benzodiazepines",
                      med == "dex" ~ "Dexmedetomidine",
                      med == "opioid" ~ "Opioids",
                      med == "propofol" ~ "Propofol",
                      TRUE ~ "Other"),
    prop_med = round((days_med / icu_day_days) * 100),
    tt_text = sprintf("Received on %s / %s ICU days", days_med, icu_day_days)
  )

## -- Function to create a plotly object for each medication -------------------
create_plotly_medchart <- function(df = rundata_meds, tracename, tracecol){
  df <- df %>% filter(med_f == tracename)
  
  ts <- 14
  fs <- 10
  tvals <- c("BL", paste0("I", seq(1, 13, 2)))
  ms <- 4

  plot_ly(
    data = df,
    x = ~ month_cat_short,
    y = ~ prop_med,
    name = tracename,
    line = list(color = magglass_colors[tracecol]),
    marker = list(color = magglass_colors[tracecol], size = ms),
    text = ~ tt_text,
    type = "scatter",
    mode = "lines+markers"
  ) %>%
    layout(titlefont = list(size = ts),
           xaxis = list(title = "",
                        tickfont = list(size = fs),
                        tickmode = "array",
                        tickvals = tvals),
           yaxis = list(title = "% ICU Days",
                        range = c(0, 100),
                        tickmode = "array",
                        tickvals = seq(0, 100, 25),
                        ticksuffix = "%",
                        tickfont = list(size = fs)),
           font = list(family = "sans-serif"),
           showlegend = FALSE)
}

runchart_med_args <- list(
  "tracename" = med_names, "tracecol" = c("b", "c", "d", "f")
)

runcharts_meds <- pmap(.l = runchart_med_args, .f = create_plotly_medchart)
names(runcharts_meds) <- med_names

runchart_meds <- subplot(
  runcharts_meds,
  nrows = 2,
  shareX = TRUE, shareY = TRUE,
  titleX = FALSE,
  margin = c(0.01, 0.01, 0.05, 0.05)
)

## Create list of plot titles, X/Y coordinates
runchart_meds_xes <- c(0.01, 0.51, 0.01, 0.51)
runchart_meds_ys <- c(1.05, 1.05, 0.51, 0.51)

med_title_list <- pmap(.l = list("title" = med_names,
                             "xval" = runchart_meds_xes,
                             "yval" = runchart_meds_ys),
                   .f = make_annotate_item,
                   title_size = 14)

runchart_meds %>% layout(annotations = med_title_list)

```

# In-ICU Outcomes

The following sections look at the relationships between daily ABCDEF bundle compliance/performance and the following outcomes while the patient is still in
the ICU:

- Occurrence of delirium
- Occurrence of coma
- Mechanical ventilation
- Significant pain
- Physical restraints

For example, these models will help us answer the question "*Among patients
still alive and in the ICU*, is total ABCDEF bundle compliance on a given ICU day associated with lower likelihood of being on mechanical ventilation the
following day?"

## Analysis Method and Covariates{#covariates}

The relationship between ABCDEF bundle compliance and performance on a given ICU day and each of the above outcomes the *following* ICU day will be assessed
using logistic regression models; variance will be adjusted using Huber-White
sandwich estimation clustered by patient, to account for within-subject
correlation. Continuous variables will be allowed to have a nonlinear association with our outcomes using restricted cubic splines with four knots. For each outcome, we will have four different models using the following ABCDEF-related exposures:

- Total bundle compliance, yes/no
- Dose of compliance (# elements compliant / # elements eligible)
- Total bundle performance, yes/no
- Dose of performance (# elements performed / # elements eligible)

For more details on compliance and performance, please see
[Definitions](#definitions).

Each model will adjust for the following potential confounders (please see
[Variable Calculation](#variables) for more details):

- Demographics
    - Age category
    - Sex
    - Race
    - Ethnicity (Hispanic vs non-Hispanic)
    - BMI
    - Residency prior to admission (home vs facility)
    - Mobility prior to admission (no restrictions vs any)
- Admission characteristics
    - Admission diagnosis category
    - Hospital type (community vs teaching)
    - ICU type
- Daily ICU characteristics on day of ABCDEF bundle measurement
    - On benzos
    - On opioids
    - On propofol
    - On dex
    - On typical and/or atypical antipsychotics
    - On comfort care
    - On MV
    - Coma
    - Delirium, for delirium outcome only (there is too much missing data to justify this covariate for other outcomes)

## Patient Inclusion & Missing Data

```{r model_datamgmt}
## -- Create data set for all "vs XXX the following day" models ----------------
## Vector of variables for which we'll need "xxx tomorrow" versions
lead_vars <- c("icu_day", "on_mv_icu_f", "coma_icu", "on_restraints_icu",
               "sigpain_icu", "delirium_icu")

## Vector of baseline covariates
base_vars <- c("age_cat_mod", "sex_f", "race_cat_mod", "hisp_cat_mod", "bmi",
               "mob_preadmit", "primary_admit", "home_preadmit",
               "icu_type_comb", "hosp_type", "hosp_f")

df_logmods <- compliance %>%
  dplyr::select(id, icu_day, redcap_event_name_f,
                comfort_care_icu, on_sedation_icu_f, rcvd_benzo_icu,
                rcvd_opioid_icu, rcvd_propofol_icu, rcvd_dex_icu,
                rcvd_antipsyc_icu,
                on_mv_icu_f, coma_icu,
                on_restraints_icu, sigpain_icu, delirium_icu,
                comp_yn_f, perf_yn_f, comp_prop, perf_prop) %>%
  ## Create "tomorrow" variables
  group_by(id) %>%
  mutate_at(vars(one_of(lead_vars)), funs(tmw = lead)) %>%
  ungroup() %>%
  ## Filter - these models will only use days when patients were in the ICU
  ## both "today" and "tomorrow"
  filter(icu_day & icu_day_tmw) %>%
  ## Merge on baseline covariates
  right_join(dplyr::select(demog, id, one_of(base_vars)), ., by = "id")

# ## Check a few patients
# ckids <- sample(unique(compliance$id), size = 10)
# print_vars <- map(lead_vars, ~ c(., paste0(., "_tmw"))) %>% flatten_chr
# print(subset(df_logmods, id %in% ckids)[,c("id", "redcap_event_name_f",
#                                            print_vars)],
#       width = Inf)

npts_total <- length(unique(demog$id))
npts_logmods <- length(unique(df_logmods$id))
pctpts_logmods <- (npts_logmods / npts_total) * 100
ndays_logmods <- nrow(df_logmods)

# ## Common sense check for % patients included in these models
# ck_icudays <- compliance %>%
#   group_by(id) %>%
#   summarise(n_icu_days = sum(icu_day, na.rm = TRUE)) %>%
#   ungroup()

```

We started with `r format(npts_total, big.mark = ",")` patients enrolled in the Collaborative; among these, only `r format(npts_logmods, big.mark = ",")` (`r round(pctpts_logmods)`%) had two *consecutive* days fully in the ICU and are
thus eligible to be included in these models. Thus, it is important to note that
these results may only be generalizable to this subset of patients, who may be
different in meaningful ways from patients who had no or only one day in their
Collaborative ICU admission.

Among those `r format(npts_logmods, big.mark = ",")` patients with at least
two consecutive ICU days, we have `r format(ndays_logmods, big.mark = ",")`
patient-days eligible for inclusion. Some of these days will be excluded due to
missing outcome and/or covariate data; the number of patients included in each
model will be specified with model results.

### Description of Missingness

Among patient-days eligible for inclusion in these models, most *covariates/confounders* had fairly low rates of missingness, with the exception
of mobility level prior to Collaborative admission (`r round(mean(is.na(df_logmods$mob_preadmit)) * 100)`% of patient-days missing). However, several of our *outcomes* which require assessments to evaluate had high rates of missingness, as shown below. A reference line at 5% missingness is
included below; below this level, we typically don't worry much about missingness.

```{r logmods_missing, fig.height = 6, fig.width = 5}
miss_plot <- gg_miss_var(df_logmods %>% dplyr::select(-id), show_pct = TRUE) +
  geom_hline(yintercept = 5, color = "grey50", linetype = "dotted") +
  scale_y_continuous(
    name = "Percent Missing",
    breaks = seq(0, 100, 10), labels = paste0(seq(0, 100, 10), "%")
  ) +
  labs(title = "Percent of Patient-Days\nwith Missing Values,\nIn-ICU Outcomes & Covariates",
       x = "")

## Use labels instead of variable names, as this will go in the supplement
## Modify $data element of miss_plot using named vector (varname = varlabel)
var_labels <- set_names(
  c("ID", "Age category", "Sex", "Race", "Hispanic ethnicity", "BMI",
    "Mobility, pre-admission", "Primary admission reason",
    "Residence, pre-admission", "ICU type", "Hospital type", "Site",
    "In ICU today", "Event name", "Comfort care today", "On sedation today",
    "Benzodiazepines today", "Opioids today", "Propofol today",
    "Dexmedetomidine today", "Antipsychotics today", "MV today", "Coma today",
    "Restraints today", "Significant pain today", "Delirium today",
    "ABCDEF Bundle completed, y/n", "ABCDEF Bundle performed, y/n",
    "Proportion Bundle completed", "Proportion Bundle performed",
    "In ICU tomorrow", "MV tomorrow", "Coma next day", "Restraints next day",
    "Significant pain next day", "Delirium next day"),
  names(df_logmods)
)

miss_plot$data$variable <- as.character(var_labels[miss_plot$data$variable])

ggsave(
  filename = "missing_plot.pdf",
  plot = miss_plot,
  device = "pdf",
  path = "pubfigures/pdf",
  height = 7, width = 5
)

ggsave(
  filename = "missing_plot.png",
  plot = miss_plot,
  device = "png",
  path = "pubfigures/png",
  height = 7, width = 5, dpi = png_dpi
)

miss_plot

```

### Strategy for Handling Missingness{#inicumissing}

Often, we would use multiple imputation to handle missingness of a concerning amount; however, this method's effectiveness depends on the *available* data to reliably predict missing values. For the following reasons, we are choosing to limit our analyses to complete cases and not perform multiple imputation:

- Due to differences between units and limits on data collection in deidentified
studies, we are missing key information (eg, severity of illness) which
would help predict missing values.
- Multiple imputation in the context of longitudinal studies is complex and time-consuming.
- Our rates of missingness are generally low, with a few important exceptions as
noted.

### Potential Bias from Missingness

In our case, the biggest drawback of complete case analysis is that our results
could be biased due to differences in the patient-days we would *like* to
include and patients we are *able* to include. This is a limitation of our study
and will need to be kept in mind as we interpret our results. It will be more of
an issue for outcomes with more missingness: eg, there may be major differences in patients or sites which have delirium assessments and those which don't.

The most problematic aspect of missingness in our study is that so much missingness relates to both our exposures (compliance/performance) and our outcomes, specifically delirium, coma, and pain. (For example, if the patient didn't have a pain assessment, they were both not compliant on the ABCDEF bundle *and* are missing a pain outcome.) So by definition, the patients we include in models for those outcomes are likely to have better compliance and performance on the ABCDEF bundle than patients who are excluded for missing data.

### More Details on Missingness
<details>
Other less concerning ways that patients with incomplete data differ from those with complete data include:

- Slightly more likely to be of "other" or multiple races or not have race documented in the EMR; to be Hispanic; and to speak a language other than English
- Slightly more likely to be in a facility prior to admission
- Slightly more likely to be in cardiac/surgical ICU and less likely to be in medical
- More likely to be have neuro, trauma diagnoses and less likely to have Other
- Less likely to have mobility performed
- More likely to be on both MV and sedation
- Slightly more likely to be on restraints, benzodiazepines and propofol
- Slightly less likely to be on opioids and dexmedetomidine

```{r logmods_compare_missing_prep, results = "hide"}
## -- Create data frame to compare days with complete vs incomplete data -------
## We want to compare not only model covariates/outcomes, but also other
## potentially important factors not included in models (eg, restraints, highest
## level of mobility...)
## THEREFORE: Merge important baseline + compliance variables and add indicator
## for whether day had any missingness for these models.

## 1. Create indicators for missingness among model covariates/outcomes
logmods_outcomes <- c("delirium_icu_tmw", "coma_icu_tmw",
                      "sigpain_icu_tmw", "on_mv_icu_f_tmw")
logmods_covars_base <- c("age_cat_mod", "sex_f", "race_cat_mod", "hisp_cat_mod",
                         "bmi", "mob_preadmit", "home_preadmit", "hosp_type",
                         "primary_admit", "icu_type_comb")
logmods_covars_daily <- c("comfort_care_icu", "rcvd_benzo_icu",
                          "rcvd_opioid_icu", "rcvd_propofol_icu",
                          "rcvd_dex_icu", "rcvd_antipsyc_icu", "on_mv_icu_f",
                          "coma_icu")
logmods_exposures <- c("comp_yn_f", "perf_yn_f", "comp_prop", "perf_prop")
logmods_covars <-
  c(logmods_covars_base, logmods_covars_daily, logmods_exposures)

df_logmods_missing <- df_logmods
df_logmods_missing$comp_outcomes <-
  rowSums(is.na(df_logmods_missing[ , logmods_outcomes])) == 0
df_logmods_missing$comp_covars <-
  rowSums(is.na(df_logmods_missing[ , logmods_covars])) == 0

df_logmods_missing$comp_data <-
  with(df_logmods_missing, comp_outcomes & comp_covars)
df_logmods_missing$comp_data_f <- with(df_logmods_missing, {
  factor(as.numeric(comp_data),
         levels = 0:1,
         labels = c("Incomplete data", "Complete data"))
})

## 2. Merge on other baseline and daily variables; recode long factor levels
df_logmods_missing <- df_logmods_missing %>%
  left_join(
    dplyr::select(demog, id, hosp_f, english_f, ad_directive_f), by = "id"
  ) %>%
  left_join(dplyr::select(
    compliance,
    id, redcap_event_name_f, mobilityperformed_f, family_present_icu_f,
    had_painasmt_icu, had_sedasmt_icu, had_delasmt_icu, elements_elig
  ),
  by = c("id", "redcap_event_name_f")) %>%
  ## Recode long factor levels
  mutate(
    comp_yn_f = fct_recode(comp_yn_f, Comp = "Compliant", Non = "Noncompliant"),
    perf_yn_f = fct_recode(perf_yn_f,
                           Perf = "Performed", Not = "Not performed"),
    english_f = fct_recode(
      english_f,
      Eng = "English Speaking", Other = "Non-English Speaking"
    ),
    race_cat_mod = fct_recode(
      race_cat_mod,
      "Black AA" = "Black/African-American",
      "AI, AK, HI" = "Amer Indian/AK Native or HI/Pacific Isl",
      Other = "Other race, multiple races, or not specified"
    ),
    hisp_cat_mod = fct_recode(
      hisp_cat_mod, Hisp = "Hispanic", Non = "Non-Hispanic"
    ),
    icu_type_comb = fct_recode(
      icu_type_comb,
      Mixed = "Mixed medical/surgical",
      Med = "Medical",
      "Surg/Trauma" = "Surgical/trauma",
      "Cardiac/Surg" = "Cardiac/surgical"
    ),
    primary_admit = fct_recode(
      primary_admit,
      Sepsis = "Sepsis/septic shock or ARDS",
      Resp = "Respiratory",
      Neuro = "Neurologic",
      GU = "Genitourinary",
      "OD/WD" = "Overdose/withdrawal"
    ),
    family_present_icu_f = fct_recode(
      family_present_icu_f, No = "Not documented present", Yes = "Present"
    ),
    home_preadmit = fct_recode(
      home_preadmit, No = "Facility pre-admission", Yes = "Home pre-admission"
    ),
    mob_preadmit = fct_recode(
      mob_preadmit,
      Unrestr = "No restrictions pre-admission",
      Restr = "Mobility restricted pre-admission"
    ),
    had_delasmt_icu = fct_recode(
      had_delasmt_icu, Yes = ">=1 assessment", No = "No assessment"
    ),
    had_painasmt_icu = fct_recode(
      had_painasmt_icu, Yes = ">=1 assessment", No = "No assessment"
    ),
    had_sedasmt_icu = fct_recode(
      had_sedasmt_icu, Yes = ">=1 assessment", No = "No assessment"
    ),
    mobilityperformed_f = fct_recode(
      mobilityperformed_f,
      Contra = "No, patient failed the safety screen/contraindicated",
      No = "Not performed /not documented"
    ),
    on_mv_icu_f = fct_recode(
      on_mv_icu_f, No = "Not on MV", Yes = "Received MV"
    ),
    on_mv_icu_f_tmw = fct_recode(
      on_mv_icu_f_tmw, No = "Not on MV", Yes = "Received MV"
    ),
    on_sedation_icu_f = fct_recode(
      on_sedation_icu_f,
      Yes = "Continuous/intermittent sedation",
      "No/PRN" = "No or PRN sedation only"
    ),
    sigpain_icu = fct_recode(
      sigpain_icu,
      No = "No significant pain",
      Yes = "Significant pain (self-report or BPS)"
    ),
    sigpain_icu_tmw = fct_recode(
      sigpain_icu_tmw,
      No = "No significant pain",
      Yes = "Significant pain (self-report or BPS)"
    )
  )

## For categorical variables, we'll do faceted dotcharts
df_logmods_missing_plotcat <- df_logmods_missing %>%
  dplyr::select(-one_of("id", "redcap_event_name_f", "bmi", "icu_day",
                        "icu_day_tmw", "comp_prop", "perf_prop",
                        "comp_outcomes", "comp_covars",
                        "comp_data", "elements_elig")) %>%
  gather(key = varname, value = varvalue, -comp_data_f) %>%
  group_by(comp_data_f, varname, varvalue) %>%
  summarise(varvalue_n = n()) %>%
  mutate(varvalue_prop = ifelse(
    comp_data_f == "Complete data",
    varvalue_n / sum(df_logmods_missing$comp_data),
    varvalue_n / sum(!df_logmods_missing$comp_data))) %>%
  ungroup()

logmods_miss_cat <-
  ggplot(data = df_logmods_missing_plotcat,
         aes(x = varvalue, y = varvalue_prop, fill = comp_data_f)) +
  facet_wrap(~ varname, scales = "free_x") +
  geom_bar(stat = "identity", position = "dodge", width = 0.25) +
  scale_fill_manual(values = as.character(magglass_colors[c("c", "f")])) +
  scale_y_continuous(name = "Proportion of Patient-Days",
                     breaks = seq(0, 1, 0.25),
                     labels = paste0(seq(0, 1, 0.25) * 100, "%")) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.direction = "horizontal",
        legend.title = element_blank(),
        axis.text.x = element_text(size = 6, angle = 45, hjust = 1, vjust = 1))

## For continuous-ish variables, we'll do dodged histograms
df_logmods_missing_plotcont <- df_logmods_missing %>%
  dplyr::select(comp_data_f, comp_prop, perf_prop, elements_elig) %>%
  gather(key = varname, value = varvalue, -comp_data_f) %>%
  mutate(varname = fct_relevel(
    varname, "elements_elig", "comp_prop", "perf_prop"
  )
  )

logmods_miss_cont <-
  ggplot(data = df_logmods_missing_plotcont,
         aes(x = varvalue, fill = comp_data_f)) +
  facet_wrap(~ varname, scales = "free") +
  geom_histogram(position = "dodge") +
  scale_fill_manual(values = as.character(magglass_colors[c("c", "f")])) +
  scale_x_continuous(name = "") +
  scale_y_continuous(name = "Frequency") +
  theme_minimal() +
  theme(legend.position = "top",
        legend.direction = "horizontal",
        legend.title = element_blank(),
        axis.text.x = element_text(size = 8, angle = 45, hjust = 1, vjust = 1))
  
```

```{r logmods_missing_cat, fig.height = 8, fig.width = 5}
logmods_miss_cat

```

```{r logmods_missing_cont, fig.height = 3, fig.width = 5}
logmods_miss_cont

```
</details>

```{r logmod_prep, results = "hide"}
## -- Create regex for replacing linear continuous variables with rcs() --------
rcs_vars <- c(
  "icu_los_edit", "rcvd_benzo_icu_prop", "rcvd_opioid_icu_prop",
  "rcvd_propofol_icu_prop", "rcvd_dex_icu_prop", "rcvd_antipsyc_icu_prop",
  "comfort_care_icu_prop", "on_mv_icu_prop", "coma_icu_prop", "bmi",
  "comp_prop", "perf_prop", "comp_elem_prop", "perf_elem_prop", "comp_yn_prop",
  "perf_yn_prop"
)

rcs_regex <- paste0(
  "(^",
  paste(gsub("_", "\\_", rcs_vars, fixed = TRUE), collapse = "|"),
  "$)"
)

## Set datadist. We must always set datadist. Set it to the mother dataset.
dd_logmods <- datadist(df_logmods)
options(datadist = "dd_logmods")

## -- Function to fit logistic regression model --------------------------------
fit_daily_lrm <- function(
  outcome = c("on_mv_icu_f_tmw", "coma_icu_tmw",
              "delirium_icu_tmw", "on_restraints_icu_tmw",
              "ever_readmit_icu"),
  exposure = c("comp_yn_f", "comp_prop", "perf_yn_f", "perf_prop",
               "comp_yn_prop", "comp_elem_prop",
               "perf_yn_prop", "perf_elem_prop"),
  covars = c(logmods_covars_base, logmods_covars_daily),
  df = df_logmods
){
  
  ## -- Set model formula ------------------------------------------------------
  ## Add delirium/restraints as a covariate for those outcomes
  if(outcome %in% c("delirium_icu_tmw", "on_restraints_icu_tmw")){
    covars <- c(covars, gsub("_tmw", "", outcome, fixed = TRUE))
  }
  
  ## Add exposure to RHS
  covars <- c(covars, exposure)
  
  ## Make BMI, proportion of compliance/performance nonlinear terms
  covars <- str_replace(covars, rcs_regex, "rcs\\(\\1, 3\\)")
  
  ## Put RHS together
  rhs <- paste(covars, collapse = " + ")
  
  ## Assemble entire formula
  modform <- as.formula(paste(outcome, rhs, sep = " ~ "))
  
  ## -- Fit model using lrm, then adjust SEs using robcov() --------------------
  mod <- lrm(modform, data = df, x = TRUE, y = TRUE) %>%
    robcov(cluster = df$hosp_f)
  
  return(mod)
}

# ## Test function on a couple of exposures
# 
# df_logmod_mv <- df_logmods %>%
#   dplyr::select(id, on_mv_icu_f_tmw, one_of(logmods_covars))
# df_logmod_mv$include <-
#   rowSums(is.na(df_logmod_mv[, 1:ncol(df_logmod_mv)])) == 0
# 
# mv_compyn_fxn <- fit_daily_lrm(
#   outcome = "on_mv_icu_f_tmw",
#   exposure = "comp_yn_f",
#   df = subset(df_logmod_mv, include)
# )
# mv_compyn_man <- lrm(
#   on_mv_icu_f_tmw ~
#     ## Baseline/ICU admission
#     age_cat_mod + sex_f + race_cat_mod + hisp_cat_mod + mob_preadmit +
#     home_preadmit + primary_admit + icu_type_comb + hosp_type + rcs(bmi, 5) +
#     ## Daily
#     rcvd_benzo_icu + rcvd_opioid_icu + rcvd_propofol_icu + rcvd_dex_icu +
#     rcvd_antipsyc_icu + on_mv_icu_f + coma_icu + comfort_care_icu +
#     ## Exposure
#     comp_yn_f,
#   data = subset(df_logmod_mv, include),
#   x = TRUE, y = TRUE
# ) %>%
#   robcov(cluster = subset(df_logmod_mv, include)$hosp_f)
# 
# anova(mv_compyn_fxn)
# anova(mv_compyn_man)
# 
# mv_compdose_fxn <- fit_daily_lrm(
#   outcome = "on_mv_icu_f_tmw",
#   exposure = "comp_prop",
#   df = subset(df_logmod_mv, include)
# )
# mv_compdose_man <- lrm(
#   on_mv_icu_f_tmw ~
#     ## Baseline/ICU admission
#     age_cat_mod + sex_f + race_cat_mod + hisp_cat_mod + mob_preadmit +
#     home_preadmit + primary_admit + icu_type_comb + hosp_type + rcs(bmi, 5) +
#     ## Daily
#     rcvd_benzo_icu + rcvd_opioid_icu + rcvd_propofol_icu + rcvd_dex_icu +
#     rcvd_antipsyc_icu + on_mv_icu_f + coma_icu + comfort_care_icu +
#     ## Exposure
#     rcs(comp_prop, 5),
#   data = subset(df_logmod_mv, include),
#   x = TRUE, y = TRUE
# ) %>%
#   robcov(cluster = subset(df_logmod_mv, include)$hosp_f)
# 
# anova(mv_compdose_fxn)
# anova(mv_compdose_man)

## -- Function to extract odds ratios from a given model fit -------------------
get_daily_ors <- function(modobj,
                          exposure = c("comp_yn_f", "comp_prop",
                                       "perf_yn_f", "perf_prop",
                                       "comp_yn_prop", "perf_yn_prop",
                                       "comp_elem_prop", "perf_elem_prop"),
                          df = df_logmods){
  if(exposure == "comp_yn_f"){
    reflevel <- "Noncompliant"
    complevels <- levels(df[,exposure])
  } else if(exposure == "perf_yn_f"){
    reflevel <- "Not performed"
    complevels <- levels(df[,exposure])
  } else{
    reflevel <- 0
    complevels <- as.numeric(
      quantile(
        c(df_logmods$comp_prop, df_logmods$perf_prop),
        probs = seq(0, 1, 0.2),
        na.rm = TRUE
      )
    )
  }
  
  rms_calc_comparisons(
    rmsObj = modobj,
    vname = exposure,
    df = df,
    refVal = reflevel,
    compVals = complevels
  )
}

## -- Function to extract p-value for an exposure from a given model fit -------
get_daily_p <- function(modobj,
                        exposure = c("comp_yn_f", "comp_prop",
                                     "perf_yn_f", "perf_prop",
                                     "comp_yn_prop", "perf_yn_prop",
                                     "comp_elem_prop", "perf_elem_prop")){
  anova(modobj)[exposure, "P"]
}

## -- Function to get ORs/P for a given model fit into tibble ------------------
daily_outexp_ors <- function(modobj, exposure, df = df_logmods){
  ors <- get_daily_ors(modobj = modobj, exposure = exposure, df = df)
  pval <- get_daily_p(modobj = modobj, exposure = exposure)
  ors$pval <- pval
  ors
}

## -- Function to get predicted probs for a continuous exposure into tibble ----
get_daily_probs <- function(modobj,
                            exposure = c("comp_prop", "perf_prop",
                                         "comp_yn_prop", "perf_yn_prop",
                                         "comp_elem_prop", "perf_elem_prop"),
                            df = df_logmods){
  tmp <- eval(
    parse(text = sprintf("Predict(modobj, %s = NA, fun = plogis)", exposure))
  ) %>%
    as_tibble() %>%
    dplyr::select(matches(exposure), yhat, lower, upper) %>%
    mutate(exposure = exposure)
  names(tmp) <- gsub(exposure, "prop_done", names(tmp), fixed = TRUE)
  tmp
}

## -- Wrapper function for a specified outcome: --------------------------------
## 1. Fit logistic model (returned as "modobj")
## 2. Get df of odds ratios + p-value (returned as "ors")
## 3. If continuous, get df of predicted probabilities (returned as "probs")
fit_results_lrm <- function(outcome = c("on_mv_icu_f_tmw",
                                        "coma_icu_tmw",
                                        "delirium_icu_tmw",
                                        "on_restraints_icu_tmw",
                                        "ever_readmit_icu"),
                            exposure = c("comp_yn_f", "comp_prop",
                                         "perf_yn_f", "perf_prop",
                                         "comp_yn_prop", "comp_elem_prop",
                                         "perf_yn_prop", "perf_elem_prop"),
                            covars = c(logmods_covars_base,
                                       logmods_covars_daily),
                            df = df_logmods){
  
  mod <- fit_daily_lrm(
    outcome = outcome, exposure = exposure, covars = covars, df = df
  )
  
  ors <- daily_outexp_ors(mod, exposure, df)
  
  if(!(exposure %in% c("comp_yn_f", "perf_yn_f"))){
    probs <- get_daily_probs(mod, exposure, df)
  } else{
    probs <- NULL
  }
  
  return(list("mod" = mod, "ors" = ors, "probs" = probs))
}

## -- Wrapper to do all exposures for a given outcome --------------------------
outcome_results_lrm <- function(outcome,
                                exposures = logmods_exposures,
                                covars = c(logmods_covars_base,
                                           logmods_covars_daily),
                                df = df_logmods){
  
  ## Get list with results of fit_results_lrm() for each exposure
  modlist <- map(exposures,
                 ~ fit_results_lrm(outcome = outcome,
                                   exposure = .,
                                   covars = covars, df = df))
  
  ## Pull out list of model fits only
  mods <- map(modlist, "mod")
  
  ## Put like results together (ORs, predicted probs)
  or_df <- map_df(modlist, "ors")
  probs_df <- map_df(modlist, "probs")
  
  return(list("ors" = or_df, "probs" = probs_df, "mods" = mods))
}

## -- Functions for in-ICU outcome results -------------------------------------
## -- Function to describe exclusion due to missingness ------------------------
in_icu_exclusion <- function(outcome_df){
  ## It is assumed that outcome_df has a logical variable called `include` that
  ## tells us whether the record will be included in the final model. This is
  ## not ideal practice. If this weren't an hourly project I'd do it better.
  ## SORRY UNIVERSE
  
  ## String describing number of patients, patient-days excluded
  miss_days_n <- nrow(df_logmods) - sum(outcome_df[ , "include"])
  miss_days_pct <- round((miss_days_n / nrow(df_logmods) * 100))
  miss_pts_n <- length(unique(df_logmods$id)) -
    length(unique(subset(outcome_df, include)$id))
  miss_pts_pct <- round((miss_pts_n / length(unique(df_logmods$id)) * 100))
  
  sprintf("Out of %s eligible patient-days, %s patient-days (%s%%) were excluded due to missing data, detailed below. Out of %s patients with an eligible ICU day, %s (%s%%) were completely excluded from this model because of missing data on all their ICU days.",
        format(nrow(df_logmods), big.mark = ","),
        format(miss_days_n, big.mark = ","),
        format(miss_days_pct, big.mark = ","),
        format(length(unique(df_logmods$id)), big.mark = ","),
        format(miss_pts_n, big.mark = ","),
        format(miss_pts_pct, big.mark = ","))
}

## -- Function to get info about patients, days, outcome -----------------------
inicu_outcome_info <- function(outcome, df){
  ## Number of unique patients and days
  ## Number of days with and without outcome
  npts <- length(unique(df[,"id"]))
  ndays <- nrow(df)
  ndays_outcome <- sum(df[,outcome] == levels(df[,outcome])[2], na.rm = TRUE)
  ndays_nooutcome <- sum(df[,outcome] == levels(df[,outcome])[1], na.rm = TRUE)
  
  outcome_info <- sprintf(
    "%s patients included, with a total of %s records\n%s records had outcome the following day; %s did not",
    format(npts, big.mark = ","),
    format(ndays, big.mark = ","),
    format(ndays_outcome, big.mark = ","),
    format(ndays_nooutcome, big.mark = ",")
  )
  
  return(outcome_info)
}

## -- Function to plot odds ratios for compliance & performance ----------------
inicu_or_results <- function(outcome_results, ## result of outcome_results_lrm()
                             outcome_info,    ## result of inicu_outcome_info()
                             outcome_name){   ## name of outcome (eg "MV")
                               
  ors <- outcome_results$ors %>%
    ## We don't want to plot reference levels
    filter(!is.ref) %>%
    mutate(
      ## Prep for separating into indicators for comp vs perf, y/n vs dose
      variable = gsub("\\_f$", "", variable),
      ## We'll order the Y axis labels by this variable later:
      yval = ifelse(comp.c %in% c("Performed", "Compliant"), 0,
                    floor((comp + 0.01) * 100)),
      ## Create text for Y axis labels: comparison + P-value
      ylabel = ifelse(comp.c %in% c("Performed", "Compliant"),
                      "Yes vs No",
                      sprintf("%s%% vs %s%%",
                              trimws(rndformat(comp * 100, 0)),
                              trimws(rndformat(ref * 100, 0)))),
      ## Order so that 100% is on top
      ylabel = fct_reorder(ylabel, yval),
      ## Create OR/CI text to place inside figure
      or_text = sprintf(
        "%s (%s, %s)", rndformat(effect), rndformat(lcl), rndformat(ucl)
      )
    ) %>%
    ## Get indicators for comp vs perf, y/n vs dose
    separate(variable, into = c("cp", "yn_prop"), sep = "_") %>%
    ## Move y/n to top; add p-values to Compliance/Performance labels
    mutate(
      yn_prop = factor(ifelse(yn_prop == "yn", 1, 2),
                       levels = 1:2, labels = c("Overall", "Dose")),
      cp = factor(
        ifelse(cp == "comp", 1, 2),
        levels = 1:2,
        labels = c(
          sprintf(
            "Compliance\n\nP, overall: %s; P, dose: %s",
            formatp(
              subset(outcome_results$ors, variable == "comp_yn_f")$pval[1]
            ),
            formatp(
              subset(outcome_results$ors, variable == "comp_prop")$pval[1]
            )
          ),
          sprintf(
            "Performance\n\nP, overall: %s; P, dose: %s",
            formatp(
              subset(outcome_results$ors, variable == "perf_yn_f")$pval[1]
            ),
            formatp(
              subset(outcome_results$ors, variable == "perf_prop")$pval[1]
            )
          )
        )
      )
    )
  
  orplot <- ggplot(data = ors, aes(x = effect, y = ylabel)) +
    facet_grid(yn_prop ~ cp, scales = "free_y", space = "free_y") +
    geom_vline(xintercept = 1, colour = "grey70",
               linetype = "solid", size = 1) +
    geom_segment(aes(x = lcl, xend = ucl, yend = ylabel, colour = cp)) +
    geom_point(aes(colour = cp)) +
    geom_text(aes(label = or_text),
              x = -0.80, size = 3, hjust = 0, colour = "grey15") +
    scale_x_continuous(name = "Adjusted Odds Ratio (95% Confidence Interval)",
                       ## X limits: -0.5 to ceiling (up to 0.2) of highest UCL
                       limits = c(-0.75, ceiling(max(ors$ucl) / 0.2) * 0.2),
                       breaks = seq(0, 10, 0.2)) +
    scale_y_discrete(name = "") +
    scale_colour_manual(values = as.character(magglass_colors[c("f", "c")])) +
    labs(caption = sprintf("\nOdds ratios below 1 are favorable, indicating a lower likelihood of %s the following day.\n\n%s", outcome_name, outcome_info)) +
    theme_minimal() +
    theme(legend.position = "none",
          strip.text = element_text(face = "bold"),
          strip.background = element_rect(colour = "grey80", fill = "grey90"),
          axis.title.x = element_text(vjust = 0),
          axis.text.y = element_text(face = "bold"),
          panel.background = element_rect(colour = "grey80", fill = NA),
          panel.grid.major.y = element_blank(),
          panel.grid.minor = element_blank(),
          plot.subtitle = element_text(size = 8, face = "italic"),
          plot.caption = element_text(size = 8, face = "italic"))
  
  return(orplot)
}

## -- Function to plot predicted probs for comp/perf doses ---------------------
inicu_prob_results <- function(outcome_results,
                                 ## result of outcome_results_lrm()
                               outcome_info,
                                 ## result of inicu_outcome_info()
                               outcome_name,
                                 ## name of outcome (eg "MV")
                               ## Add raw data? If so, supply variable name, df
                               add_raw = TRUE,
                               outcome, df){
  
  ## Y axis limits are 0-100% if raw data not included, -0.1 - 1.1 if it is
  if(add_raw){
    ylims <- c(-0.1, 1.1)
  } else{
    ylims <- 0:1
  }
                                 
  ## Add faceting variable to predicted probabilities
  probs <- outcome_results$probs %>%
    mutate(cp = factor(ifelse(exposure == "comp_prop", 1, 2),
                       levels = 1:2, labels = c("Compliance", "Performance")))

  probsplot <- ggplot(data = probs, aes(x = prop_done, y = yhat)) +
    facet_wrap( ~ cp, nrow = 1) +
    geom_ribbon(aes(ymin = lower, ymax = upper, fill = cp), alpha = 0.3) +
    geom_line(aes(colour = cp)) +
    scale_x_continuous(name = "Percent of Eligible ABCDEF Bundle Elements Done",
                       limits = 0:1,
                       breaks = seq(0, 1, 0.2),
                       labels = paste0(seq(0, 1, 0.2) * 100, "%")) +
    scale_y_continuous(
      name = sprintf("Adjusted Probability of %s the Following Day",
                     outcome_name),
      limits = ylims,
      breaks = seq(0, 1, 0.2),
      labels = paste0(seq(0, 1, 0.2) * 100, "%")
    ) +
    scale_fill_manual(values = as.character(magglass_colors[c("f", "c")])) +
    scale_colour_manual(values = as.character(magglass_colors[c("f", "c")])) +
    theme_minimal() +
    theme(legend.position = "none",
          strip.text = element_text(face = "bold"),
          strip.background = element_rect(colour = "grey80", fill = "grey90"),
          panel.background = element_rect(colour = "grey80", fill = NA),
          plot.subtitle = element_text(size = 8, face = "italic"),
          plot.caption = element_text(size = 8, face = "italic"))
  
  ## Create dataset for and add raw points if requested
  if(add_raw){
    tmp <- df %>%
      dplyr::select(comp_prop, perf_prop, matches(outcome)) %>%
      gather(key = exposure, value = prop_done, comp_prop, perf_prop)
    
    ## yhat = -0.05 if patient had ref level, 1.05 = if patient had outcome
    ## This used to be in mutate(); guessing this is where tidyeval would help
    tmp$yhat <- as.numeric(tmp[, outcome] == levels(tmp[, outcome])[2])
    tmp$yhat <- ifelse(tmp$yhat == 0, -0.05, 1.05)
    ## Faceting variable to match predicted probabilities
    tmp$cp <- factor(ifelse(tmp$exposure == "comp_prop", 1, 2),
                     levels = 1:2, labels = c("Compliance", "Performance"))
    
    probsplot <- probsplot +
      geom_point(aes(x = prop_done, y = yhat, colour = cp),
                 position = position_jitter(height = 0.05, width = 0.05),
                 alpha = 0.01,
                 data = tmp) +
    labs(caption = sprintf("\nLower probabilities are favorable, indicating a lower likelihood of %s the following day.\n\nPoints above are unadjusted, raw data, where patientswith %s the following day\nare at 100%% and patients without the outcome are at 0%%.\n\n%s", outcome_name, outcome_name, outcome_info))
  } else{
    probsplot <- probsplot +
      labs(caption = sprintf("\nLower probabilities are favorable, indicating a lower likelihood of %s the following day.\n\n%s", outcome_name, outcome_info))
  }

  return(probsplot)
}

```

## ABCDEF Bundle vs Mechanical Ventilation

We used a logistic regression model with Huber-White sandwich estimation, clustered by patient, to assess the relationships of our measures of compliance and performance of the ABCDEF Bundle on a given day with the likelihood of being on mechanical ventilation the following day.

```{r mvmods, results = "hide"}
## -- Create dataset with only complete records --------------------------------
mv_vars <- c("on_mv_icu_f_tmw", logmods_covars_base, logmods_covars_daily)
df_logmod_mv <- df_logmods
df_logmod_mv$include <- rowSums(is.na(df_logmod_mv[,mv_vars])) == 0

## Summarize missing data before we dump records
miss_var_mv <- miss_var_summary(subset(df_logmod_mv, !include)) %>%
  filter(pct_miss > 0 & variable %in% mv_vars)

## Get info statement for exclusions due to missingness
miss_info_mv <- in_icu_exclusion(df_logmod_mv)

## Remove records with incomplete data
df_logmod_mv <- subset(df_logmod_mv, include)

## -- Fit models and get results -----------------------------------------------
mv_results <-
  outcome_results_lrm(outcome = "on_mv_icu_f_tmw", df = df_logmod_mv)

## String describing outcome, patients, days
mv_info <- inicu_outcome_info(outcome = "on_mv_icu_f_tmw", df = df_logmod_mv)

## Plot of odds ratios/CIs
mv_orplot <- inicu_or_results(
  outcome_results = mv_results, outcome_info = mv_info, outcome_name = "MV"
)
## Plot of predicted probabilities
mv_probplot <- inicu_prob_results(
  outcome_results = mv_results,
  outcome_name = "MV",
  outcome_info = mv_info,
  add_raw = TRUE,
  outcome = "on_mv_icu_f_tmw",
  df = df_logmod_mv
)

```

### Summary of Results

After adjusting for available confounders, both better compliance and better performance of the ABCDEF Bundle on a given day are associated with a lower likelihood of being on mechanical ventilation the following day among the patients we were able to include in our model.

### Details of Missingness and Results

`r miss_info_mv`

`r table_nums("missing_mv", display = "cite")` describes the proportion of the
`r format(nrow(df_logmods) - nrow(df_logmod_mv), big.mark = ",")` patient-days
excluded from the MV model due to incomplete data which were missing each
covariate/outcome.

#### `r table_nums("missing_mv")`
```{r missing_mv, results = "asis"}
pander(as.data.frame(miss_var_mv), digits = 2, style = "rmarkdown")

```

`r figure_nums("ors_mv", display = "cite")` presents odds ratios for all measures of compliance and performance (complete compliance/performance,
and "dose" = [number of elements done / number of elements eligible]) on a given
day vs mechanical ventilation the following day. `r figure_nums("probs_mv", display = "cite")` presents the adjusted probability of mechanical ventilation the following day for each "dose" of compliance and performance. (Adjusted probabilities for *overall* compliance/performance would only be a single point + confidence interval and thus are not plotted.)

#### `r figure_nums("ors_mv")`

The top panels of `r figure_nums("ors_mv", display = "cite")` show the odds ratio for being on MV for patients with complete vs incomplete Bundle compliance or performance, after adjusting for all specified covariates. For example, assuming all other factors are equal and looking at compliance as purely yes/no, a patient with complete Bundle compliance has `r round(subset(mv_results$ors, variable == "comp_yn_f" & !is.ref)$effect * 100)`% the odds of mechanical ventilation the following day, on average, than a patient with no or incomplete Bundle compliance.

The bottom panels show the odds ratios for various "doses" of compliance or performance compared to none. For example, assuming all other factors are equal and looking at compliance as a dose, a patient with 60% Bundle compliance has `r round(subset(mv_results$ors, variable == "comp_prop" & comp == 0.6)$effect * 100)`% the odds of mechanical ventilation the following day, on average, than a patient with no elements compliant.

```{r print_mvors, fig.width = 3.5, fig.height = 3}
mv_orplot

```

#### `r figure_nums("probs_mv")`

For each daily "dose" of Bundle compliance or performance (elements meeting criteria / elements eligible), `r figure_nums("probs_mv", display = "cite")` shows the predicted probabilities of mechanical ventilation the following day (lines), after adjusting for all specified covariates; bands represent 95% confidence intervals. *(Predicted probabilities by overall bundle compliance/performance would be two single numbers, and thus are not plotted.)*

```{r print_mvprobs, fig.width = 3.5, fig.height = 3}
mv_probplot

```

## ABCDEF Bundle vs Coma

We used a logistic regression model with Huber-White sandwich estimation, clustered by patient, to assess the relationships of our measures of compliance and performance of the ABCDEF Bundle on a given day with the likelihood of being comatose the following day.

```{r comamods, results = "hide"}
## -- Create dataset with only complete records --------------------------------
coma_vars <- c("coma_icu_tmw", logmods_covars_base, logmods_covars_daily)
df_logmod_coma <- df_logmods
df_logmod_coma$include <- rowSums(is.na(df_logmod_coma[,coma_vars])) == 0

## Summarize missing data before we dump records
miss_var_coma <- miss_var_summary(subset(df_logmod_coma, !include)) %>%
  filter(pct_miss > 0 & variable %in% coma_vars)

## Get info statement for exclusions due to missingness
miss_info_coma <- in_icu_exclusion(df_logmod_coma)

## Remove records with incomplete data
df_logmod_coma <- subset(df_logmod_coma, include)

## -- Fit models and get results -----------------------------------------------
coma_results <-
  outcome_results_lrm(outcome = "coma_icu_tmw", df = df_logmod_coma)

## String describing outcome, patients, days
coma_info <- inicu_outcome_info(outcome = "coma_icu_tmw", df = df_logmod_coma)

## Plot of odds ratios/CIs
coma_orplot <- inicu_or_results(
  outcome_results = coma_results,
  outcome_info = coma_info,
  outcome_name = "coma"
)
## Plot of predicted probabilities
coma_probplot <- inicu_prob_results(
  outcome_results = coma_results,
  outcome_name = "coma",
  outcome_info = coma_info,
  add_raw = TRUE,
  outcome = "coma_icu_tmw",
  df = df_logmod_coma
)

```

### Summary of Results

After adjusting for available confounders, we see no strong evidence that compliance on the ABCDEF bundle on a given day is associated with coma the following day. We do, however, see a meaningful association between bundle *performance* and a lower likelihood of being comatose the following day among the patient-days we were able to include in our model.

Lack of association could be due to a true lack of association, or the relatively low proportion of coma days in our cohort (approximately `r rndformat(mean(df_logmods$coma_icu_tmw == "Yes", na.rm = TRUE) * 100, 0)`% of patient-days following ABCDEF bundle exposure), or other factors.

### Details of Missingness and Results

`r miss_info_coma`

`r table_nums("missing_coma", display = "cite")` describes the proportion of the
`r format(nrow(df_logmods) - nrow(df_logmod_coma), big.mark = ",")` patient-days
excluded from the coma model due to incomplete data which were missing each
covariate/outcome.

#### `r table_nums("missing_coma")`
```{r missing_coma, results = "asis"}
pander(as.data.frame(miss_var_coma), digits = 2, style = "rmarkdown")

```

`r figure_nums("ors_coma", display = "cite")` presents odds ratios for all measures of compliance and performance (complete compliance/performance,
and "dose" = [number of elements done / number of elements eligible]) on a given
day vs coma the following day. `r figure_nums("probs_coma", display = "cite")` presents the adjusted probability of coma the following day for each "dose" of compliance and performance. (Adjusted probabilities for *overall* compliance/performance would only be a single point + confidence interval and thus are not plotted.)

#### `r figure_nums("ors_coma")`

The top panels of `r figure_nums("ors_coma", display = "cite")` show the odds ratio for coma the following day for patients with complete vs incomplete Bundle compliance or performance, after adjusting for all specified covariates. For example, assuming all other factors are equal and looking at compliance as purely yes/no, a patient with complete Bundle compliance has `r round(subset(coma_results$ors, variable == "comp_yn_f" & !is.ref)$effect * 100)`% the odds of coma the following day, on average, than a patient with no or incomplete Bundle compliance.

The bottom panels show the odds ratios for various "doses" of compliance or performance compared to none. For example, assuming all other factors are equal and looking at compliance as a dose, a patient with 60% Bundle compliance has `r round(subset(coma_results$ors, variable == "comp_prop" & comp == 0.6)$effect * 100)`% the odds of coma the following day, on average, than a patient with no elements compliant.

```{r print_comaors, fig.width = 3.5, fig.height = 3}
coma_orplot

```

#### `r figure_nums("probs_coma")`
```{r print_comaprobs, fig.width = 3.5, fig.height = 3}
coma_probplot

```

## ABCDEF Bundle vs Delirium

We used a logistic regression model with Huber-White sandwich estimation, clustered by patient, to assess the relationships of our measures of compliance and performance of the ABCDEF Bundle on a given day with the likelihood of being delirious (vs anything else - could be normal, comatose, or a combination) the
following day.

```{r delmods, results = "hide"}
## -- Create dataset with only complete records --------------------------------
del_vars <- c("delirium_icu_tmw", logmods_covars_base, logmods_covars_daily)
df_logmod_del <- df_logmods
df_logmod_del$include <- rowSums(is.na(df_logmod_del[,del_vars])) == 0

## Summarize missing data before we dump records
miss_var_del <- miss_var_summary(subset(df_logmod_del, !include)) %>%
  filter(pct_miss > 0 & variable %in% del_vars)

## Get info statement for exclusions due to missingness
miss_info_del <- in_icu_exclusion(df_logmod_del)

## Remove records with incomplete data
df_logmod_del <- subset(df_logmod_del, include)

## -- Fit models and get results -----------------------------------------------
del_results <-
  outcome_results_lrm(outcome = "delirium_icu_tmw", df = df_logmod_del)

## String describing outcome, patients, days
del_info <- inicu_outcome_info(outcome = "delirium_icu_tmw", df = df_logmod_del)

## Plot of odds ratios/CIs
del_orplot <- inicu_or_results(
  outcome_results = del_results,
  outcome_info = del_info,
  outcome_name = "delirium"
)
## Plot of predicted probabilities
del_probplot <- inicu_prob_results(
  outcome_results = del_results,
  outcome_name = "delirium",
  outcome_info = del_info,
  add_raw = TRUE,
  outcome = "delirium_icu_tmw",
  df = df_logmod_del
)

```

### Summary of Results

After adjusting for available confounders, we see a significant relationship between both compliance and performance of the ABCDEF bundle on a given day and the likelihood of delirium the following day. When looking at "dose" of both, more compliance/performance is associated with a lower likelihood of delirium.

These results are promising, but again should be interpreted with caution, given the selection bias inherent in our sample - a significant number of patients and patient-days could not be included in these analyses because no delirium assessment was performed.

### Details of Missingness and Results

`r miss_info_del`

`r table_nums("missing_del", display = "cite")` describes the proportion of the
`r format(nrow(df_logmods) - nrow(df_logmod_del), big.mark = ",")` patient-days
excluded from the delirium model due to incomplete data which were missing each
covariate/outcome.

#### `r table_nums("missing_del")`
```{r missing_del, results = "asis"}
pander(as.data.frame(miss_var_del), digits = 2, style = "rmarkdown")

```

`r figure_nums("ors_del", display = "cite")` presents odds ratios for all measures of compliance and performance (complete compliance/performance,
and "dose" = [number of elements done / number of elements eligible]) on a given
day vs delirium the following day. `r figure_nums("probs_del", display = "cite")` presents the adjusted probability of delirium the following day for each "dose" of compliance and performance. (Adjusted probabilities for *overall* compliance/performance would only be a single point + confidence interval and thus are not plotted.)

#### `r figure_nums("ors_del")`

The top panels of `r figure_nums("ors_del", display = "cite")` show the odds ratio for delirium the following day for patients with complete vs incomplete Bundle compliance or performance, after adjusting for all specified covariates. For example, assuming all other factors are equal and looking at compliance as purely yes/no, a patient with complete Bundle compliance has `r round(subset(del_results$ors, variable == "comp_yn_f" & !is.ref)$effect * 100)`% the odds of delirium the following day, on average, than a patient with no or incomplete Bundle compliance.

The bottom panels show the odds ratios for various "doses" of compliance or performance compared to none. For example, assuming all other factors are equal and looking at compliance as a dose, a patient with 60% Bundle compliance has `r round(subset(del_results$ors, variable == "comp_prop" & comp == 0.6)$effect * 100)`% the odds of delirium the following day, on average, than a patient with no elements compliant.

```{r print_delors, fig.width = 3.5, fig.height = 3}
del_orplot

```

#### `r figure_nums("probs_del")`

For each daily "dose" of Bundle compliance or performance (elements meeting criteria / elements eligible), `r figure_nums("probs_del", display = "cite")` shows the predicted probabilities of delirium the following day (lines), after adjusting for all specified covariates; bands represent 95% confidence intervals. *(Predicted probabilities by overall bundle compliance/performance would be two single numbers, and thus are not plotted.)*

```{r print_delprobs, fig.width = 3.5, fig.height = 3}
del_probplot

```

## ABCDEF Bundle vs Physical Restraints

We used a logistic regression model with Huber-White sandwich estimation, clustered by patient, to assess the relationships of our measures of compliance and performance of the ABCDEF Bundle on a given day with the likelihood of being physically restrained the following day.

```{r resmods, results = "hide"}
## -- Create dataset with only complete records --------------------------------
res_vars <-
  c("on_restraints_icu_tmw", logmods_covars_base, logmods_covars_daily)
df_logmod_res <- df_logmods
df_logmod_res$include <- rowSums(is.na(df_logmod_res[,res_vars])) == 0

## Summarize missing data before we dump records
miss_var_res <- miss_var_summary(subset(df_logmod_res, !include)) %>%
  filter(pct_miss > 0 & variable %in% res_vars)

## Get info statement for exclusions due to missingness
miss_info_res <- in_icu_exclusion(df_logmod_res)

## Remove records with incomplete data
df_logmod_res <- subset(df_logmod_res, include)

## -- Fit models and get results -----------------------------------------------
res_results <-
  outcome_results_lrm(outcome = "on_restraints_icu_tmw", df = df_logmod_res)

## String describing outcome, patients, days
res_info <-
  inicu_outcome_info(outcome = "on_restraints_icu_tmw", df = df_logmod_res)

## Plot of odds ratios/CIs
res_orplot <- inicu_or_results(
  outcome_results = res_results,
  outcome_info = res_info,
  outcome_name = "restraints"
)
## Plot of predicted probabilities
res_probplot <- inicu_prob_results(
  outcome_results = res_results,
  outcome_name = "restraints",
  outcome_info = res_info,
  add_raw = TRUE,
  outcome = "on_restraints_icu_tmw",
  df = df_logmod_res
)

```

### Summary of Results

After adjusting for available confounders, we see a significant relationship between both compliance and performance of the ABCDEF bundle on a given day and the likelihood of physical restraints the following day. When looking at "dose" of both, more compliance/performance is associated with a lower likelihood of restraints the following day.

### Details of Missingness and Results

`r miss_info_res`

`r table_nums("missing_res", display = "cite")` describes the proportion of the
`r format(nrow(df_logmods) - nrow(df_logmod_res), big.mark = ",")` patient-days
excluded from the restraints model due to incomplete data which were missing each covariate/outcome.

#### `r table_nums("missing_res")`
```{r missing_res, results = "asis"}
pander(as.data.frame(miss_var_res), digits = 2, style = "rmarkdown")

```

`r figure_nums("ors_res", display = "cite")` presents odds ratios for all measures of compliance and performance (complete compliance/performance,
and "dose" = [number of elements done / number of elements eligible]) on a given
day vs restraints the following day. `r figure_nums("probs_res", display = "cite")` presents the adjusted probability of restraints the following day for each "dose" of compliance and performance. (Adjusted probabilities for *overall* compliance/performance would only be a single point + confidence interval and thus are not plotted.)

#### `r figure_nums("ors_res")`

The top panels of `r figure_nums("ors_res", display = "cite")` show the odds ratio for physical restraints the following day for patients with complete vs incomplete Bundle compliance or performance, after adjusting for all specified covariates. For example, assuming all other factors are equal and looking at compliance as purely yes/no, a patient with complete Bundle compliance has `r round(subset(res_results$ors, variable == "comp_yn_f" & !is.ref)$effect * 100)`% the odds of restraints the following day, on average, than a patient with no or incomplete Bundle compliance.

The bottom panels show the odds ratios for various "doses" of compliance or performance compared to none. For example, assuming all other factors are equal and looking at compliance as a dose, a patient with 60% Bundle compliance has `r round(subset(res_results$ors, variable == "comp_prop" & comp == 0.6)$effect * 100)`% the odds of restraints the following day, on average, than a patient with no elements compliant.

```{r print_resors, fig.width = 3.5, fig.height = 3}
res_orplot

```

#### `r figure_nums("probs_res")`

For each daily "dose" of Bundle compliance or performance (elements meeting criteria / elements eligible), `r figure_nums("probs_res", display = "cite")` shows the predicted probabilities of physical restraints the following day (lines), after adjusting for all specified covariates; bands represent 95% confidence intervals. *(Predicted probabilities by overall bundle compliance/performance would be two single numbers, and thus are not plotted.)*

```{r print_resprobs, fig.width = 3.5, fig.height = 3}
res_probplot

```

## ABCDEF Bundle vs Significant Pain

We used a logistic regression model with Huber-White sandwich estimation, clustered by patient, to assess the relationships of our measures of compliance and performance of the ABCDEF Bundle on a given day with the likelihood of significant pain, per patient self-report *or* validated pain assessment tools, the following day.

```{r painmods, results = "hide"}
## -- Create dataset with only complete records --------------------------------
pain_vars <-
  c("sigpain_icu_tmw", logmods_covars_base, logmods_covars_daily)
df_logmod_pain <- df_logmods
df_logmod_pain$include <- rowSums(is.na(df_logmod_pain[,pain_vars])) == 0

## Summarize missing data before we dump records
miss_var_pain <- miss_var_summary(subset(df_logmod_pain, !include)) %>%
  filter(pct_miss > 0 & variable %in% pain_vars)

## Get info statement for exclusions due to missingness
miss_info_pain <- in_icu_exclusion(df_logmod_pain)

## Remove records with incomplete data
df_logmod_pain <- subset(df_logmod_pain, include)

## -- Fit models and get results -----------------------------------------------
pain_results <-
  outcome_results_lrm(outcome = "sigpain_icu_tmw", df = df_logmod_pain)

## String describing outcome, patients, days
pain_info <-
  inicu_outcome_info(outcome = "sigpain_icu_tmw", df = df_logmod_pain)

## Plot of odds ratios/CIs
pain_orplot <- inicu_or_results(
  outcome_results = pain_results,
  outcome_info = pain_info,
  outcome_name = "pain"
)
## Plot of predicted probabilities
pain_probplot <- inicu_prob_results(
  outcome_results = pain_results,
  outcome_name = "pain",
  outcome_info = pain_info,
  add_raw = TRUE,
  outcome = "sigpain_icu_tmw",
  df = df_logmod_pain
)

```

### Summary of Results

After adjusting for available confounders, we see no significant relationship between overall compliance or performance of the ABCDEF bundle on a given day and the likelihood of significant pain (via self-report or validated tool) the following day. When looking at "dose" of both, more compliance/performance is associated with a *higher* likelihood of significant pain the following day. This unexpected relationship could be true, or could be the result of more compliance/performance -> increased *screening* for pain; recall that only patient-days with documentation of pain report could be included here, so by definition, this is among patient-days where we were "looking" for pain. This could be important selection bias and applies to other in-ICU outcomes as well.

### Details of Missingness and Results

`r miss_info_pain`

`r table_nums("missing_pain", display = "cite")` describes the proportion of the
`r format(nrow(df_logmods) - nrow(df_logmod_pain), big.mark = ",")` patient-days
excluded from the pain model due to incomplete data which were missing each covariate/outcome.

#### `r table_nums("missing_pain")`
```{r missing_pain, results = "asis"}
pander(as.data.frame(miss_var_pain), digits = 2, style = "rmarkdown")

```

`r figure_nums("ors_pain", display = "cite")` presents odds ratios for all measures of compliance and performance (complete compliance/performance,
and "dose" = [number of elements done / number of elements eligible]) on a given
day vs pain the following day. `r figure_nums("probs_pain", display = "cite")` presents the adjusted probability of significant pain the following day for each "dose" of compliance and performance. (Adjusted probabilities for *overall* compliance/performance would only be a single point + confidence interval and thus are not plotted.)

#### `r figure_nums("ors_pain")`

The top panels of `r figure_nums("ors_pain", display = "cite")` show the odds ratio for significant pain the following day for patients with complete vs incomplete Bundle compliance or performance, after adjusting for all specified covariates. For example, assuming all other factors are equal and looking at compliance as purely yes/no, a patient with complete Bundle compliance has `r round(subset(pain_results$ors, variable == "comp_yn_f" & !is.ref)$effect * 100)`% the odds of significant pain the following day, on average, than a patient with no or incomplete Bundle compliance.

The bottom panels show the odds ratios for various "doses" of compliance or performance compared to none. For example, assuming all other factors are equal and looking at compliance as a dose, a patient with 60% Bundle compliance has `r round(subset(pain_results$ors, variable == "comp_prop" & comp == 0.6)$effect * 100)`% the odds of significant pain the following day, on average, than a patient with no elements compliant.

```{r print_painors, fig.width = 3.5, fig.height = 3}
pain_orplot

```

#### `r figure_nums("probs_pain")`

For each daily "dose" of Bundle compliance or performance (elements meeting criteria / elements eligible), `r figure_nums("probs_pain", display = "cite")` shows the predicted probabilities of significant pain the following day (lines), after adjusting for all specified covariates; bands represent 95% confidence intervals. *(Predicted probabilities by overall bundle compliance/performance would be two single numbers, and thus are not plotted.)*

```{r print_painprobs, fig.width = 3.5, fig.height = 3}
pain_probplot

```

```{r functions_tte}
## -- Function to create counting process datasets for time-to-event models ----
create_tte_data <- function(
  time_var, status_var, exposure, daily_df = compliance,
  time_df = demog
){
  use_demog <- time_df %>%
    dplyr::select(id, hosp_f, icu_type_comb,
                  one_of(logmods_covars_base),
                  one_of(c(time_var, status_var)))
  use_demog <- use_demog[use_demog[, time_var] > 0, ]
  use_demog <- use_demog[complete.cases(use_demog), ]
  
  use_comp <- daily_df %>%
    filter(icu_day & study_day <= 7 & id %in% use_demog$id) %>%
    dplyr::select(id, study_day, logmods_covars_daily, one_of(exposure))
  use_comp <- use_comp[complete.cases(use_comp), ]
  
  df_tv <- create_countprocess_data(
    org.data = use_comp,
    id.var = "id",
    record.var = "study_day",
    time.var = time_var,
    event.var = status_var,
    event.string = "Yes",
    data.set = use_demog,
    out.strings = c("No", "Yes")
  ) %>%
    rename(had_event = "died") %>%
    left_join(dplyr::select(use_demog, id, hosp_f, one_of(logmods_covars_base)),
              by = "id")
  
  return(df_tv)
}

## -- Function to fit time-varying Cox proportional hazards model --------------
## Assumes all event indicators are named "had_event" and have levels Yes/No
fit_daily_cph <- function(
  exposure = c("comp_yn_f", "comp_prop", "perf_yn_f", "perf_prop"),
  covars = c(logmods_covars_base, logmods_covars_daily),
  df
){
  
  ## -- Set model formula ------------------------------------------------------
  ## Add exposure to RHS
  covars <- c(covars, exposure)
  
  ## Make BMI, proportion of compliance/performance nonlinear terms
  covars <- str_replace(
    covars, "(^bmi|comp\\_prop|perf\\_prop$)", "rcs\\(\\1, 3\\)"
  )
  
  ## Put RHS together
  rhs <- paste(covars, collapse = " + ")
  
  ## Create Surv object
  survobj <- with(df, {
    Surv(time = start.day,
         time2 = stop.day,
         event = as.numeric(had_event == "Yes"))
  })

  ## Assemble entire formula
  modform <- as.formula(paste("survobj", rhs, sep = " ~ "))
  
  ## -- Fit model using cph, then adjust SEs using robcov() --------------------
  mod <- cph(modform, data = df, x = TRUE, y = TRUE) %>%
    robcov(cluster = df$hosp_f)
  
  return(mod)
}

## -- Wrapper function for a specified outcome: --------------------------------
## 1. Fit CPH model (returned as "modobj"), given an exposure and TTE dataset
## 2. Get df of hazard ratios + p-value (returned as "ors")
## <predicted probabilities don't really apply to Cox models>
fit_results_cph <- function(exposure = c("comp_yn_f", "comp_prop",
                                         "perf_yn_f", "perf_prop"),
                            df_tv,
                            ## Model covariates
                            covars = c(logmods_covars_base,
                                       logmods_covars_daily)
){
  
  mod <- fit_daily_cph(
    exposure = exposure, covars = covars, df = df_tv
  )
  
  ## daily_outexp_ors works for hazard ratios too
  hrs <- daily_outexp_ors(modobj = mod, exposure = exposure, df = df_tv)
  
  return(list("mod" = mod, "hrs" = hrs, "tte_df" = df_tv))
}

## -- Wrapper to do all exposures for a given outcome --------------------------
outcome_results_cph <- function(
  dflist_tv, ## list of dfs created by create_tte_data()
  covars = c(logmods_covars_base, logmods_covars_daily)
){
  
  ## Get list with results of fit_results_cph() for each exposure
  modlist <- map2(.x = logmods_exposures,
                  .y = dflist_tv,
                  ~ fit_results_cph(exposure = .x,
                                    df_tv = .y,
                                    covars = covars))
  
  ## Pull out list of model fits only
  mods <- map(modlist, "mod")
  
  ## Put like results together (ORs, predicted probs)
  hr_df <- map_df(modlist, "hrs")

  return(list("hrs" = hr_df, "mods" = mods))
}

## -- Function to calculate 1) # unique patients, 2) # events in a TTE df ------
tte_outcome_info <- function(df, event_string){
  ## Number of unique patients and days
  ## Number of days with and without outcome
  npts <- length(unique(df[,"id"]))
  nevents <- sum(df$had_event == "Yes", na.rm = TRUE)

  outcome_info <- sprintf(
    "%s patients included, with a total of %s %s",
    format(npts, big.mark = ","),
    format(nevents, big.mark = ","),
    event_string
  )
  
  return(outcome_info)
}

## -- Function to plot hazard ratios for compliance & performance --------------
tte_hr_results <- function(
  outcome_results, ## result of outcome_results_cph()
  outcome_info,    ## result of tte_outcome_info()
  ## name of outcome (eg "death")
  outcome_name = c("ICU discharge", "hospital discharge", "death")
){
  
  ## Is HR > 1 favorable or unfavorable? Death is our only bad outcome
  if(str_detect(outcome_name, "death")){
    above_below <- "below"
    higher_lower <- "lower"
  } else{
    above_below <- "above"
    higher_lower <- "higher"
  }

  hrs <- outcome_results$hrs %>%
    ## We don't want to plot reference levels
    filter(!is.ref) %>%
    mutate(
      ## Prep for separating into indicators for comp vs perf, y/n vs dose
      variable = gsub("\\_f$", "", variable),
      ## We'll order the Y axis labels by this variable later:
      yval = ifelse(comp.c %in% c("Performed", "Compliant"), 0,
                    floor((comp + 0.01) * 100)),
      ## Create text for Y axis labels: comparison + P-value
      ylabel = ifelse(comp.c %in% c("Performed", "Compliant"),
                      "Yes vs No",
                      sprintf("%s%% vs %s%%",
                              trimws(rndformat(comp * 100, 0)),
                              trimws(rndformat(ref * 100, 0)))),
      ## Order so that 100% is on top
      ylabel = fct_reorder(ylabel, yval),
      ## Create OR/CI text to place inside figure
      hr_text = sprintf(
        "%s (%s, %s)", rndformat(effect), rndformat(lcl), rndformat(ucl)
      )
    ) %>%
    ## Get indicators for comp vs perf, y/n vs dose
    separate(variable, into = c("cp", "yn_prop"), sep = "_") %>%
    ## Move y/n to top; add p-values to Compliance/Performance labels
    mutate(
      yn_prop = factor(ifelse(yn_prop == "yn", 1, 2),
                       levels = 1:2, labels = c("Overall", "Dose")),
      cp = factor(
        ifelse(cp == "comp", 1, 2),
        levels = 1:2,
        labels = c(
          sprintf(
            "Compliance\n\nP, overall: %s; P, dose: %s",
            formatp(
              subset(outcome_results$hrs, variable == "comp_yn_f")$pval[1]
            ),
            formatp(
              subset(outcome_results$hrs, variable == "comp_prop")$pval[1]
            )
          ),
          sprintf(
            "Performance\n\nP, overall: %s; P, dose: %s",
            formatp(
              subset(outcome_results$hrs, variable == "perf_yn_f")$pval[1]
            ),
            formatp(
              subset(outcome_results$hrs, variable == "perf_prop")$pval[1]
            )
          )
        )
      )
    )
  
  hrplot <- ggplot(data = hrs, aes(x = effect, y = ylabel)) +
    facet_grid(yn_prop ~ cp, scales = "free_y", space = "free_y") +
    geom_vline(xintercept = 1, colour = "grey70",
               linetype = "solid", size = 1) +
    geom_segment(aes(x = lcl, xend = ucl, yend = ylabel, colour = cp)) +
    geom_point(aes(colour = cp)) +
    geom_text(aes(label = hr_text),
              x = -0.80, size = 3, hjust = 0, colour = "grey15") +
    scale_x_continuous(name = "Adjusted Hazard Ratio (95% Confidence Interval)",
                       ## X limits: -0.5 to ceiling (up to 0.2) of highest UCL
                       limits = c(-0.75, ceiling(max(hrs$ucl) / 0.2) * 0.2),
                       breaks = seq(0, 10, 0.2)) +
    scale_y_discrete(name = "") +
    scale_colour_manual(values = as.character(magglass_colors[c("f", "c")])) +
    labs(
      caption = sprintf(
        "\nHazard ratios %s 1 are favorable, indicating a %s likelihood of %s the following day.\n\n%s",
        above_below, higher_lower, outcome_name, outcome_info
      )
    ) +
    theme_minimal() +
    theme(legend.position = "none",
          strip.text = element_text(face = "bold"),
          strip.background = element_rect(colour = "grey80", fill = "grey90"),
          axis.title.x = element_text(vjust = 0),
          axis.text.y = element_text(face = "bold"),
          panel.background = element_rect(colour = "grey80", fill = NA),
          panel.grid.major.y = element_blank(),
          panel.grid.minor = element_blank(),
          plot.subtitle = element_text(size = 8, face = "italic"),
          plot.caption = element_text(size = 8, face = "italic"))
  
  return(hrplot)
}

```

```{r tte_dataprep}
## -- Add needed variables to demog for all time-to-event models: --------------
# ## Check: How many patients have ICU days entered *after* their supposed ICU
# ## or hospital length of stay was over?
# iculos_check <- demog %>%
#   filter((icu_los + 0.5) < last_icu_day) %>%
#   mutate(diff_los = last_icu_day - icu_los)
# 
# hosplos_check <- demog %>%
#   filter((hosp_los + 0.5) < last_icu_day) %>%
#   mutate(diff_los = last_icu_day - hosp_los)

## 1. Time to event
## 2. Whether event occurred
demog <- demog %>%
  mutate(
    ## A substantial number of patients have more ICU days entered in the
    ## database than their recorded ICU and/or hospital LOS. I'll assume that we
    ## should trust the effort it takes to enter ICU data more than the single
    ## data entry point of ICU or hospital LOS, and therefore create new LOS
    ## variables incorporating that decision.
    icu_los_edit = ifelse((is.na(last_icu_day) | icu_los >= last_icu_day),
                          icu_los,
                          last_icu_day),
    hosp_los_edit = ifelse((is.na(last_icu_day) | hosp_los >= last_icu_day),
                           hosp_los,
                           last_icu_day),
    ## Max of ICU, hospital LOS
    last_los = ifelse(is.na(icu_los_edit) & is.na(hosp_los_edit), NA,
               ifelse(!is.na(icu_los_edit) &
                        (is.na(hosp_los_edit) | icu_los_edit > hosp_los_edit),
                      icu_los_edit, hosp_los_edit)),
    ## Add times, event indicators **within 7 days ** for
    ## - ICU LOS
    ## - hospital LOS
    ## - ICU death
    icu_los_7 = ifelse(icu_los_edit > 7, 8, icu_los_edit),
    icu_dc_7 = factor(
      as.numeric(
        ifelse(is.na(dc_status_f) | is.na(icu_los), NA,
               dc_status_f !=
                 "Died in an ICU during the ICU collaborative admission stay" &
                 icu_los <= 7)
      ),
      levels = 0:1, labels = c("No", "Yes")
    ),
    ## Final LOS = max of hospital, ICU LOS
    last_los_7 = ifelse(is.na(last_los), NA,
                 ifelse(last_los > 7, 8, last_los)),
    ## Indicator for hospital discharge
    hosp_dc_7 = factor(
      as.numeric(
        ifelse(is.na(dc_status_f) | is.na(hosp_los), NA,
               dc_status_f == "Discharged from the hospital alive" &
                 last_los <= 7)
      ),
      levels = 0:1, labels = c("No", "Yes")
    ),
    ## Indicator for hospital death
    hosp_death_7 = factor(
      as.numeric(
        ifelse(is.na(dc_status_f) | is.na(last_los_7), NA,
               dc_status_f != "Discharged from the hospital alive" &
                 last_los <= 7)
      ),
      levels = 0:1, labels = c("No", "Yes")
    )
  )

## Does patient have complete data on covariates & outcomes for each TTE model?
demog$elig_iculos <- rowSums(
  is.na(demog[, c("id", logmods_covars_base, "icu_los_7", "icu_dc_7")])
) == 0 & (!is.na(demog$icu_days) & demog$icu_days > 0)
demog$elig_hosplos <- rowSums(
  is.na(demog[, c("id", logmods_covars_base, "last_los_7", "hosp_dc_7")])
) == 0 & (!is.na(demog$icu_days) & demog$icu_days > 0)
demog$elig_death <- rowSums(
  is.na(demog[, c("id", logmods_covars_base, "last_los_7", "hosp_death_7")])
) == 0 & (!is.na(demog$icu_days) & demog$icu_days > 0)

compliance$elig_tte <- rowSums(
  is.na(compliance[, c("id", logmods_exposures, logmods_covars_daily)])
) == 0

## -- Create all time-to-event datasets and save separately --------------------
# ## These take forever to run.
# iculos_dflist <- pmap(
#   .l = list("time_var" = rep("icu_los_7", 4),
#             "status_var" = rep("icu_dc_7", 4),
#             exposure = logmods_exposures),
#   .f = create_tte_data
# )
# 
# hosplos_dflist <- pmap(
#   .l = list("time_var" = rep("last_los_7", 4),
#             "status_var" = rep("hosp_dc_7", 4),
#             exposure = logmods_exposures),
#   .f = create_tte_data
# )
# 
# death_dflist <- pmap(
#   .l = list("time_var" = rep("last_los_7", 4),
#             "status_var" = rep("hosp_death_7", 4),
#             exposure = logmods_exposures),
#   .f = create_tte_data
# )
# 
# save(iculos_dflist, hosplos_dflist, death_dflist,
#      file = "AnalysisData/tte_datasets.Rdata")

load("AnalysisData/tte_datasets.Rdata")

```

# ICU Length of Stay & Readmission

One major question of interest is whether increased use of the ABCDEF Bundle is associated with shorter time to ICU discharge and/or lower rates of readmission. We'll approach this with the following strategies:

1. Looking at daily ABCDEF bundle compliance/performance during the Collaborative ICU stay vs time to ICU discharge, among all patients with at least one full day in the ICU
1. Looking at proportion of ABCDEF bundle compliance/performance during the Collaborative ICU stay vs likelihood of ICU readmission during that hospitalization, among patients who survived the hospitalization (thus having the opportunity to be readmitted)

These strategies require different methods of analysis, and thus will be discussed separately.

## ICU Length of Stay

### Analysis Method & Covariates

We will use a Cox proportional hazards model with time-dependent covariates to assess the relationship between ABCDEF bundle compliance/performance on a given day and the likelihood of being discharged from the ICU. Patients who die prior to ICU discharge will be censored at the time of death; patients who remain in the ICU after day 7 will be censored at day 8. Outcomes are restricted to 7 days because at most sites, data collection on ABCDEF bundle elements stopped on ICU day 7.

We will adjust for the same baseline and daily covariates in the model as for the in-ICU outcomes models (see [previous section](#covariates)).

**Note:** `r format(nrow(subset(demog, icu_days > 0 & !is.na(last_icu_day) & !is.na(icu_los) & last_icu_day > icu_los)), big.mark = ",")` patients had conflicting data for ICU length of stay: More full ICU days were recorded in the compliance form than the total ICU length of stay recorded in the demographic form. In these cases, we assumed that the effort it takes to enter a day of ICU data is more likely to be reliable than a single value in the demographic form, and the final ICU length of stay used in analysis was adjusted to the last ICU day entered in the compliance form. In most cases, the difference is minimal and likely explainable, but there are `r format(nrow(subset(demog, icu_days >= 0 & (last_icu_day - icu_los >= 2))), big.mark = ",")` cases with two or more days' difference between these quantities. 

### Patient Inclusion & Missing Data

We started with `r format(sum(!is.na(demog$icu_days) & demog$icu_days > 0), big.mark = ",")` patients enrolled in the Collaborative with >=1 full day in the ICU; among these, `r format(sum(demog$elig_iculos, na.rm = TRUE), big.mark = ",")` had complete baseline covariates and ICU length of stay data. Details on missingness for these variables among the eligible patients are below.

```{r iculos_missing_base}
gg_miss_var(
  subset(
    demog, !is.na(icu_days) & icu_days > 0
  )[, c(logmods_covars_base, "icu_los_7", "icu_dc_7")],
  show_pct = TRUE)

```

```{r iculos_mods, results = "hide"}
iculos_results <- outcome_results_cph(dflist_tv = iculos_dflist)
iculos_hrplot <- tte_hr_results(
  iculos_results,
  outcome_info = tte_outcome_info(
    df = iculos_dflist[[1]], event_string = "ICU discharges within 7 days"
  ),
  outcome_name = "ICU discharge"
)

```

Among patients with >=1 ICU day and complete baseline and discharge status data, we still had to exclude `r format(sum(demog$elig_iculos, na.rm = TRUE) - length(unique(iculos_dflist[[1]]$id)), big.mark = ",")` patients who had no days of complete daily data.

Further details of missingness and rationale for handling would essentially repeat information included [above](#inicumissingness), as the situations are quite similar; please refer there for details.


### Model Results

After adjusting for potential confounders, both compliance with and performance of the ABCDEF Bundle on a given day are associated with a higher likelihood of ICU discharge; there is a dose-response relationship, such that more compliance and more performance are associated with higher likelihood of ICU discharge.

It is important to note that because most Collaborative sites were only able to collect one week of data, these results only reflect ICU discharges within the first 7 days after ICU admission. ABCDEF Bundle compliance and performance may have different associations with ICU discharge when long ICU stays are able to be included.

#### `r figure_nums("hrs_iculos")`

The top panels of `r figure_nums("hrs_iculos", display = "cite")` show the hazard ratio for ICU discharge for patients with complete vs incomplete Bundle compliance or performance, after adjusting for all specified covariates. For example, assuming all other factors are equal and looking at compliance as purely yes/no, a patient with complete Bundle compliance has `r round(subset(iculos_results$hrs, variable == "comp_yn_f" & !is.ref)$effect * 100)`% the likelihood of ICU discharge the following day, on average, than a patient with no or incomplete Bundle compliance.

The bottom panels show the hazard ratios for various "doses" of compliance or performance compared to none. For example, assuming all other factors are equal and looking at compliance as a dose, a patient with 60% Bundle compliance has `r round(subset(iculos_results$hrs, variable == "comp_prop" & comp == 0.6)$effect * 100)`% the likelihood of discharge the following day, on average, than a patient with no elements compliant.

```{r iculos_plot, fig.width = 3.5, fig.height = 3}
iculos_hrplot

```

```{r functions_summary}
## -- Functions for summary outcomes (ICU readmission, discharge location) -----
## -- Function to describe exclusion due to missingness ------------------------
summary_exclusion <- function(outcome_df){
  ## It is assumed that outcome_df has a logical variable called `include` that
  ## tells us whether the record will be included in the final model. This is
  ## not ideal practice. If this weren't an hourly project I'd do it better.
  ## SORRY UNIVERSE
  
  ## String describing number of patients excluded
  miss_pts_n <- length(unique(outcome_df$id)) -
    length(unique(subset(outcome_df, include)$id))
  miss_pts_pct <- round((miss_pts_n / length(unique(outcome_df$id)) * 100))
  
  sprintf("Out of %s eligible patients, %s (%s%%) were excluded due to missing data, detailed below.",
        format(nrow(outcome_df), big.mark = ","),
        format(miss_pts_n, big.mark = ","),
        format(miss_pts_pct, big.mark = ","))
}

## -- Function to get info about patients, outcome -----------------------------
summary_outcome_info <- function(outcome, had_outcome_string, df){
  ## Number of unique patients and days
  ## Number of days with and without outcome
  npts <- length(unique(df[,"id"]))
  n_outcome <- sum(df[,outcome] == levels(df[,outcome])[2], na.rm = TRUE)
  n_nooutcome <- sum(df[,outcome] == levels(df[,outcome])[1], na.rm = TRUE)
  
  outcome_info <- sprintf(
    "%s patients included; %s were %s, while %s were not.",
    format(npts, big.mark = ","),
    format(n_outcome, big.mark = ","),
    had_outcome_string,
    format(n_nooutcome, big.mark = ",")
  )
  
  return(outcome_info)
}

## -- Function to plot odds ratios for compliance & performance ----------------
summary_or_results <- function(outcome_results, ## result of outcome_results_lrm()
                               outcome_info,  ## result of summary_outcome_info()
                               outcome_name){   ## name of outcome (eg "MV")
                               
  ors <- outcome_results$ors %>%
    ## We don't want to plot reference levels
    filter(!is.ref) %>%
    mutate(
      ## Prep for separating into indicators for comp vs perf, y/n vs dose
      variable = gsub("\\_f$", "", variable),
      ## We'll order the Y axis labels by this variable later:
      yval = ifelse(comp.c %in% c("Performed", "Compliant"), 0,
                    floor((comp + 0.01) * 100)),
      ## Create text for Y axis labels: comparison + P-value
      ylabel = ifelse(comp.c %in% c("Performed", "Compliant"),
                      "Yes vs No",
                      sprintf("%s%% vs %s%%",
                              trimws(rndformat(comp * 100, 0)),
                              trimws(rndformat(ref * 100, 0)))),
      ## Order so that 100% is on top
      ylabel = fct_reorder(ylabel, yval),
      ## Create OR/CI text to place inside figure
      or_text = sprintf(
        "%s (%s, %s)", rndformat(effect), rndformat(lcl), rndformat(ucl)
      )
    ) %>%
    ## Get indicators for comp vs perf, y/n vs dose
    separate(variable, into = c("cp", "yn_elem", "ignore"), sep = "_") %>%
    ## Move y/n to top; add p-values to Compliance/Performance labels
    mutate(
      yn_elem = factor(ifelse(yn_elem == "yn", 1, 2),
                       levels = 1:2, labels = c("Overall", "Dose")),
      cp = factor(
        ifelse(cp == "comp", 1, 2),
        levels = 1:2,
        labels = c(
          sprintf(
            "Compliance\n\nP, overall: %s; P, dose: %s",
            formatp(
              subset(outcome_results$ors, variable == "comp_yn_prop")$pval[1]
            ),
            formatp(
              subset(outcome_results$ors, variable == "comp_elem_prop")$pval[1]
            )
          ),
          sprintf(
            "Performance\n\nP, overall: %s; P, dose: %s",
            formatp(
              subset(outcome_results$ors, variable == "perf_yn_prop")$pval[1]
            ),
            formatp(
              subset(outcome_results$ors, variable == "perf_elem_prop")$pval[1]
            )
          )
        )
      )
    )
  
  orplot <- ggplot(data = ors, aes(x = effect, y = ylabel)) +
    facet_grid(yn_elem ~ cp, scales = "free_y", space = "free_y") +
    geom_vline(xintercept = 1, colour = "grey70",
               linetype = "solid", size = 1) +
    geom_segment(aes(x = lcl, xend = ucl, yend = ylabel, colour = cp)) +
    geom_point(aes(colour = cp)) +
    geom_text(aes(label = or_text),
              x = -0.80, size = 3, hjust = 0, colour = "grey15") +
    scale_x_continuous(name = "Adjusted Odds Ratio (95% Confidence Interval)",
                       ## X limits: -0.5 to ceiling (up to 0.2) of highest UCL
                       limits = c(-0.75, ceiling(max(ors$ucl) / 0.2) * 0.2),
                       breaks = seq(0, 10, 0.2)) +
    scale_y_discrete(name = "") +
    scale_colour_manual(values = as.character(magglass_colors[c("f", "c")])) +
    labs(caption = sprintf("\nOdds ratios below 1 are favorable, indicating a lower likelihood of %s.\n\n%s", outcome_name, outcome_info)) +
    theme_minimal() +
    theme(legend.position = "none",
          strip.text = element_text(face = "bold"),
          strip.background = element_rect(colour = "grey80", fill = "grey90"),
          axis.title.x = element_text(vjust = 0),
          axis.text.y = element_text(face = "bold"),
          panel.background = element_rect(colour = "grey80", fill = NA),
          panel.grid.major.y = element_blank(),
          panel.grid.minor = element_blank(),
          plot.subtitle = element_text(size = 8, face = "italic"),
          plot.caption = element_text(size = 8, face = "italic"))
  
  return(orplot)
}

## -- Function to plot predicted probs for comp/perf doses ---------------------
summary_prob_results <- function(outcome_results,
                                 ## result of outcome_results_lrm()
                                 outcome_info,
                                 ## result of summary_outcome_info()
                                 outcome_name,
                                 ## name of outcome (eg "MV")
                                 ## Add raw data? If so, supply variable name, df
                                 add_raw = TRUE,
                                 outcome, df){
  
  ## Y axis limits are 0-100% if raw data not included, -0.1 - 1.1 if it is
  if(add_raw){
    ylims <- c(-0.1, 1.1)
  } else{
    ylims <- 0:1
  }
                                 
  ## Add faceting variable to predicted probabilities
  probs <- outcome_results$probs %>%
    separate(exposure, into = c("cp", "yn_elem", "ignore")) %>%
    mutate(cp = factor(ifelse(cp == "comp", 1, 2),
                       levels = 1:2, labels = c("Compliance", "Performance")),
           yn_elem = factor(ifelse(yn_elem == "yn", 1, 2),
                            levels = 1:2,
                            labels = c("% of Days (Overall)",
                                       "% of Elements (Dose)")))

  probsplot <- ggplot(data = probs, aes(x = prop_done, y = yhat)) +
    facet_grid(yn_elem ~ cp) +
    geom_ribbon(aes(ymin = lower, ymax = upper, fill = cp), alpha = 0.3) +
    geom_line(aes(colour = cp)) +
    scale_x_continuous(
      name = "Percent of ABCDEF Bundle During Collaborative ICU Stay",
      limits = 0:1,
      breaks = seq(0, 1, 0.2),
      labels = paste0(seq(0, 1, 0.2) * 100, "%")
    ) +
    scale_y_continuous(
      name = sprintf("Adjusted Probability of %s",
                     outcome_name),
      limits = ylims,
      breaks = seq(0, 1, 0.2),
      labels = paste0(seq(0, 1, 0.2) * 100, "%")
    ) +
    scale_fill_manual(values = as.character(magglass_colors[c("f", "c")])) +
    scale_colour_manual(values = as.character(magglass_colors[c("f", "c")])) +
    theme_minimal() +
    theme(legend.position = "none",
          strip.text = element_text(face = "bold"),
          strip.background = element_rect(colour = "grey80", fill = "grey90"),
          panel.background = element_rect(colour = "grey80", fill = NA),
          plot.subtitle = element_text(size = 8, face = "italic"),
          plot.caption = element_text(size = 8, face = "italic"))
  
  ## Create dataset for and add raw points if requested
  if(add_raw){
    tmp <- df %>%
      dplyr::select(comp_yn_prop, comp_elem_prop, perf_yn_prop, perf_elem_prop,
                    matches(outcome)) %>%
      gather(key = exposure, value = prop_done,
             comp_yn_prop, comp_elem_prop, perf_yn_prop, perf_elem_prop) %>%
      ## Faceting variables to match predicted probabilities
      separate(exposure, into = c("cp", "yn_elem", "ignore")) %>%
      mutate(cp = factor(ifelse(cp == "comp", 1, 2),
                         levels = 1:2, labels = c("Compliance", "Performance")),
             yn_elem = factor(ifelse(yn_elem == "yn", 1, 2),
                              levels = 1:2,
                              labels = c("% of Days (Overall)",
                                         "% of Elements (Dose)")))
    
    ## yhat = -0.05 if patient had ref level, 1.05 = if patient had outcome
    ## This used to be in mutate(); guessing this is where tidyeval would help
    tmp$yhat <- as.numeric(tmp[, outcome] == levels(tmp[, outcome])[2])
    tmp$yhat <- ifelse(tmp$yhat == 0, -0.05, 1.05)

    probsplot <- probsplot +
      geom_point(aes(x = prop_done, y = yhat, colour = cp),
                 position = position_jitter(height = 0.05, width = 0.05),
                 alpha = 0.01,
                 data = tmp) +
    labs(caption = sprintf("\nLower probabilities are favorable, indicating a lower likelihood of %s.\n\nPoints above are unadjusted, raw data, where patients %s\nare at 100%% and patients without the outcome are at 0%%.\n\n%s", outcome_name, outcome_name, outcome_info))
  } else{
    probsplot <- probsplot +
      labs(caption = sprintf("\nLower probabilities are favorable, indicating a lower likelihood of %s.\n\n%s", outcome_name, outcome_info))
  }

  return(probsplot)
}

```
## ICU Readmission

### Analysis Method & Covariates

We will use a logistic regression model to assess the relationship between ABCDEF bundle compliance/performance during the Collaborative ICU stay and the likelihood of subsequent readmission to the ICU *among patients who survived the Collaborative ICU stay* and had at least one full day in the ICU. Patients who died during this ICU stay will be excluded, since they didn't have the same opportunity for readmission.

We will adjust for the following baseline and summary covariates (please see
[Variable Calculation](#variables) for more details):

- Demographics
    - Age category
    - Sex
    - Race
    - Ethnicity (Hispanic vs non-Hispanic)
    - BMI
    - Residency prior to admission (home vs facility)
    - Mobility prior to admission (no restrictions vs any)
- Admission characteristics
    - Admission diagnosis category
    - Hospital type (community vs teaching)
    - ICU type
- Summary characteristics of Collaborative ICU stay
    - Total duration in days
    - Proportion of days on:
        - Benzos
        - Opioids
        - Propofol
        - Dex
        - Typical and/or atypical antipsychotics
        - Comfort care
        - MV
        - Coma
- Primary ABCDEF Bundle exposures during Collaborative ICU stay (assessed in separate models):
    - Proportion of *days* completely compliant
    - Proportion of *days* entire Bundle performed
    - Proportion of eligible *elements* compliant over the entire ICU stay
    - Proportion of eligible *elements* performed over the entire ICU stay
    
```{r icureadm_prep}
covars_summary <-
  c("icu_los_edit", "rcvd_benzo_icu_prop", "rcvd_opioid_icu_prop",
    "rcvd_propofol_icu_prop", "rcvd_dex_icu_prop", "rcvd_antipsyc_icu_prop",
    "comfort_care_icu_prop", "on_mv_icu_prop", "coma_icu_prop")

summary_exposures <-
  c("comp_yn_prop", "perf_yn_prop", "comp_elem_prop", "perf_elem_prop")

## Starting dataset: all patients who had >=1 ICU day recorded and survived the
## Collaborative ICU stay
df_icureadm <- demog %>%
  filter(
    icu_days > 0 &
      !is.na(dc_status_f) &
      !(dc_status_f ==
          "Died in an ICU during the ICU collaborative admission stay")
  ) %>%
  dplyr::select(
    id, hosp_f, one_of(logmods_covars_base), one_of(covars_summary),
    one_of(summary_exposures), ever_readmit_icu
  )

df_icureadm$include <- rep(FALSE, nrow(df_icureadm))
df_icureadm$include[complete.cases(df_icureadm)] <- TRUE

## Summarize missingness
miss_icureadm <- summary_exclusion(df_icureadm)

miss_var_icureadm <- miss_var_summary(subset(df_icureadm, !include)) %>%
  filter(pct_miss > 0)

```

### Details of Missingness

`r miss_icureadm`

```{r icureadm_missing}
gg_miss_var(df_icureadm %>% dplyr::select(-id), show_pct = TRUE) +
  geom_hline(yintercept = 5, color = "grey50", linetype = "dotted") +
  labs(title = "Proportion of Patients with Missing Values,\nICU Readmission Exposures and Covariates",
       x = "")

```


`r table_nums("missing_icureadm", display = "cite")` describes the proportion of the `r format(nrow(df_icureadm) - sum(!df_icureadm$include, na.rm = TRUE), big.mark = ",")` otherwise eligible patients excluded from the ICU readmission model due to incomplete data who were missing each covariate/outcome.

#### `r table_nums("missing_icureadm")`
```{r missing_readm, results = "asis"}
pander(as.data.frame(miss_var_icureadm), digits = 2, style = "rmarkdown")

```

### Summary of Model Results
```{r icureadm_mod, results = "hide"}
dd_icureadm <- datadist(df_icureadm)
options(datadist = "dd_icureadm")

icureadm_results <- outcome_results_lrm(
  outcome = "ever_readmit_icu",
  exposures = summary_exposures,
  covars = c(logmods_covars_base, covars_summary),
  df = df_icureadm %>% filter(include)
)

icureadm_outcome_info <- summary_outcome_info(
  outcome = "ever_readmit_icu",
  had_outcome_string = "readmitted to the ICU",
  df = df_icureadm %>% filter(include)
)

icureadm_orplot <- summary_or_results(
  outcome_results = icureadm_results,
  outcome_info = icureadm_outcome_info,
  outcome_name = "readmission"
)

icureadm_probplot <- summary_prob_results(
  outcome_results = icureadm_results,
  outcome_info = icureadm_outcome_info,
  outcome_name = "readmission",
  add_raw = TRUE,
  outcome = "ever_readmit_icu",
  df = df_icureadm %>% filter(include)
)

```

Whether we look at the proportion of days with *total* compliance/performance ("overall"), or the proportion of eligible *elements* compliant or performed ("dose"), throughout the Collaborative ICU stay, we see a mild dose-response relationship such that more compliance or performance is associated with lower likelihood of ICU readmission during the index hospitalization among patients who survived the Collaborative ICU stay.

#### `r figure_nums("ors_icureadm")`

The top panels of `r figure_nums("ors_icureadm", display = "cite")` show the odds ratio for ICU readmission for patients with X% of ICU days meeting criteria for Bundle compliance or performance vs 0% of ICU days meeting criteria, after adjusting for all specified covariates. For example, assuming all other factors are equal and looking at daily compliance as yes/no, a patient with Bundle compliance on 50% of his or her ICU days has `r round(subset(icureadm_results$ors, variable == "comp_yn_prop" & comp == 0.5)$effect * 100)`% the odds of ICU readmission, on average, than a patient with no or incomplete Bundle compliance.

The bottom panels show the odds ratios for X% of *elements* throughout the ICU stay meeting criteria for compliance or performance, compared to none. For example, assuming all other factors are equal, a patient with 60% of eligible Bundle compliant during the ICU stay has `r round(subset(icureadm_results$ors, variable == "comp_elem_prop" & comp == 0.6)$effect * 100)`% the odds of ICU readmission, on average, than a patient with no elements compliant.

```{r print_icureadmors, fig.width = 3.5, fig.height = 3}
icureadm_orplot

```

#### `r figure_nums("probs_icureadm")`

For each daily "dose" of Bundle compliance or performance (elements meeting criteria / elements eligible), `r figure_nums("probs_icureadm", display = "cite")` shows the predicted probabilities of ICU readmission (lines), after adjusting for all specified covariates; bands represent 95% confidence intervals. *(Predicted probabilities by overall bundle compliance/performance would be two single numbers, and thus are not plotted.)*

```{r print_icureadmprobs, fig.width = 3.5, fig.height = 3}
icureadm_probplot

```

# Hospital Length of Stay

We'll examine the association between increased use of the ABCDEF bundle and time to hospital discharge, among all patients with at least one full day in the ICU.

## Analysis Method & Covariates

We will use a Cox proportional hazards model with time-dependent covariates to assess the relationship between ABCDEF bundle compliance/performance on a given day and the likelihood of being discharged from the hospital Patients who die prior to hospital discharge will be censored at the time of death; patients who remain in the hospital after day 7 will be censored at day 8. Outcomes are restricted to 7 days because at most sites, data collection on ABCDEF bundle elements stopped on ICU day 7.

**Important notes**:

1. Because daily data was not collected outside the ICU, days between ICU and hospital discharge are assumed to have the same value for all covariates - including ABCDEF bundle compliance and performance - as the final ICU day. For example, if a patient was discharged to the floor on ICU day 4 and discharged from the hospital on day 7, days 5, 6 and 7 would be assumed to have the same compliance and performance status as day 4.
1. `r format(nrow(subset(demog, icu_days > 0 & !is.na(last_icu_day) & !is.na(hosp_los) & last_icu_day > hosp_los)), big.mark = ",")` patients had conflicting data for hospital length of stay: More full ICU days were recorded in the compliance form than the total hospital length of stay recorded in the demographic form. In these cases, we assumed that the effort it takes to enter a day of ICU data is more likely to be reliable than a single value in the demographic form, and the final hospital length of stay used in analysis was adjusted to the last ICU day entered in the compliance form. In some cases, the difference is minimal and likely explainable, but there are `r format(nrow(subset(demog, icu_days >= 0 & (last_icu_day - hosp_los >= 2))), big.mark = ",")` cases with two or more days' difference between these quantities.

We will adjust for the same baseline and daily covariates in the model as for the in-ICU outcomes models (see [previous section](#covariates)).

## Patient Inclusion & Missing Data

We started with `r format(sum(!is.na(demog$icu_days) & demog$icu_days > 0), big.mark = ",")` patients enrolled in the Collaborative with >=1 full day in the ICU; among these, `r format(sum(demog$elig_hosplos, na.rm = TRUE), big.mark = ",")` had complete baseline covariates and ICU length of stay data. Details on missingness for these variables among the eligible patients are below.

```{r hosplos_missing_base}
gg_miss_var(
  subset(
    demog, !is.na(icu_days) & icu_days > 0
  )[, c(logmods_covars_base, "last_los_7", "hosp_dc_7")],
  show_pct = TRUE)

```

```{r hosplos_mods, results = "hide"}
options(datadist = "dd_logmods")

hosplos_results <- outcome_results_cph(dflist_tv = hosplos_dflist)
hosplos_hrplot <- tte_hr_results(
  hosplos_results,
  outcome_info = tte_outcome_info(
    df = hosplos_dflist[[1]], event_string = "hospital discharges within 7 days"
  ),
  outcome_name = "hospital discharge"
)

```

Among patients with >=1 ICU day and complete baseline and discharge status data, we still had to exclude `r format(sum(demog$elig_hosplos, na.rm = TRUE) - length(unique(hosplos_dflist[[1]]$id)), big.mark = ",")` patients who had no days of complete daily data.

Further details of missingness and rationale for handling would essentially repeat information included [above](#inicumissingness), as the situations are quite similar; please refer there for details.

## Model Results

After adjusting for potential confounders, both compliance with and performance of the ABCDEF Bundle on a given day are associated with a higher likelihood of hospital discharge; there is a dose-response relationship, such that more compliance and more performance are associated with higher likelihood of discharge.

It is important to note that because most Collaborative sites were only able to collect one week of data, these results only reflect hospital discharges within the first 7 days after ICU admission. ABCDEF Bundle compliance and performance may have different associations with hospital discharge when longer hospital stays are able to be more included in more detail.

### `r figure_nums("hrs_hosplos")`

The top panels of `r figure_nums("hrs_hosplos", display = "cite")` show the hazard ratio for hospital discharge for patients with complete vs incomplete Bundle compliance or performance, after adjusting for all specified covariates. For example, assuming all other factors are equal and looking at compliance as purely yes/no, a patient with complete Bundle compliance has `r round(subset(hosplos_results$hrs, variable == "comp_yn_f" & !is.ref)$effect * 100)`% the likelihood of hospital discharge the following day, on average, than a patient with no or incomplete Bundle compliance.

The bottom panels show the hazard ratios for various "doses" of compliance or performance compared to none. For example, assuming all other factors are equal and looking at compliance as a dose, a patient with 60% Bundle compliance has `r round(subset(hosplos_results$hrs, variable == "comp_prop" & comp == 0.6)$effect * 100)`% the likelihood of discharge the following day, on average, than a patient with no elements compliant.

```{r hosplos_plot, fig.width = 3.5, fig.height = 3}
hosplos_hrplot

```

# Mortality

We'll examine the association between increased use of the ABCDEF bundle and time to death within 7 days, among all patients with at least one full day in the ICU.

## Analysis Method & Covariates

We will use a Cox proportional hazards model with time-dependent covariates to assess the relationship between ABCDEF bundle compliance/performance on a given day and the likelihood of death. Patients who are successfully discharged prior to 7 days will be censored at the time of discharge; patients who remain in the hospital after day 7 will be censored at day 8. Outcomes are restricted to 7 days because at most sites, data collection on ABCDEF bundle elements stopped on ICU day 7.

**Important notes**:

1. Because daily data was not collected outside the ICU, any days between ICU discharge and hospital death are assumed to have the same value for all covariates - including ABCDEF bundle compliance and performance - as the final ICU day. For example, if a patient was discharged to the floor on ICU day 4 and died on day 7, days 5, 6 and 7 would be assumed to have the same compliance and performance status as day 4.
1. Time to death is considered to be the maximum of recorded ICU length of stay; hospital length of stay; or the number of ICU days entered in the compliance form. As noted in above sections, sometimes these values conflict.

We will adjust for the same baseline and daily covariates in the model as for the in-ICU outcomes models (see [previous section](#covariates)).

## Patient Inclusion & Missing Data

We started with `r format(sum(!is.na(demog$icu_days) & demog$icu_days > 0), big.mark = ",")` patients enrolled in the Collaborative with >=1 full day in the ICU; among these, `r format(sum(demog$elig_death, na.rm = TRUE), big.mark = ",")` had complete baseline covariates and ICU length of stay data. Details on missingness for these variables among the eligible patients are below.

```{r death_missing_base}
gg_miss_var(
  subset(
    demog, !is.na(icu_days) & icu_days > 0
  )[, c(logmods_covars_base, "last_los_7", "hosp_death_7")],
  show_pct = TRUE)

```

```{r death_mods, results = "hide"}
death_results <- outcome_results_cph(dflist_tv = death_dflist)
death_hrplot <- tte_hr_results(
  death_results,
  outcome_info = tte_outcome_info(
    df = death_dflist[[1]], event_string = "deaths within 7 days"
  ),
  outcome_name = "death"
)

```

Among patients with >=1 ICU day and complete baseline and discharge status data, we still had to exclude `r format(sum(demog$elig_death, na.rm = TRUE) - length(unique(death_dflist[[1]]$id)), big.mark = ",")` patients who had no days of complete daily data.

Further details of missingness and rationale for handling would essentially repeat information included [above](#inicumissingness), as the situations are quite similar; please refer there for details.

## Model Results

After adjusting for potential confounders, both compliance with and performance of the ABCDEF Bundle on a given day are associated with a lower likelihood of death within 7 days; there is a dose-response relationship, such that more compliance and more performance are associated with lower likelihood of death.

It is important to note that because most Collaborative sites were only able to collect one week of data, these results only reflect deaths within the first 7 days after ICU admission. ABCDEF Bundle compliance and performance may have different associations with when longer hospitalizations are able to be more included in more detail.

### `r figure_nums("hrs_death")`

The top panels of `r figure_nums("hrs_death", display = "cite")` show the hazard ratio for death for patients with complete vs incomplete Bundle compliance or performance, after adjusting for all specified covariates. For example, assuming all other factors are equal and looking at compliance as purely yes/no, a patient with complete Bundle compliance has `r round(subset(death_results$hrs, variable == "comp_yn_f" & !is.ref)$effect * 100)`% the likelihood of death the following day, on average, than a patient with no or incomplete Bundle compliance.

The bottom panels show the hazard ratios for various "doses" of compliance or performance compared to none. For example, assuming all other factors are equal and looking at compliance as a dose, a patient with 60% Bundle compliance has `r round(subset(death_results$hrs, variable == "comp_prop" & comp == 0.6)$effect * 100)`% the likelihood of death the following day, on average, than a patient with no elements compliant.

```{r death_plot, fig.width = 3.5, fig.height = 3}
death_hrplot

```

# Discharge Location

## Analysis Method & Covariates

We will use a logistic regression model to assess the relationship between ABCDEF bundle compliance/performance during the Collaborative ICU stay and the likelihood of discharge to any type of facility, vs discharge home, among patients who survived their hospitalization and had at least one full day in the ICU.

We will adjust for the following baseline and summary covariates (please see
[Variable Calculation](#variables) for more details):

- Demographics
    - Age category
    - Sex
    - Race
    - Ethnicity (Hispanic vs non-Hispanic)
    - BMI
    - Residency prior to admission (home vs facility)
    - Mobility prior to admission (no restrictions vs any)
- Admission characteristics
    - Admission diagnosis category
    - Hospital type (community vs teaching)
    - ICU type
- Summary characteristics of Collaborative ICU stay
    - Total duration in days
    - Proportion of days on:
        - Benzos
        - Opioids
        - Propofol
        - Dex
        - Typical and/or atypical antipsychotics
        - Comfort care
        - MV
        - Coma
- Primary ABCDEF Bundle exposures during Collaborative ICU stay (assessed in separate models):
    - Proportion of *days* completely compliant
    - Proportion of *days* entire Bundle performed
    - Proportion of eligible *elements* compliant over the entire ICU stay
    - Proportion of eligible *elements* performed over the entire ICU stay
    
```{r dcloc_prep}
## Starting dataset: all patients who had >=1 ICU day recorded + survived
## hospitalization
df_dcloc <- demog %>%
  filter(icu_days > 0 &
           !is.na(dc_status_f) &
           dc_status_f == "Discharged from the hospital alive") %>%
  dplyr::select(
    id, hosp_f, one_of(logmods_covars_base), one_of(covars_summary),
    one_of(summary_exposures), home_posticu
  )

df_dcloc$include <- rep(FALSE, nrow(df_dcloc))
df_dcloc$include[complete.cases(df_dcloc)] <- TRUE

## Summarize missingness
miss_dcloc <- summary_exclusion(df_dcloc)

## Summarize missing data
miss_var_dcloc <- miss_var_summary(subset(df_dcloc, !include)) %>%
  filter(pct_miss > 0)

```

## Details of Missingness

`r miss_dcloc`

```{r dcloc_missing}
gg_miss_var(df_dcloc %>% dplyr::select(-id), show_pct = TRUE) +
  geom_hline(yintercept = 5, color = "grey50", linetype = "dotted") +
  labs(title = "Proportion of Eligible Patients with Missing Values,\nDischarge Location Exposures and Covariates",
       x = "")

```

`r table_nums("missing_dcloc", display = "cite")` describes the proportion of the
`r format(nrow(df_dcloc) - sum(!df_dcloc$include, na.rm = TRUE), big.mark = ",")` otherwise eligible patients excluded from the discharge location model due to incomplete data who were missing each covariate/outcome.

#### `r table_nums("missing_dcloc")`
```{r missing_dcloc, results = "asis"}
pander(as.data.frame(miss_var_dcloc), digits = 2, style = "rmarkdown")

```

## Summary of Model Results
```{r dcloc_mod, results = "hide"}
dd_dcloc <- datadist(df_dcloc)
options(datadist = "dd_dcloc")

dcloc_results <- outcome_results_lrm(
  outcome = "home_posticu",
  exposures = summary_exposures,
  covars = c(logmods_covars_base, covars_summary),
  df = df_dcloc %>% filter(include)
)

dcloc_outcome_info <- summary_outcome_info(
  outcome = "home_posticu",
  had_outcome_string = "discharged to a facility",
  df = df_dcloc %>% filter(include)
)

dcloc_orplot <- summary_or_results(
  outcome_results = dcloc_results,
  outcome_info = dcloc_outcome_info,
  outcome_name = "discharge to facility"
)

dcloc_probplot <- summary_prob_results(
  outcome_results = dcloc_results,
  outcome_info = dcloc_outcome_info,
  outcome_name = "discharge to facility",
  add_raw = TRUE,
  outcome = "home_posticu",
  df = df_dcloc %>% filter(include)
)

```

Whether we look at the proportion of days with *total* compliance/performance ("overall"), or the proportion of eligible *elements* compliant or performed ("dose"), throughout the Collaborative ICU stay, we see a mild dose-response relationship such that more compliance or performance is associated with lower likelihood of discharge to facility among patients who survived their hospitalization.

### `r figure_nums("ors_dcloc")`

The top panels of `r figure_nums("ors_dcloc", display = "cite")` show the odds ratio for discharge to a facility for hospital survivors with X% of ICU days meeting criteria for Bundle compliance or performance vs 0% of ICU days meeting criteria, after adjusting for all specified covariates. For example, assuming all other factors are equal and looking at daily compliance as yes/no, a patient with Bundle compliance on 50% of his or her ICU days has `r round(subset(dcloc_results$ors, variable == "comp_yn_prop" & comp == 0.5)$effect * 100)`% the odds of discharge to a facility, on average, than a patient with no or incomplete Bundle compliance.

The bottom panels show the odds ratios for X% of *elements* throughout the ICU stay meeting criteria for compliance or performance, compared to none. For example, assuming all other factors are equal, a patient with 60% of eligible Bundle compliant during the ICU stay has `r round(subset(dcloc_results$ors, variable == "comp_elem_prop" & comp == 0.6)$effect * 100)`% the odds of discharge to a facility, on average, than a patient with no elements compliant.

```{r print_dclocors, fig.width = 3.5, fig.height = 3}
dcloc_orplot

```

### `r figure_nums("probs_dcloc")`

For each daily "dose" of Bundle compliance or performance (elements meeting criteria / elements eligible), `r figure_nums("probs_dcloc", display = "cite")` shows the predicted probabilities of discharge to a facility (lines), after adjusting for all specified covariates; bands represent 95% confidence intervals. *(Predicted probabilities by overall bundle compliance/performance would be two single numbers, and thus are not plotted.)*

```{r print_dclocprobs, fig.width = 3.5, fig.height = 3}
dcloc_probplot

```

# Tipping Point Sensitivity Analysis

Due to the diversity of typical data collection across our 68 sites nationwide, we were unable to adjust for measures of severity of illness (SOI) (please see Table 1 for further details.) Though every observational study has the potential limitation of unmeasured confounding, in this case the inability to adjust for SOI poses a particular problem. A traditional sensitivity analysis could actually produce a biased result: the most common SOI score among our participating sites (APACHE III) was only collected at six institutions, and there is a strong chance that those six sites had additional unmeasured differences from the other sites (for example, nearly all these scores were from teaching hospitals, but over 1/3 of our cohort was from community hospitals).

For this reason, we believe that a “tipping point” analysis is better able to account for this limitation. This type of analysis allows us to quantify the amount of total unmeasured confounding which would be needed to render our analysis inconclusive (i.e., such that the confidence interval for an odds or hazard ratio would include 1). We have hypothetical relationships between the exposure, the outcome, and the unmeasured confounder. The tipping point analysis incorporates the relationship between the exposure and outcome observed in our original results; fixes the relationship between the unmeasured confounder and either the exposure or the outcome; and uses those quantities to estimate the size of the remaining relationship needed to render the original results inconclusive. This is in some ways a conservative analysis: It assumes that the unmeasured confounder is not associated with any of the covariates we included in our models, which was almost certainly not the case (we would expect SOI to be related to mechanical ventilation, for example).

In this case, we fix the relationship between SOI (unmeasured confounder) and ABCDEF Bundle performance (exposure), estimating that relationship using the 994 patients with APACHE III (our most common measure of SOI) available; this relationship is described in the Table as the “Difference in Means” (standardized, so that the scale of the variable has no effect on the results).

We then determine the odds or hazard ratio that would have to be observed between SOI and each outcome in order to render our results inconclusive. We present these results in the “Observed” column in the Table, as they are based on the relationships we observed in our data. We also used a more conservative estimate, in which we assumed the difference in SOI between exposed and unexposed groups was 25% larger than what we observed; we present this in the “Conservative” column.

For the convenience of the reader, we also present the original odds or hazard ratio for ABCDEF Bundle performance (yes/no) and each outcome (which is adjusted for 18 potential confounders determined a priori as listed in Methods, but is unadjusted for SOI).

```{r tipping}
## -- Function to get tipping points for a given outcome -----------------------
## Arguments:
## - Original model results (list inc list of models and a dataset of ORs/HRs;
##   eg, mv_results)
## - Outcome (string)
## - Data frame for original model
## - Amount to increase relationships between APACHE, performance by for
##   conservatism (defaults to 25%)
get_tippt <- function(
  results_list,
  outcome_string,
  model_df,
  cons_pct = 0.25
){
  ## Get original odds/hazard ratios and CI
  ratios_here <- str_subset(names(results_list), "ors|hrs")
  
  org_ratios <- pluck(results_list, ratios_here) %>%
    filter(variable == "perf_yn_f" & !is.ref)
  
  ## String of outcome + original results (will be on Y axis of eventual graph)
  org_results <- org_ratios %>%
    mutate(
      outcome = outcome_string,
      org_string = sprintf(
        "%s (%s, %s)", rndformat(effect), rndformat(lcl), rndformat(ucl)
      )
    ) %>%
    dplyr::select(outcome, org_string)
  
  ## -- Create dataset with *only* patients who had APACHE III -----------------
  apache_df <- inner_join(
    filter(demog, !is.na(apacheiii_score)) %>%
      dplyr::select(id, apacheiii_score),
    model_df,
    by = "id"
  )

  ## -- Calculate observed SMD for APACHE III in performed Y/N groups ----------
  ## Should be very similar for all outcomes, but datasets are slightly
  ## different depending on missingness, so may vary a bit
  apache_yes <- apache_df %>%
    filter(perf_yn_f == "Performed") %>%
    pull(apacheiii_score)
  
  apache_no <- apache_df %>%
    filter(perf_yn_f == "Not performed") %>%
    pull(apacheiii_score)
  
  ## Calculate observed diff between standardized means, exposed vs unexposed
  smd_obs <-
    (mean(apache_yes) / sqrt(var(apache_yes))) -
      (mean(apache_no) / sqrt(var(apache_no)))

  ## Observed difference between exposure & SOI
  tip_obs <- tipr::tip_with_continuous(
    mean_diff = smd_obs,
    lb = org_ratios %>% pull(lcl),
    ub = org_ratios %>% pull(ucl)
  )
  tip_cons <- tipr::tip_with_continuous(
    mean_diff = smd_obs * (1 + cons_pct),
    lb = org_ratios %>% pull(lcl),
    ub = org_ratios %>% pull(ucl)
  )
  
  ## -- Final data.frame with all results --------------------------------------
  bind_cols(
    org_results,
    data.frame(
      smd_obs = smd_obs,
      tip_obs = tip_obs,
      tip_cons = tip_cons
    )
  )%>%
    return()
  
}

## -- Set up list of arguments to cover all outcomes ---------------------------
tip_args <- list(
  results_list = list(
    mv_results, coma_results, del_results, res_results, death_results,
    iculos_results, hosplos_results
  ),
  outcome_string = c("MV", "Coma", "Delirium", "Physical Restraints", "Death",
                     "ICU Discharge", "Hospital Discharge"),
  model_df = list(
    df_logmod_mv, df_logmod_coma, df_logmod_del, df_logmod_res,
    death_dflist[[2]], iculos_dflist[[2]], hosplos_dflist[[2]]
  )
)

tipping_points <- pmap_df(
  .l = tip_args,
  .f = get_tippt
)

```

```{r print_tippt}
tipping_points %>%
  kable(format = "html",
        col.names = c(
          "Outcome", "Observed Results\n(Unadjusted for SOI)",
          "Difference in\nMeans (Standardized),\nBundle Performed vs Not",
          "Observed", "Conservative"
        ),
        align = c("l", rep("r", 4)),
        digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_header_above(
    c(" " = 3, "Ratio for APACHE III Needed to Tip" = 2)
  ) %>%
  group_rows(
    group_label = "Odds or Hazard Ratio < 1 = Beneficial",
    start_row = 1, end_row = 5
  ) %>%
  group_rows(
    group_label = "Odds or Hazard Ratio > 1 = Beneficial",
    start_row = 6, end_row = 7
  )

```

**EXAMPLE**: In our original analyses, we observed an odds ratio of 0.28 for Bundle performance and mechanical ventilation, with a limiting confidence bound of 0.36 (where the “limiting” bound is the bound closest to 1). Given this relationship and the observed relationship between APACHE III and Bundle performance, we would have to observe a relationship between APACHE III and mechanical ventilation represented by an odds ratio of 0.08 for every one-unit change in APACHE III in order to move our observed results to inconclusivity (i.e., where the CI includes 1). Using a more conservative approach, we would still need an odds ratio of 0.13 to move the limiting bound (the bound closest
to 1) of our observed results to 1. (This result is more conservative because
the effect needed to tip is closer to 1, which on the odds ratio scale indicates
*less* of an effect needed to tip.)

These are both extreme and unlikely values. Based on these results, we have more confidence that even if the true adjusted associations between Bundle performance and both mortality and all our in-ICU outcomes are smaller than observed after adjusting for SOI, they would still be meaningful.

In contrast, for the outcomes of ICU and hospital discharge, it would take a much smaller and potentially realistic relationship between SOI and each outcome to change our conclusions: For example, we would need a relationship of only 1.05 between SOI and Bundle performance to move our observed results to inconclusivity (much closer to 1). For this reason, the findings of our Tipping Point analysis led us to de-emphasize our significant findings for these two outcomes in this manuscript.

The following references are relevant; D'Agostino McGowan's work builds on that by Lin et al:

- D'Agostino McGowan, Lucy. March 23, 2018. *[Improving Modern Techniques of
Causal Inference: Finite Sample Performance of ATM and ATO Doubly Robust
Estimators, Variance Estimation for ATO Estimators, and Contextualized Tipping
Point Sensitivity Analyses for Unmeasured Confounding](https://etd.library.vanderbilt.edu//available/etd-03232018-135113/unrestricted/dagostino-mcgowan.pdf)* (Doctoral dissertation). Retrieved from
[Vanderbilt University Electronic Theses and Dissertations](https://etd.library.vanderbilt.edu//).
- Lin DY, Psaty BM, Kronmal BA. "[Assessing the Sensitivity of Regression
Results to Unmeasured Confounders in Observational Studies](https://www.ncbi.nlm.nih.gov/pubmed/9750244)." *Biometrics*, 1998 Sep;
54(3):948-63.

# Attempt at mixed effects model for MV

When running a mixed effects model including each site as a completely separate intercept, the model had issues converging, likely due to highly uneven cluster sizes (smallest site had 10 days/patients; largest has 1275 days/314 patients). Let's try combining all sites with <=100 patients and see if that helps.

```{r mixed_effects}
## -- Commented out to save time but preserve code for posterity ---------------
# ## What are the sites with <=100 patients?
# small_sites <- demog %>%
#   dplyr::select(id, hosp_f) %>%
#   group_by(hosp_f) %>%
#   summarise(npts = n()) %>%
#   ungroup() %>%
#   filter(npts <= 100) %>%
#   pull(hosp_f)
# 
# ## Add hospital to df_logmods
# df_logmods_mixed <- df_logmods %>%
#   left_join(demog %>% dplyr::select(id, hosp_f)) %>%
#   mutate(
#     hosp_comb = factor(
#       ifelse(hosp_f %in% small_sites, "Small sites", as.character(hosp_f))
#     )
#   )
# 
# mv_mixed <- lme4::glmer(
#   on_mv_icu_f_tmw ~ age_cat_mod + sex_f + race_cat_mod + hisp_cat_mod +
#     rcs(bmi, 3) + home_preadmit + mob_preadmit + primary_admit +
#     rcvd_benzo_icu + rcvd_opioid_icu + rcvd_propofol_icu + rcvd_dex_icu +
#     rcvd_antipsyc_icu + comfort_care_icu + on_mv_icu_f + coma_icu +
#     (1 | hosp_comb/id),
#   family = "binomial",
#   data = df_logmods_mixed
# )
# 
# ## This took 18 minutes and failed to converge! Fun!
# 
# ## How many patient-days per patient?
# days_pt <- df_logmods %>%
#   group_by(id) %>%
#   summarise(ndays = n())
# 
# ggplot(data = days_pt, aes(x = ndays)) + geom_histogram(binwidth = 1)

```

# Publication Figures

## Main Manuscript Figure, Draft 1: Proportion of Daily Bundle Performed vs In-ICU Outcomes

This figure shows all four in-ICU outcomes on the same scale, with raw data included. A placeholder version is inserted here; high-resolution, publication-ready figures are found [here](https://drive.google.com/open?id=1NTDq0aqOBvGOz_jUamnbh-YhVUiFaShc).

```{r fig_inicu_all, results = "hide"}
pub_color <- as.character(magglass_colors["f"])
point_color <- as.character(magglass_colors["f"])

## -- For each outcome, get predicted values for % performance -----------------
inicu_results <- list(
  "mv_results", "pain_results", "res_results", "coma_results", "del_results"
)

## Raw data to add to plots
inicu_outcomevars <- list(
  "on_mv_icu_f_tmw", "sigpain_icu_tmw", "on_restraints_icu_tmw",
  "coma_icu_tmw", "delirium_icu_tmw"
)

get_inicu_rawdata <- function(outvar){
  tmp <- df_logmods[,c("perf_prop", outvar)]
  names(tmp)[2] <- "had_outcome"
  tmp$outcome <- outvar
  tmp
}

inicu_rawdata <- map_df(inicu_outcomevars, get_inicu_rawdata) %>%
  mutate(
    had_outcome = as.numeric(had_outcome %in% c("Yes", "Received MV")),
    yhat = ifelse(had_outcome == 0, -0.075, 1.075),
    outcome = factor(
      case_when(
        outcome == "on_mv_icu_f_tmw"       ~ 1,
        outcome == "sigpain_icu_tmw"       ~ 2,
        outcome == "coma_icu_tmw"          ~ 3,
        outcome == "delirium_icu_tmw"      ~ 4,
        TRUE                               ~ 5
      ),
      levels = 1:5,
      labels = c("Mechanical Ventilation", "Significant Pain",
                 "Coma", "Delirium", "Physical Restraints")
    )
  ) %>%
  rename(prop_done = "perf_prop")

get_perf_probs <- function(results_name){
  tmp <- get(results_name)
  pluck(tmp, "probs") %>%
    filter(exposure == "perf_prop") %>%
    mutate(outcome = gsub("\\_.+$", "", results_name))
}

inicu_probs <- map_df(inicu_results, get_perf_probs) %>%
  mutate(
    outcome = factor(
      case_when(
        outcome == "mv"   ~ 1,
        outcome == "pain" ~ 2,
        outcome == "coma" ~ 3,
        outcome == "del"  ~ 4,
        TRUE              ~ 5
      ),
      levels = 1:5,
      labels = c("Mechanical Ventilation", "Significant Pain",
                 "Coma", "Delirium", "Physical Restraints")
    ),
    outcome_label = factor(
      case_when(
        outcome == "Mechanical Ventilation" ~ 1,
        outcome == "Significant Pain"       ~ 2,
        outcome == "Coma"                   ~ 3,
        outcome == "Delirium"               ~ 4,
        TRUE                                ~ 5
      ),
      levels = 1:5,
      labels = c("A: Mechanical Ventilation", "B: Significant Pain",
                 "C: Coma", "D: Delirium", "E: Physical Restraints")
    )
  )

inicu_plot_four <- ggplot(
  data = inicu_probs %>% filter(!(outcome == "Significant Pain")),
  aes(x = prop_done, y = yhat)
) +
  facet_wrap(~ outcome, nrow = 2) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = pub_color, alpha = 0.4) +
  geom_line(size = 1, colour = pub_color) +
  geom_point(
    aes(x = prop_done, y = yhat),
    colour = "gray35", shape = 1, alpha = 0.02, size = 0.25,
    position = position_jitter(height = 0.05, width = 0.025),
    data = inicu_rawdata %>% filter(!(outcome == "Significant Pain"))
  ) +
  scale_x_continuous(
    name = "Percent of Eligible ABCDEF Bundle Elements Performed",
    limits = 0:1,
    breaks = seq(0, 1, 0.2),
    labels = paste0(seq(0, 1, 0.2) * 100, "%")
  ) +
  scale_y_continuous(name = "Adjusted Probability of Outcome",
                     limits = c(-0.15, 1.15),
                     breaks = seq(0, 1, 0.2),
                     labels = paste0(seq(0, 1, 0.2) * 100, "%")) +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.x = element_text(vjust = 0),
        strip.text = element_text(face = "bold", size = 11),
        strip.background = element_rect(colour = "grey80", fill = "grey90"),
        panel.background = element_rect(colour = "grey80", fill = NA),
        plot.subtitle = element_text(size = 8, face = "italic"),
        plot.caption = element_text(size = 8, face = "italic"))

ggsave(
  filename = "inicu_plot_four.pdf",
  plot = inicu_plot_four,
  device = "pdf",
  path = "pubfigures/pdf",
  height = 4.5, width = 6
)

ggsave(
  filename = "inicu_plot_four.png",
  plot = inicu_plot_four,
  device = "png",
  path = "pubfigures/png",
  height = 4.5, width = 6, dpi = png_dpi
)

```

```{r print_fig_manuscript}
inicu_plot_four

```

**Suggested figure legend:** Each panel represents the relationship between the proportion of eligible ABCDEF bundle elements performed on a given day and the probability of a daily clinical outcome the following day. (For example, the upper lefthand panel represents the relationship between proportion of eligible elements performed on a given day and the probability that the patient would be on mechanical ventilation the following day.) Lines and confidence bands represent the probability of the outcome and the 95% confidence interval, adjusted for potential confounders measured at baseline, ICU admission, and daily in the ICU. Points represent raw, unadjusted data: the X value represents the proportion of elements performed on that day, and the Y value of 100% or 0% represents patients who did and did not have the outcome of interest, respectively.

## In-ICU Figure, Draft 2

After draft 1 was circulated, the decision was made to separate the MV figure from the other in-ICU outcomes and show coma, delirium, and physical restraints together. Because the Y axis no longer will go all the way to 100%, it doesn't make much sense to include raw data at, say, 20%, so it is removed. For ultimate flexibility, there is a horizontal and a vertical version provided, as well as
versions for each outcome individually. A placeholder version is inserted here; high-resolution, publication-ready figures are found [here](https://drive.google.com/open?id=1NTDq0aqOBvGOz_jUamnbh-YhVUiFaShc).

```{r fig_inicu_three}
inicu_plot_three <- ggplot(
  data = inicu_probs %>%
    filter(outcome %in% c("Coma", "Delirium", "Physical Restraints")),
  aes(x = prop_done, y = yhat)
) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = pub_color, alpha = 0.4) +
  geom_line(size = 1, colour = pub_color) +
  # geom_point(
  #   aes(x = prop_done, y = yhat),
  #   colour = "gray35", shape = 1, alpha = 0.02, size = 0.25,
  #   position = position_jitter(height = 0.05, width = 0.025),
  #   data = inicu_rawdata %>% filter(outcome != "Mechanical Ventilation")
  # ) +
  scale_x_continuous(
    name = "Percent of Eligible ABCDEF Bundle Elements Performed",
    limits = 0:1,
    breaks = seq(0, 1, 0.2),
    labels = paste0(seq(0, 1, 0.2) * 100, "%")
  ) +
  scale_y_continuous(name = "Adjusted Probability of Outcome",
                     # limits = c(-0.15, 1.15),
                     breaks = seq(0, 1, 0.05),
                     labels = paste0(seq(0, 1, 0.05) * 100, "%")) +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.x = element_text(vjust = 0),
        axis.text.x = element_text(size = 8),
        strip.text = element_text(face = "bold", size = 10, hjust = 0.1),
        strip.background = element_rect(colour = "grey80", fill = "grey90"),
        panel.spacing.x = unit(x = 0.15, "inches"),
        panel.background = element_rect(colour = "grey80", fill = NA),
        plot.subtitle = element_text(size = 8, face = "italic"),
        plot.caption = element_text(size = 8, face = "italic"))

inicu_plot_three_horiz <-
  inicu_plot_three + facet_wrap(~ outcome, nrow = 1)
inicu_plot_three_vert <-
  inicu_plot_three + facet_wrap(~ outcome, ncol = 1)

ggsave(
  filename = "inicu_plot_three_horiz.pdf",
  plot = inicu_plot_three_horiz,
  device = "pdf",
  path = "pubfigures/pdf",
  height = 3, width = 6.5
)

ggsave(
  filename = "inicu_plot_three_horiz.png",
  plot = inicu_plot_three_horiz,
  device = "png",
  path = "pubfigures/png",
  height = 3, width = 6.5, dpi = png_dpi
)

ggsave(
  filename = "inicu_plot_three_vert.pdf",
  plot = inicu_plot_three_vert,
  device = "pdf",
  path = "pubfigures/pdf",
  height = 6, width = 4.5
)

ggsave(
  filename = "inicu_plot_three_vert.png",
  plot = inicu_plot_three_vert,
  device = "png",
  path = "pubfigures/png",
  height = 6, width = 4.5, dpi = png_dpi
)

## Function to create plot for each individual outcome
inicu_singleplot <- function(out_full, out_title, ybreaks = 0.05){
  icuplot <- ggplot(
    data = subset(inicu_probs, outcome == out_full),
    aes(x = prop_done, y = yhat)
  ) +
  facet_wrap(~ outcome, nrow = 1) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = pub_color, alpha = 0.4) +
  geom_line(size = 1, colour = pub_color) +
  # geom_point(
  #   aes(x = prop_done, y = yhat),
  #   colour = "gray35", shape = 1, alpha = 0.02, size = 0.25,
  #   position = position_jitter(height = 0.05, width = 0.025),
  #   data = inicu_rawdata %>% filter(outcome != "Mechanical Ventilation")
  # ) +
  scale_x_continuous(
    name = "Percent of Eligible ABCDEF Bundle Elements Performed",
    limits = 0:1,
    breaks = seq(0, 1, 0.2),
    labels = paste0(seq(0, 1, 0.2) * 100, "%")
  ) +
  scale_y_continuous(name = "Adjusted Probability of Outcome",
                     # limits = c(-0.15, 1.15),
                     breaks = seq(0, 1, ybreaks),
                     labels = paste0(seq(0, 1, ybreaks) * 100, "%")) +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.x = element_text(vjust = 0),
        axis.text.x = element_text(size = 8),
        strip.text = element_text(face = "bold", size = 14),
        strip.background = element_rect(colour = "grey80", fill = "grey90"),
        panel.spacing.x = unit(x = 0.15, "inches"),
        panel.background = element_rect(colour = "grey80", fill = NA),
        plot.subtitle = element_text(size = 8, face = "italic"),
        plot.caption = element_text(size = 8, face = "italic"))
  
  ggsave(
    filename = sprintf("inicu_plot_%s.pdf", out_title),
    plot = icuplot,
    device = "pdf",
    path = "pubfigures/pdf",
    height = 5, width = 6
  )

  ggsave(
    filename = sprintf("inicu_plot_%s.png", out_title),
    plot = icuplot,
    device = "png",
    path = "pubfigures/png",
    height = 5, width = 6, dpi = png_dpi
  )

}

pwalk(
  list(
    "out_full" = as.character(unique(inicu_probs$outcome)),
    "out_title" = c("mv", "pain", "res", "coma", "del"),
    "ybreaks" = c(0.1, 0.05, 0.05, 0.05, 0.05)
  ),
  inicu_singleplot
)

```

```{r inicu_fig}
inicu_plot_three_horiz

```

## In-ICU Figure, Draft 3

After further edits, the decision was made to include all five in-ICU outcomes in the publication figure, using two rows with separate Y axis limits. A placeholder version is inserted here; high-resolution, publication-ready figures are found [here](https://drive.google.com/open?id=1NTDq0aqOBvGOz_jUamnbh-YhVUiFaShc).

```{r fig_inicu_five}
## Function to create individual plots with specified Y axes
## Need to create two faceted plots:
## 1. MV + pain; Y axes 0-100%
## 2. Coma + delirium + restraints; Y axes 0-20%

inicu_plots_combine <- function(outcomes, ylims, ybreaks){
  p <- ggplot(
    data = subset(inicu_probs, outcome %in% outcomes),
    aes(x = prop_done, y = yhat)
  ) +
    facet_wrap(~ outcome, nrow = 1) +
    geom_ribbon(
      aes(ymin = lower, ymax = upper), fill = pub_color, alpha = 0.4
    ) +
    geom_line(size = 1, colour = pub_color) +
    theme_minimal() +
    theme(legend.position = "none",
          axis.title.x = element_text(vjust = 0),
          axis.title.y = element_text(size = 9, vjust = 0.25),
          axis.text.x = element_text(size = 7),
          axis.text.y = element_text(size = 7),
          strip.text = element_text(face = "bold", size = 11),
          strip.background = element_rect(colour = "grey80", fill = "grey90"),
          panel.spacing = unit(x = 0.1, "inches"),
          panel.background = element_rect(colour = "grey80", fill = NA),
          plot.subtitle = element_text(size = 8, face = "italic"),
          plot.caption = element_text(size = 8, face = "italic"))
  
  ## Only want X, Y axis labels for coma/delirium/restraints (bottom row)
  if(length(outcomes) == 3){
    p <- p +
      scale_x_continuous(
        name = "Percent of Eligible ABCDEF Bundle Elements Performed",
        limits = 0:1,
        breaks = seq(0, 1, 0.2),
        labels = paste0(seq(0, 1, 0.2) * 100, "%")
      ) +
      scale_y_continuous(name = "Adjusted Probability",
                         limits = ylims,
                         breaks = seq(0, 1, ybreaks),
                         labels = paste0("  ", seq(0, 1, ybreaks) * 100, "%"))
  } else{
    p <- p +
      scale_x_continuous(#name = " ",
                           ## using element_blank() made top larger than bottom
                         limits = 0:1,
                         breaks = seq(0, 1, 0.2),
                         labels = paste0(seq(0, 1, 0.2) * 100, "%")) +
      scale_y_continuous(name = "Adjusted Probability",
                         limits = ylims,
                         breaks = seq(0, 1, ybreaks),
                         labels = paste0(seq(0, 1, ybreaks) * 100, "%")) +
      theme(axis.title.x = element_blank())
  }

  return(p)
}

mvpain_plot <- inicu_plots_combine(
  outcomes = c("Mechanical Ventilation", "Significant Pain"),
  ylims = 0:1, ybreaks = 0.2
)
comadelres_plot <- inicu_plots_combine(
  outcomes = c("Coma", "Delirium", "Physical Restraints"),
  ylims = c(0, 0.21), ybreaks = 0.05
)

## Combine plots into one big multiplot, save
ggsave(
  filename = "inicu_fivepanel.pdf",
  plot = multiplot(
    plotlist = list(mvpain_plot, comadelres_plot),
    layout = matrix(c(rep(1, 7), rep(2, 8)), ncol = 1)
  ),
  device = "pdf",
  path = "pubfigures/pdf",
  height = 4, width = 6.5
)

ggsave(
  filename = "inicu_fivepanel.png",
  plot = multiplot(
    plotlist = list(mvpain_plot, comadelres_plot),
    layout = matrix(c(rep(1, 7), rep(2, 8)), ncol = 1)
  ),
  device = "png",
  path = "pubfigures/png",
  height = 4, width = 6.5, dpi = png_dpi
)

```

```{r inicu_five_fig}
multiplot(
  plotlist = list(mvpain_plot, comadelres_plot),
  layout = matrix(c(rep(1, 7), rep(2, 8)), ncol = 1)
)

```

## Time to Event Figure: Hazard Ratios for Performance vs TTE Outcomes

The following figures show all three time-to-event outcomes, summarized using hazard ratios for various comparisons of % of elements performed vs none. A placeholder version is inserted here; high-resolution, publication-ready figures are found [here](https://drive.google.com/open?id=1NTDq0aqOBvGOz_jUamnbh-YhVUiFaShc).

```{r fig_tte}
## -- For each outcome, get HRs for % performance ------------------------------
tte_results <- list("iculos_results", "hosplos_results", "death_results")

get_perf_hrs <- function(results_name){
  tmp <- get(results_name)
  pluck(tmp, "hrs") %>%
    filter(variable == "perf_prop") %>%
    mutate(outcome = gsub("\\_.+$", "", results_name))
}

tte_hrs <- map_df(tte_results, get_perf_hrs) %>%
  mutate(
    outcome = factor(
      case_when(
        outcome == "iculos"  ~ 1,
        outcome == "hosplos" ~ 2,
        TRUE                 ~ 3
      ),
      levels = 1:3,
      labels = c("ICU Discharge", "Hospital Discharge", "Death")
    ),
    outcome_label = factor(
      case_when(
        outcome == "ICU Discharge"      ~ 1,
        outcome == "Hospital Discharge" ~ 2,
        TRUE                            ~ 3
      ),
      levels = 1:3,
      labels = c("A: ICU Discharge", "B: Hospital Discharge", "C: Death")
    )
  ) %>%
  ## Don't want to print reference levels
  filter(!is.ref) %>%
  ## Add Y values
  group_by(outcome) %>%
  mutate(
    yval = 1:n(),
    ylabel = sprintf("%s%% vs %s%%", round(comp * 100), round(ref * 100)),
    ylabel = fct_reorder(ylabel, yval)
  ) %>%
  ungroup()

## Dataset to add text indicating direction of favorable outcomes on each facet
tte_favorable <- tibble(
  outcome = unique(tte_hrs$outcome),
  outcome_label = unique(tte_hrs$outcome_label),
  xval = c(2.05, 2.05, 0),
  xjust = c(1.1, 1.1, -0.1),
  tte_text = c(">1 is favorable", ">1 is favorable", "<1 is favorable")
)

## Combined versions
tte_plot_three <- ggplot(data = tte_hrs, aes(x = ylabel, y = effect)) +
  ## Reference line
  geom_hline(yintercept = 1, colour = "grey70", linetype = "solid", size = 1) +
  ## HRs, CIs
  geom_pointrange(aes(ymin = lcl, ymax = ucl), colour = pub_color) +
  ## Text indicating which direction is favorable
  geom_text(
    aes(x = min(tte_hrs$yval, na.rm = TRUE),
        y = xval, label = tte_text, hjust = xjust),
    data = tte_favorable,
    nudge_x = -0.35, fontface = "italic", size = 2.5, color = pub_color
  ) +
  coord_flip() +
  theme_minimal() +
  theme(strip.text = element_text(hjust = 0.05, face = "bold"),
        strip.background = element_rect(colour = "grey80", fill = "grey90"),
        axis.title.x = element_text(vjust = 0),
        axis.text.y = element_text(face = "bold"),
        panel.background = element_rect(colour = "grey80", fill = NA),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank(),
        plot.subtitle = element_text(size = 8, face = "italic"),
        plot.caption = element_text(size = 8, face = "italic"))

## Horizontal, vertical versions
tte_plot_three_horiz <- tte_plot_three + facet_wrap(~ outcome, nrow = 1)
tte_plot_three_vert <- tte_plot_three + facet_wrap(~ outcome, ncol = 1)

ggsave(
  filename = "tte_plot_three_horiz.pdf",
  plot = tte_plot_three_horiz +
    scale_x_discrete(name = "Proportion of ABCDEF Bundle\nElements Performed") +
    scale_y_continuous(name = "Adjusted Hazard Ratio (95% Confidence Interval)",
                       limits = c(0, 2.05),
                       breaks = seq(0, 10, 0.5)) +
    theme(axis.text.x = element_text(size = 7)),
  device = "pdf",
  path = "pubfigures/pdf",
  height = 3, width = 6.5
)

ggsave(
  filename = "tte_plot_three_horiz.png",
  plot = tte_plot_three_horiz +
    scale_x_discrete(name = "Proportion of ABCDEF Bundle\nElements Performed") +
    scale_y_continuous(name = "Adjusted Hazard Ratio (95% Confidence Interval)",
                       limits = c(0, 2.05),
                       breaks = seq(0, 10, 0.5)) +
    theme(axis.text.x = element_text(size = 7)),
  device = "png",
  path = "pubfigures/png",
  height = 3, width = 6.5, dpi = png_dpi
)

ggsave(
  filename = "tte_plot_three_vert.pdf",
  plot = tte_plot_three_vert +
    scale_x_discrete(name = "Proportion of ABCDEF Bundle Elements Performed") +
    scale_y_continuous(name = "Adjusted Hazard Ratio (95% Confidence Interval)",
                       limits = c(0, 2.05),
                       breaks = seq(0, 10, 0.2)) +
    theme(axis.text.x = element_text(size = 7)),
  device = "pdf",
  path = "pubfigures/pdf",
  height = 6, width = 4.5
)

ggsave(
  filename = "tte_plot_three_vert.png",
  plot = tte_plot_three_vert +
    scale_x_discrete(name = "Proportion of ABCDEF Bundle Elements Performed") +
    scale_y_continuous(name = "Adjusted Hazard Ratio (95% Confidence Interval)",
                       limits = c(0, 2.05),
                       breaks = seq(0, 10, 0.2)) +
    theme(axis.text.x = element_text(size = 7)),
  device = "png",
  path = "pubfigures/png",
  height = 6, width = 4.5, dpi = png_dpi
)

## Create separate figures for each
tte_singleplot <- function(out_full, out_title, xbreaks){
  df <- tte_hrs %>% filter(outcome == out_full)
  favorable_xval <- ifelse(out_full %in% "Death",
                           floor(min(df$lcl) / 0.1) * 0.1, 
                           ceiling(max(df$ucl) / 0.1) * 0.1)
  
  tteplot <- ggplot(data = df, aes(x = ylabel, y = effect)) +
    facet_wrap(~ outcome, nrow = 1) +
    geom_hline(
      yintercept = 1, colour = "grey70", linetype = "solid", size = 1.1
    ) +
    geom_pointrange(aes(ymin = lcl, ymax = ucl), colour = pub_color, size = 1) +
    geom_text(
      aes(x = min(tte_hrs$yval, na.rm = TRUE),
          y = favorable_xval,
          label = tte_text, hjust = xjust),
      data = tte_favorable %>% filter(outcome == out_full),
      nudge_x = -0.35,
      fontface = "italic", size = 4, color = pub_color
    ) +
    scale_x_discrete(name = "Proportion of ABCDEF Bundle Elements Performed") +
    scale_y_continuous(name = "Adjusted Hazard Ratio (95% Confidence Interval)",
                       limits = c(floor(min(df$lcl) / 0.1) * 0.1,
                                  ceiling(max(df$ucl) / 0.1) * 0.1),
                       breaks = seq(0, 10, xbreaks)) +
    coord_flip() +
    theme_minimal() +
    theme(strip.text = element_text(face = "bold", size = 14),
          strip.background = element_rect(colour = "grey80", fill = "grey90"),
          axis.title.x = element_text(vjust = 0),
          axis.text.y = element_text(face = "bold"),
          panel.background = element_rect(colour = "grey80", fill = NA),
          panel.grid.major.y = element_blank(),
          panel.grid.minor = element_blank(),
          plot.subtitle = element_text(size = 8, face = "italic"),
          plot.caption = element_text(size = 8, face = "italic"))
  
  ggsave(
    filename = sprintf("tte_plot_%s.pdf", out_title),
    plot = tteplot,
    device = "pdf",
    path = "pubfigures/pdf",
    height = 5, width = 6
  )

  ggsave(
    filename = sprintf("tte_plot_%s.png", out_title),
    plot = tteplot,
    device = "png",
    path = "pubfigures/png",
    height = 5, width = 6, dpi = png_dpi
  )

}

pwalk(
  list(
    "out_full" = as.character(unique(tte_hrs$outcome)),
    "out_title" = c("icudc", "hospdc", "death"),
    "xbreaks" = c(0.2, 0.2, 0.2)
  ),
  tte_singleplot
)

```

```{r tte_fig}
tte_plot_three_horiz

```

**Suggested figure legend:** Each panel shows the hazard ratios and 95% confidence intervals for the specified outcome, comparing patients with a given proportion of eligible ABCDEF Bundle elements performed on a given day to patients with none of the Bundle performed that day. The gray line at 1.0 indicates no association. Hazard ratios are adjusted for baseline and ICU admission characteristics as well as daily covariates, measured the same day as Bundle performance. For example, on a given day and holding all else equal, a patient who had 60% of the ABCDEF Bundle elements for which s/he was eligible has, on average, about 1.4 times the likelihood of being discharged from the ICU as a patient with none of the Bundle elements performed.

## ICU Summary Outcomes Figures (ICU Readmission, Discharge to Facility)

```{r fig_icusummary, results = "hide"}
## -- For each outcome, get predicted values for % elements performed ----------
icusummary_results <- list("icureadm_results", "dcloc_results")

get_perfelem_probs <- function(results_name){
  tmp <- get(results_name)
  pluck(tmp, "probs") %>%
    filter(exposure == "perf_elem_prop") %>%
    mutate(outcome = gsub("\\_.+$", "", results_name))
}

icusummary_probs <- map_df(icusummary_results, get_perfelem_probs) %>%
  mutate(
    outcome = factor(
      case_when(
        outcome == "icureadm" ~ 1,
        TRUE                  ~ 2
      ),
      levels = 1:2,
      labels = c("ICU Readmission", "Discharge to Facility")
    ),
    outcome_label = factor(
      case_when(
        outcome == "ICU Readmission" ~ 1,
        TRUE                         ~ 2
      ),
      levels = 1:2,
      labels = c("A: ICU Readmission", "B: Discharge to Facility")
    )
  )

icusummary_plot_all <- ggplot(
  data = icusummary_probs, aes(x = prop_done, y = yhat)
) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = pub_color, alpha = 0.4) +
  geom_line(size = 1, colour = pub_color) +
  scale_y_continuous(name = "Adjusted Probability of Outcome",
                     # limits = c(-0.15, 1.15),
                     breaks = seq(0, 1, 0.1),
                     labels = paste0(seq(0, 1, 0.1) * 100, "%")) +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.x = element_text(vjust = 0),
        strip.text = element_text(face = "bold", size = 11, hjust = 0.1),
        strip.background = element_rect(colour = "grey80", fill = "grey90"),
        panel.background = element_rect(colour = "grey80", fill = NA),
        plot.subtitle = element_text(size = 8, face = "italic"),
        plot.caption = element_text(size = 8, face = "italic"))

ggsave(
  filename = "icusummary_plot_all_horiz.pdf",
  plot = icusummary_plot_all +
    facet_wrap(~ outcome, scales = "free_y", nrow = 1) +
    scale_x_continuous(
      name = "Percent of Eligible ABCDEF Bundle Elements Performed",
      limits = 0:1,
      breaks = seq(0, 1, 0.2),
      labels = paste0(seq(0, 1, 0.2) * 100, "%")
    ),
  device = "pdf",
  path = "pubfigures/pdf",
  height = 3.5, width = 6
)

ggsave(
  filename = "icusummary_plot_all_horiz.png",
  plot = icusummary_plot_all +
    facet_wrap(~ outcome, scales = "free_y", nrow = 1) +
    scale_x_continuous(
      name = "Percent of Eligible ABCDEF Bundle Elements Performed",
      limits = 0:1,
      breaks = seq(0, 1, 0.2),
      labels = paste0(seq(0, 1, 0.2) * 100, "%")
    ),
  device = "png",
  path = "pubfigures/png",
  height = 3.5, width = 6, dpi = png_dpi
)

ggsave(
  filename = "icusummary_plot_all_vert.pdf",
  plot = icusummary_plot_all +
    facet_wrap(~ outcome, scales = "free_y", ncol = 1) +
    scale_x_continuous(
      name = "Percent of Eligible ABCDEF Bundle\nElements Performed",
      limits = 0:1,
      breaks = seq(0, 1, 0.2),
      labels = paste0(seq(0, 1, 0.2) * 100, "%")
    ),
  device = "pdf",
  path = "pubfigures/pdf",
  height = 6, width = 4
)

ggsave(
  filename = "icusummary_plot_all_vert.png",
  plot = icusummary_plot_all +
    facet_wrap(~ outcome, scales = "free_y", ncol = 1) +
    scale_x_continuous(
      name = "Percent of Eligible ABCDEF Bundle\nElements Performed",
      limits = 0:1,
      breaks = seq(0, 1, 0.2),
      labels = paste0(seq(0, 1, 0.2) * 100, "%")
    ),
  device = "png",
  path = "pubfigures/png",
  height = 6, width = 4, dpi = png_dpi
)

## Function to create plot for each individual outcome
icusummary_singleplot <- function(out_full, out_title, ybreaks = 0.05){
  icuplot <- ggplot(
    data = subset(icusummary_probs, outcome == out_full),
    aes(x = prop_done, y = yhat)
  ) +
  facet_wrap(~ outcome, nrow = 1) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = pub_color, alpha = 0.4) +
  geom_line(size = 1, colour = pub_color) +
  scale_x_continuous(
    name = "Percent of Eligible ABCDEF Bundle Elements Performed",
    limits = 0:1,
    breaks = seq(0, 1, 0.2),
    labels = paste0(seq(0, 1, 0.2) * 100, "%")
  ) +
  scale_y_continuous(name = "Adjusted Probability of Outcome",
                     breaks = seq(0, 1, ybreaks),
                     labels = paste0(seq(0, 1, ybreaks) * 100, "%")) +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.x = element_text(vjust = 0),
        axis.text.x = element_text(size = 8),
        strip.text = element_text(face = "bold", size = 14),
        strip.background = element_rect(colour = "grey80", fill = "grey90"),
        panel.spacing.x = unit(x = 0.15, "inches"),
        panel.background = element_rect(colour = "grey80", fill = NA),
        plot.subtitle = element_text(size = 8, face = "italic"),
        plot.caption = element_text(size = 8, face = "italic"))
  
  ggsave(
    filename = sprintf("icusummary_plot_%s.pdf", out_title),
    plot = icuplot,
    device = "pdf",
    path = "pubfigures/pdf",
    height = 5, width = 6
  )

  ggsave(
    filename = sprintf("icusummary_plot_%s.png", out_title),
    plot = icuplot,
    device = "png",
    path = "pubfigures/png",
    height = 5, width = 6, dpi = png_dpi
  )

}

pwalk(
  list(
    "out_full" = as.character(unique(icusummary_probs$outcome)),
    "out_title" = c("icureadm", "dcloc"),
    "ybreaks" = c(0.05, 0.1)
  ),
  icusummary_singleplot
)

```

```{r icusummary_fig}
icusummary_plot_all +
  facet_wrap(~ outcome, scales = "free_y", nrow = 1)

```

**Suggested figure legend:** Panels A and B show the adjusted probabilities of ICU readmission and discharge to a facility vs home, respectively, among ICU survivors, according to what proportion of ABCDEF Bundle elements performed of those the patient was eligible to receive during the first seven days of his/her Collaborative ICU stay. Probabilities are adjusted for baseline, ICU admission, and summary ICU characteristics *(eg, total proportion of ICU days the patient received benzodiazepines)*.

For example, if the patient was in the ICU for five days, was on MV and sedation every day, and had a family member or other caregiver present each day, s/he would be eligible to receive 5 * 7 = 35 elements. If all elements except pain and delirium assessments were performed on all 5 days, the patient received 25 / 35 = 71% of the Bundle elements.
